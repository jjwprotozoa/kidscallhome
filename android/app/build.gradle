apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'

apply from: '../capacitor-cordova-android-plugins/cordova.variables.gradle'
apply from: 'capacitor.build.gradle'

// Load keystore properties if file exists
def keystorePropertiesFile = rootProject.file("keystore.properties")
def keystoreProperties = new Properties()
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    namespace "com.kidscallhome.app"
    compileSdk 35
    
    defaultConfig {
        applicationId "com.kidscallhome.app"
        minSdk 22
        targetSdk 35
        versionCode 2
        versionName "1.0.1"
    }
    
    signingConfigs {
        release {
            // Use Codemagic environment variables when building in CI (recommended)
            // See: https://docs.codemagic.io/yaml-code-signing/signing-android/
            if (System.getenv()["CI"]) { // CI=true is exported by Codemagic
                storeFile file(System.getenv()["CM_KEYSTORE_PATH"] ?: "")
                storePassword System.getenv()["CM_KEYSTORE_PASSWORD"] ?: ""
                keyAlias System.getenv()["CM_KEY_ALIAS"] ?: ""
                keyPassword System.getenv()["CM_KEY_PASSWORD"] ?: ""
            }
            // Fallback: Use keystore.properties file for local builds or repository keystore
            else if (keystorePropertiesFile.exists()) {
                keyAlias keystoreProperties['keyAlias']
                keyPassword keystoreProperties['keyPassword']
                storeFile file("${rootProject.projectDir}/${keystoreProperties['storeFile']}")
                storePassword keystoreProperties['storePassword']
            }
        }
    }
    
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            // Sign release builds if keystore is configured (either via CI env vars or properties file)
            if (System.getenv()["CI"] && System.getenv()["CM_KEYSTORE_PATH"]) {
                signingConfig signingConfigs.release
            } else if (keystorePropertiesFile.exists()) {
                signingConfig signingConfigs.release
            }
        }
    }
    
    packaging {
        resources {
            // Exclude JVM-only coroutines debug classes that cause desugaring issues
            excludes += [
                'META-INF/versions/9/org/jetbrains/kotlinx/coroutines/debug/**',
                'kotlinx/coroutines/debug/**'
            ]
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = '17'
    }
}

configurations.all {
    // Exclude JVM-only coroutines artifacts that cause desugaring issues on Android
    exclude group: 'org.jetbrains.kotlinx', module: 'kotlinx-coroutines-core-jvm'
}

dependencies {
    implementation fileTree(dir: "libs", include: ["*.jar"])
    implementation project(':capacitor-android')
    implementation project(':capacitor-app')
    implementation project(':capacitor-device')
    implementation project(':capacitor-haptics')
    implementation project(':capacitor-keyboard')
    implementation project(':capacitor-local-notifications')
    implementation project(':capacitor-push-notifications')
    implementation project(':capacitor-splash-screen')
    implementation project(':capacitor-status-bar')
}



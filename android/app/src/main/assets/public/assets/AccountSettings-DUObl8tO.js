import{u as B,r as a,j as e,L as x,aI as H,az as K,a1 as z,X as J,t as V,aJ as W}from"./vendor-react-LQlp3yIU.js";import{N as D}from"./Navigation-oN70GkMP.js";import{O as X,H as $}from"./OnboardingTour-DCxLRID0.js";import{u as G,s as l,C as h,B as f,A as Q,g as Z,h as ee,i as te,j as se,k as ae,l as re,m as ie}from"./index-4JrybDns.js";import{i as F}from"./platformDetection-DMTH-XIz.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-DUaz7rji.js";import"./deviceTracking-lBUE_lfK.js";import"./vendor-capacitor-DSxgEnoB.js";import"./vendor-supabase-Bq0a3XdW.js";const fe=()=>{const b=B(),{toast:n}=G(),[L,d]=a.useState(!0),[P,g]=a.useState(null),[U,j]=a.useState(null),[N,w]=a.useState(null),[o,v]=a.useState("free"),[r,M]=a.useState("active"),[c,T]=a.useState(null),[y,S]=a.useState(1),[u,Y]=a.useState(0),[I,m]=a.useState(!1),[p,C]=a.useState(!1),[A,_]=a.useState(!1);a.useEffect(()=>{R(),E()},[]);const R=async()=>{const{data:{session:t}}=await l.auth.getSession();if(!t){b("/parent/auth");return}},E=async()=>{try{const{data:{user:t}}=await l.auth.getUser();if(!t)return;const{data:s,error:i}=await l.from("parents").select("name, email, family_code, subscription_type, subscription_status, subscription_expires_at, allowed_children").eq("id",t.id).single();if(i){if(i.code==="42703"||i.message?.includes("does not exist")){console.warn("Subscription columns don't exist yet. Migration not run:",i),s&&(g(s?.name||null),j(s?.email||null),w(s?.family_code||null)),v("free"),S(1),d(!1);return}console.error("Error loading account info:",i),n({title:"Error",description:"Failed to load account information",variant:"destructive"}),d(!1);return}g(s?.name||null),j(s?.email||null),w(s?.family_code||null),v(s?.subscription_type||"free"),M(s?.subscription_status||"active"),T(s?.subscription_expires_at||null),S(s?.allowed_children||1);const{data:k}=await l.from("children").select("id",{count:"exact"}).eq("parent_id",t.id);k&&Y(k.length||0)}catch(t){console.error("Error loading account info:",t),n({title:"Error",description:"Failed to load account information",variant:"destructive"})}finally{d(!1)}},O=async()=>{if(!F()){n({title:"Not Available",description:"Subscription management is only available in the web app.",variant:"default"});return}_(!0);try{const{data:t,error:s}=await l.functions.invoke("create-customer-portal-session",{body:{returnUrl:`${window.location.origin}/parent/settings`}});if(s)throw s;if(t?.success&&t?.url)window.location.href=t.url;else throw new Error(t?.error||"Failed to create portal session")}catch(t){console.error("Error opening subscription management:",t),n({title:"Error",description:t.message||"Failed to open subscription management. Please try again.",variant:"destructive"})}finally{_(!1)}},q=async()=>{C(!0);try{const{data:{user:t}}=await l.auth.getUser();if(!t){n({title:"Error",description:"Not authenticated",variant:"destructive"});return}const{data:s,error:i}=await l.rpc("cancel_subscription",{p_parent_id:t.id,p_cancel_reason:"User requested cancellation"});if(i)throw i;if(s?.success)n({title:"Subscription Cancelled",description:s.message||"Your subscription has been cancelled. Access will continue until expiration."}),m(!1),await E();else throw new Error(s?.error||"Failed to cancel subscription")}catch(t){console.error("Error cancelling subscription:",t),n({title:"Cancellation Failed",description:t.message||"Failed to cancel subscription. Please contact support.",variant:"destructive"})}finally{C(!1)}};return L?e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(D,{}),e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(x,{className:"h-8 w-8 animate-spin text-muted-foreground"})})]}):e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(D,{}),e.jsx(X,{role:"parent",pageKey:"parent_settings"}),e.jsx($,{role:"parent",pageKey:"parent_settings"}),e.jsx("div",{className:"px-4 pb-4",style:{paddingTop:"calc(0.5rem + 64px + var(--safe-area-inset-top) * 0.15)"},children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mt-4 mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(H,{className:"h-6 w-6"}),e.jsx("h1",{className:"text-3xl font-bold",children:"Account Settings"})]}),e.jsx("p",{className:"text-muted-foreground",children:"Manage your account and subscription"})]}),e.jsxs(h,{className:"p-6 mb-6","data-tour":"parent-settings-account",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Account Information"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Name"}),e.jsx("p",{className:"text-base font-medium",children:P||"Not set"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Email"}),e.jsx("p",{className:"text-base font-medium",children:U||"Not set"})]}),N&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Family Code"}),e.jsx("p",{className:"text-base font-mono font-bold",children:N})]})]})]}),e.jsxs(h,{className:"p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Subscription"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Current Plan"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-base font-medium capitalize",children:o==="free"?"Free":o}),o!=="free"&&r==="active"&&e.jsx(K,{className:"h-4 w-4 text-primary"}),r==="cancelled"&&e.jsx("span",{className:"text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded",children:"Cancelled"}),r==="expired"&&e.jsx("span",{className:"text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-1 rounded",children:"Expired"})]}),r==="cancelled"&&c&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Access until: ",new Date(c).toLocaleDateString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Children Limit"}),e.jsxs("p",{className:"text-base font-medium",children:[u," /"," ",y===999?"âˆž Unlimited":y]})]}),o!=="free"&&r==="active"&&e.jsxs("div",{className:"pt-2 border-t space-y-2",children:[F()&&e.jsx(f,{variant:"default",onClick:O,disabled:A,className:"w-full",children:A?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"mr-2 h-4 w-4 animate-spin"}),"Opening..."]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Manage Subscription"]})}),e.jsxs(f,{variant:"outline",onClick:()=>m(!0),className:"w-full",children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Cancel Subscription"]})]})]})]}),(o==="free"||r==="expired"||r==="cancelled")&&e.jsx(h,{className:"p-6 bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20",children:e.jsx("div",{className:"flex items-start gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(V,{className:"h-5 w-5 text-primary"}),e.jsx("h2",{className:"text-xl font-semibold",children:r==="cancelled"?"Resubscribe":"Upgrade Your Plan"})]}),e.jsx("p",{className:"text-muted-foreground mb-4",children:r==="cancelled"?"Your subscription is cancelled but you still have access. Resubscribe to continue after expiration.":"Unlock more features and add more children to your account. Choose from flexible monthly or annual plans."}),e.jsxs(f,{onClick:()=>b("/parent/upgrade"),className:"w-full sm:w-auto","data-tour":"parent-settings-upgrade",children:[r==="cancelled"?"Resubscribe":"View Plans",e.jsx(W,{className:"ml-2 h-4 w-4"})]})]})})})]})}),e.jsx(Q,{open:I,onOpenChange:m,children:e.jsxs(Z,{children:[e.jsxs(ee,{children:[e.jsx(te,{children:"Cancel Subscription"}),e.jsxs(se,{children:["Are you sure you want to cancel your subscription? You'll continue to have access until"," ",c?new Date(c).toLocaleDateString():"the end of your billing period",". After that, your account will revert to the free tier (1 child limit).",u>1&&e.jsxs("span",{className:"block mt-2 font-semibold text-yellow-600 dark:text-yellow-400",children:["Note: You currently have ",u," children. After expiration, you won't be able to add more children, but existing children can still use the app."]})]})]}),e.jsxs(ae,{children:[e.jsx(re,{disabled:p,children:"Keep Subscription"}),e.jsx(ie,{onClick:q,disabled:p,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:p?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"mr-2 h-4 w-4 animate-spin"}),"Cancelling..."]}):"Yes, Cancel Subscription"})]})]})})]})};export{fe as default};

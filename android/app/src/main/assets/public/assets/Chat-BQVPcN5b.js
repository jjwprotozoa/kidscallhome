import{a6 as z,r as m,u as L,j as c,aT as G,aU as F}from"./vendor-react-mDIoga_b.js";import{u as J,s as f,o as v,a,d as g,B as H,C as V,b as K}from"./index-BdmHsoQZ.js";import{I as Q}from"./input-UTyCM2Df.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-BA4qpukX.js";import"./vendor-capacitor-DSxgEnoB.js";import"./vendor-supabase-DQP4RkUL.js";const se=()=>{const{childId:l}=z(),[I,w]=m.useState([]),[E,N]=m.useState(""),[d,C]=m.useState(!1),[h,y]=m.useState(null),[b,R]=m.useState(null),[T,j]=m.useState(!1),[q,D]=m.useState("Mom/Dad"),M=m.useRef(null),x=m.useRef(null),_=L(),{toast:k}=J();m.useEffect(()=>((async()=>{let t=null,i=!1;const u=localStorage.getItem("childSession");let r=null;if(u)try{r=JSON.parse(u),l&&l===r.id&&(i=!0,C(!0),y(r),t=r.id,A(r.id),f.from("children").select("parent_id").eq("id",r.id).single().then(({data:s,error:e})=>{if(e||!s){a.error("Error fetching child record:",g(e));return}return f.from("parents").select("id, name").eq("id",s.parent_id).maybeSingle()}).then(s=>{s?.data?(D(s.data.name),R({name:s.data.name,id:s.data.id})):s?.error&&a.error("Error fetching parent data:",g(s.error))}).catch(s=>{a.error("Error fetching parent data:",g(s))}))}catch(s){a.error("Error parsing childSession:",g(s))}if(!i)try{const{data:{session:s}}=await f.auth.getSession();if(s?.user)if(i=!1,C(!1),l)t=l,A(l),U(l);else{_("/parent/children");return}else if(r)i=!0,C(!0),y(r),t=r.id,A(r.id),f.from("children").select("parent_id").eq("id",r.id).single().then(({data:e,error:n})=>{if(n||!e){a.error("Error fetching child record:",g(n));return}return f.from("parents").select("id, name").eq("id",e.parent_id).maybeSingle()}).then(e=>{e?.data?(D(e.data.name),R({name:e.data.name,id:e.data.id})):e?.error&&a.error("Error fetching parent data:",g(e.error))}).catch(e=>{a.error("Error fetching parent data:",g(e))});else if(l){_("/");return}else{_("/");return}}catch(s){a.error("Error checking auth session:",g(s)),_("/");return}if(t){a.log("ðŸ“¡ [CHAT] Setting up realtime subscription for messages",{childId:t,isChild:i,timestamp:new Date().toISOString()});const s=`messages-${t}`;x.current=f.channel(s).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`child_id=eq.${t}`},e=>{a.log("ðŸ“¨ [CHAT] Received new message via realtime:",{messageId:e.new.id,senderType:e.new.sender_type,childId:e.new.child_id,filterChildId:t,matches:e.new.child_id===t,timestamp:new Date().toISOString()}),e.new.child_id===t?w(n=>n.some(S=>S.id===e.new.id)?(a.warn("âš ï¸ [CHAT] Duplicate message detected, ignoring:",e.new.id),n):[...n,e.new]):a.warn("âš ï¸ [CHAT] Received message for different child_id, ignoring:",{received:e.new.child_id,expected:t})}).subscribe((e,n)=>{a.log("ðŸ“¡ [CHAT] Realtime subscription status:",{status:e,channel:s,childId:t,isChild:i,error:n?g(n):void 0,timestamp:new Date().toISOString()}),e==="SUBSCRIBED"||e==="CHANNEL_ERROR"&&a.error("âŒ [CHAT] Realtime subscription error:",n?g(n):"Unknown error")})}})(),()=>{x.current&&(f.removeChannel(x.current),x.current=null)}),[l,_]),m.useEffect(()=>{B()},[I]),m.useEffect(()=>{if(d&&!h||!d&&!l)return;(async()=>{try{const t=d?h?.id:l;if(!t){a.log("âš ï¸ [CHAT READ] No targetChildId, skipping mark as read");return}a.log("ðŸ“– [CHAT READ] Starting mark as read process",{targetChildId:t,isChild:d,timestamp:new Date().toISOString()});let i=f.from("messages").select("id, sender_type, read_at").eq("child_id",t).is("read_at",null);d?i=i.eq("sender_type","parent"):i=i.eq("sender_type","child");const{data:u,error:r}=await i;if(r){a.error("âŒ [CHAT READ] Error fetching unread messages:",g(r));return}if(!u||u.length===0){a.log("âœ… [CHAT READ] No unread messages found"),v.getState().clearUnreadForChild(t);return}const s=u.map(p=>p.id);a.log(`ðŸ“– [CHAT READ] Found ${s.length} unread messages to mark as read`,{messageIds:s.slice(0,5),totalCount:s.length});const e=new Date().toISOString(),{error:n}=await f.from("messages").update({read_at:e}).in("id",s);if(n){a.error("âŒ [CHAT READ] Error marking messages as read:",g(n));return}a.log(`âœ… [CHAT READ] Successfully marked ${s.length} messages as read`,{readAt:e}),w(p=>p.map(S=>s.includes(S.id)?{...S,read_at:e}:S)),v.getState().clearUnreadForChild(t),a.log(`âœ… [CHAT READ] Badge cleared immediately for child ${t}`)}catch(t){a.error("âŒ [CHAT READ] Error in markMessagesAsRead:",g(t))}})()},[h,l,d]),m.useEffect(()=>()=>{const i=!!localStorage.getItem("childSession")?h?.id||null:l;i&&v.getState().clearUnreadForChild(i)},[h,l]),m.useEffect(()=>{if(!h)return;const o=d?h.id:l;if(!o)return;const t=setInterval(async()=>{try{const{data:i,error:u}=await f.from("messages").select("*").eq("child_id",o).order("created_at",{ascending:!0});!u&&i&&w(r=>{const s=new Set(r.map(n=>n.id)),e=i.filter(n=>!s.has(n.id));return e.length>0?(a.log("ðŸ“¨ [CHAT] Polling found new messages:",e.length),[...r,...e]):r})}catch(i){a.error("âŒ [CHAT] Polling error:",g(i))}},15e3);return()=>clearInterval(t)},[h,l,d]);const U=async o=>{const{data:t}=await f.from("children").select("*").eq("id",o).single();t&&y(t)},A=async o=>{const{data:t,error:i}=await f.from("messages").select("*").eq("child_id",o).order("created_at",{ascending:!0});if(i){k({title:"Error loading messages",description:i.message,variant:"destructive"});return}w(t||[])},$=async o=>{if(o.preventDefault(),!(!E.trim()||!h)){j(!0);try{const t=d?h.id:l;let i,u;if(d)i=h.id,u=void 0;else{const{data:{user:n},error:p}=await f.auth.getUser();if(p||!n)throw new Error("Not authenticated. Please log in again.");i=n.id,u=n.id}if(!i)throw new Error("Missing sender_id");if(!t)throw new Error("Missing child_id");const r={child_id:t,sender_id:i,sender_type:d?"child":"parent",content:E.trim()};if(d){if(r.sender_type!=="child")throw new Error("Invalid sender_type for child message");if(r.sender_id!==r.child_id)throw new Error(`RLS policy violation: sender_id (${r.sender_id}) must equal child_id (${r.child_id})`)}a.log("ðŸ“¤ [MESSAGE INSERT] Payload:",{child_id:r.child_id,sender_id:r.sender_id,sender_type:r.sender_type,content_length:r.content.length,isChild:d,auth_uid:u,sender_id_matches_auth_uid:d?"N/A (anon)":i===u,sender_id_equals_child_id:d?r.sender_id===r.child_id:"N/A"});const{data:s,error:e}=await f.from("messages").insert(r).select().single();if(e)throw a.error("âŒ [MESSAGE INSERT] Error:",{message:e.message,code:e.code,details:e.details?K(e.details):void 0,hint:e.hint,payload_metadata:{child_id:r.child_id,sender_id:r.sender_id,sender_type:r.sender_type,content_length:r.content.length,sender_id_equals_child_id:d?r.sender_id===r.child_id:"N/A"}}),e.code==="42501"||e.message.includes("row-level security")?new Error("Unable to send message. Please check database RLS policies are correctly configured."):e;if(a.log("âœ… [MESSAGE INSERT] Success",{messageId:s?.id}),s){const n={id:s.id,sender_type:s.sender_type,content:s.content,created_at:s.created_at};w(p=>p.some(P=>P.id===n.id)?(a.log("â„¹ï¸ [MESSAGE INSERT] Message already in state (realtime beat us), skipping optimistic update"),p):(a.log("âœ… [MESSAGE INSERT] Adding message to local state (optimistic update)"),[...p,n]))}N("")}catch(t){a.error("âŒ [MESSAGE INSERT] Exception:",g(t)),k({title:"Error sending message",description:t.message||"Failed to send message",variant:"destructive"})}finally{j(!1)}}},B=()=>{M.current?.scrollIntoView({behavior:"smooth"})},O=()=>{_(d?"/child/dashboard":"/parent/children")};return c.jsxs("div",{className:"min-h-[100dvh] flex flex-col bg-background relative",children:[c.jsxs("div",{className:"bg-chat-accent p-4 flex items-center gap-4 fixed top-0 left-0 right-0 z-10",children:[c.jsx(H,{onClick:O,variant:"ghost",size:"sm",className:"text-white",children:c.jsx(G,{className:"h-5 w-5"})}),c.jsxs("div",{className:"flex items-center gap-3",children:[d?b&&c.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-white font-bold bg-primary",children:b.name[0].toUpperCase()}):h&&c.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-white font-bold",style:{backgroundColor:h.avatar_color},children:h.name[0]}),c.jsx("h1",{className:"text-xl font-bold text-white",children:d?q:h?.name})]})]}),c.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",style:{paddingTop:"80px",paddingBottom:"100px"},children:[I.map(o=>{const t=d?o.sender_type==="child":o.sender_type==="parent";return c.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:c.jsxs(V,{className:`max-w-xs p-3 ${t?"bg-chat-accent text-chat-accent-foreground":"bg-muted"}`,children:[c.jsx("p",{className:"break-words",children:o.content}),c.jsx("p",{className:`text-xs mt-1 ${t?"text-white/70":"text-muted-foreground"}`,children:new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},o.id)}),c.jsx("div",{ref:M})]}),c.jsx("form",{onSubmit:$,className:"p-4 bg-card border-t fixed bottom-0 left-0 right-0 z-10",children:c.jsxs("div",{className:"flex gap-2",children:[c.jsx(Q,{value:E,onChange:o=>N(o.target.value),placeholder:"Type a message...",disabled:T,className:"flex-1"}),c.jsx(H,{type:"submit",disabled:T||!E.trim(),className:"bg-chat-accent text-chat-accent-foreground hover:bg-chat-accent/90",children:c.jsx(F,{className:"h-4 w-4"})})]})})]})};export{se as default};

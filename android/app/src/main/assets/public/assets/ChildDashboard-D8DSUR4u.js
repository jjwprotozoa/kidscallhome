const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/acknowledgeMissedCalls-Bdh7pkvE.js","assets/index-4JrybDns.js","assets/vendor-react-LQlp3yIU.js","assets/vendor-radix-BQCqNqg0.js","assets/vendor-other-DUaz7rji.js","assets/vendor-capacitor-DSxgEnoB.js","assets/vendor-supabase-Bq0a3XdW.js","assets/index-DOEvG4-O.css"])))=>i.map(i=>d[i]);
import{_ as H}from"./vendor-capacitor-DSxgEnoB.js";import{r as l,u as z,n as U,j as e,_ as L,M as K,o as V}from"./vendor-react-LQlp3yIU.js";import{e as W,f as J,u as G,n as Q,s as f,t as X,C as E,B as Y,A as Z,g as ee,h as te,i as se,j as ae,k as re,l as ne,m as le,r as ie}from"./index-4JrybDns.js";import{N as ce}from"./Navigation-oN70GkMP.js";import{O as oe,H as de}from"./OnboardingTour-DCxLRID0.js";import{u as ue}from"./useParentPresence-CJK56jc9.js";import{S as A}from"./StatusIndicator-B5uOwO2H.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-DUaz7rji.js";import"./vendor-supabase-Bq0a3XdW.js";import"./deviceTracking-lBUE_lfK.js";const _e=()=>{const[s,q]=l.useState(null),[i,p]=l.useState(null),[g,k]=l.useState("Parent"),[o,R]=l.useState(null),w=l.useRef("Parent"),y=W(s?.id||null),_=J(s?.id||null),h=l.useRef(null),I=l.useRef(null),j=l.useRef(!1),d=z(),P=U(),{toast:M}=G(),{handleIncomingCall:D,stopIncomingCall:v}=Q({enabled:!0,volume:.7}),O=l.useRef(D);l.useEffect(()=>{const r=localStorage.getItem("childSession");if(!r){d("/child/login");return}const n=JSON.parse(r);q(n);const b=localStorage.getItem("selectedParentId");b&&R(b),(async()=>{try{let c;if(b)c=b;else{const{data:a,error:t}=await f.from("children").select("parent_id").eq("id",n.id).single();if(t||!a){console.error("Error fetching child record:",t);return}c=a.parent_id,R(c)}const{data:x,error:C}=await f.from("parents").select("name").eq("id",c).maybeSingle();if(C){console.error("Error fetching parent name:",C);return}x?.name?(k(x.name),w.current=x.name):(k("Parent"),w.current="Parent")}catch(c){console.error("Error fetching parent name:",c)}})();let N=null,S=null;return(async()=>{const c=async a=>{a.id!==N&&(P.pathname.startsWith("/call/")||(N=a.id,p({id:a.id,parent_id:a.parent_id}),O.current({callId:a.id,callerName:w.current,callerId:a.parent_id,url:`/call/${n.id}?callId=${a.id}`})))},x=async()=>{const a=new Date(Date.now()-12e4).toISOString(),{data:t}=await f.from("calls").select("*").eq("child_id",n.id).eq("caller_type","parent").eq("status","ringing").gte("created_at",a).order("created_at",{ascending:!1}).limit(1);if(t&&t.length>0){const m=t[0];m.id!==N&&await c(m)}},C=async()=>{const a=new Date(Date.now()-6e4).toISOString(),{data:t}=await f.from("calls").select("*").eq("child_id",n.id).eq("caller_type","parent").eq("status","ringing").gte("created_at",a).order("created_at",{ascending:!1}).limit(1);if(t&&t.length>0){const m=t[0];m.id!==N&&await c(m)}};await x(),S=setInterval(C,6e4),I.current=f.channel("child-incoming-calls").on("postgres_changes",{event:"INSERT",schema:"public",table:"calls",filter:`child_id=eq.${n.id}`},async a=>{const t=a.new;t.caller_type==="parent"&&t.child_id===n.id&&t.status==="ringing"&&await c(t)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"calls",filter:`child_id=eq.${n.id}`},async a=>{const t=a.new,m=a.old;t.caller_type!=="child"&&(P.pathname.startsWith("/call/")||(h.current&&h.current.id===t.id&&(t.status==="active"||t.status==="ended")&&(p(null),h.current=null),t.caller_type==="parent"&&t.child_id===n.id&&t.status==="ringing"&&m.status!=="ringing"&&await c(t)))}).subscribe((a,t)=>{t&&console.error("âŒ [CHILD DASHBOARD] Realtime subscription error:",t)})})(),()=>{I.current&&f.removeChannel(I.current),S&&clearInterval(S)}},[d,P.pathname]),l.useEffect(()=>{h.current=i},[i]),l.useEffect(()=>{O.current=D},[D]),X({userId:s?.id||"",userType:"child",name:s?.name,enabled:!!s});const{isOnline:u}=ue({parentId:o||s?.parent_id||"",enabled:!!(o||s?.parent_id)});l.useEffect(()=>{!i&&h.current&&v(h.current.id)},[i,v]);const $=async()=>{if(s&&o){try{const{acknowledgeMissedCalls:r}=await H(async()=>{const{acknowledgeMissedCalls:n}=await import("./acknowledgeMissedCalls-Bdh7pkvE.js");return{acknowledgeMissedCalls:n}},__vite__mapDeps([0,1,2,3,4,5,6,7]));await r(s.id,"parent")}catch(r){console.error("Error acknowledging missed calls:",r)}d(`/call/${s.id}`)}else o||d("/child/parents")},B=()=>{s&&o?d(`/chat/${s.id}`):o||d("/child/parents")},F=()=>{if(i&&s){v(i.id),j.current=!0;const r=i.id;p(null),d(`/call/${s.id}?callId=${r}`),setTimeout(()=>{j.current=!1},2e3)}},T=async()=>{if(i){if(j.current)return;try{await ie({callId:i.id,by:"child",reason:"declined"})}catch(r){console.error("âŒ [USER ACTION] Error declining call:",r);const n=r instanceof Error?r.message:"Unknown error";M({title:"Error",description:"Failed to decline call: "+n,variant:"destructive"})}v(i.id),p(null)}};return s?e.jsxs("div",{className:"min-h-[100dvh] bg-primary/5",children:[e.jsx(ce,{}),e.jsx(oe,{role:"child",pageKey:"child_dashboard"}),e.jsx(de,{role:"child",pageKey:"child_dashboard"}),e.jsx("div",{className:"p-4",style:{paddingTop:"calc(1rem + 64px + var(--safe-area-inset-top) * 0.15)"},children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[e.jsx("div",{className:"mt-8",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full flex items-center justify-center text-3xl font-bold text-white",style:{backgroundColor:s.avatar_color},children:s.name[0]}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("h1",{className:"text-3xl font-bold",children:["Hi ",s.name,"!"]})}),e.jsx("div",{className:"text-muted-foreground",children:o?e.jsxs("span",{className:"flex items-center gap-2",children:["Ready to connect with ",g,"?",o&&e.jsx(A,{isOnline:u,size:"sm",showPulse:u})]}):"Select a parent to contact"})]})]})}),o?e.jsxs("div",{className:"grid gap-4",children:[e.jsxs(E,{className:"p-8 cursor-pointer hover:shadow-lg transition-all border-4 relative",style:{borderColor:s.avatar_color},onClick:$,"data-tour":"child-answer-button",children:[y>0&&e.jsx("span",{className:"absolute top-4 right-4 bg-destructive text-destructive-foreground text-xs font-bold rounded-full min-w-[24px] h-6 flex items-center justify-center px-2 border-2 border-background",children:y>99?"99+":y}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("div",{className:"w-20 h-20 rounded-full flex items-center justify-center",style:{backgroundColor:s.avatar_color},children:e.jsx(L,{className:"h-10 w-10 text-white"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("h2",{className:"text-3xl font-bold mb-2",children:["Call ",g]}),e.jsx(A,{isOnline:u,size:"md",showPulse:u})]}),e.jsx("p",{className:"text-muted-foreground",children:u?"Parent is online":"Parent is offline"})]})]})]}),e.jsxs(E,{className:"p-8 cursor-pointer hover:shadow-lg transition-all border-4 relative",style:{borderColor:s.avatar_color},onClick:B,"data-tour":"child-messages",children:[_>0&&e.jsx("span",{className:"absolute top-4 right-4 bg-destructive text-destructive-foreground text-xs font-bold rounded-full min-w-[24px] h-6 flex items-center justify-center px-2 border-2 border-background",children:_>99?"99+":_}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("div",{className:"w-20 h-20 rounded-full flex items-center justify-center",style:{backgroundColor:s.avatar_color},children:e.jsx(K,{className:"h-10 w-10 text-white"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-3xl font-bold mb-2",children:"Send Message"}),e.jsx(A,{isOnline:u,size:"md",showPulse:u})]}),e.jsxs("p",{className:"text-muted-foreground",children:["Chat with ",g," ",u?"(online)":"(offline)"]})]})]})]})]}):e.jsxs(E,{className:"p-6 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Please select a parent first"}),e.jsx(Y,{onClick:()=>d("/child/parents"),size:"lg",children:"Select Parent"})]})]})}),e.jsx(Z,{open:!!i,onOpenChange:r=>{!r&&i&&!j.current&&T()},children:e.jsxs(ee,{className:"sm:max-w-md",children:[e.jsxs(te,{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold text-white",style:{backgroundColor:s?.avatar_color||"#3B82F6"},children:"ðŸ“ž"}),e.jsxs("div",{children:[e.jsx(se,{className:"text-xl",children:"Incoming Call"}),e.jsxs("p",{className:"text-base font-normal text-muted-foreground",children:[g," is calling..."]})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsxs(ae,{className:"sr-only",children:["Incoming call from ",g]}),e.jsx("div",{className:"flex items-center justify-center gap-2 text-4xl animate-pulse",children:e.jsx(V,{className:"h-12 w-12"})})]})]}),e.jsxs(re,{className:"sm:justify-center gap-2",children:[e.jsx(ne,{onClick:T,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Decline"}),e.jsx(le,{onClick:F,className:"bg-green-600 hover:bg-green-700",children:"Answer"})]})]})})]}):null};export{_e as default};

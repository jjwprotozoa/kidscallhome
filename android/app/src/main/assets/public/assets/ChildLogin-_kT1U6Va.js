const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deviceTracking-lBUE_lfK.js","assets/vendor-capacitor-DSxgEnoB.js"])))=>i.map(i=>d[i]);
import{_ as me}from"./vendor-capacitor-DSxgEnoB.js";import{j as e,aK as pe,r as f,aL as Ne,aM as Ce,aN as ge,t as ue,aO as Se,u as De}from"./vendor-react-LQlp3yIU.js";import{C as te,B as S,b as ne,s as F,u as ke,a as Q,d as ce}from"./index-4JrybDns.js";import{generateDeviceIdentifier as de}from"./deviceTracking-lBUE_lfK.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-DUaz7rji.js";import"./vendor-supabase-Bq0a3XdW.js";const ee=[{name:"red",color:"#EF4444"},{name:"blue",color:"#3B82F6"},{name:"green",color:"#10B981"},{name:"yellow",color:"#FBBF24"},{name:"orange",color:"#F97316"},{name:"purple",color:"#A855F7"},{name:"pink",color:"#EC4899"},{name:"brown",color:"#92400E"},{name:"black",color:"#1F2937"},{name:"white",color:"#F3F4F6"}],ve=[{name:"cat",emoji:"ðŸ±"},{name:"dog",emoji:"ðŸ¶"},{name:"bird",emoji:"ðŸ¦"},{name:"fish",emoji:"ðŸ "},{name:"bear",emoji:"ðŸ»"},{name:"lion",emoji:"ðŸ¦"},{name:"tiger",emoji:"ðŸ¯"},{name:"elephant",emoji:"ðŸ˜"},{name:"monkey",emoji:"ðŸµ"},{name:"rabbit",emoji:"ðŸ°"},{name:"horse",emoji:"ðŸ´"},{name:"duck",emoji:"ðŸ¦†"},{name:"cow",emoji:"ðŸ„"},{name:"pig",emoji:"ðŸ·"},{name:"sheep",emoji:"ðŸ‘"}],K=[{id:0,label:"A-I",chars:["A","B","C","D","E","F","G","H","I"]},{id:1,label:"J-R",chars:["J","K","L","M","N","O","P","Q","R"]},{id:2,label:"S-Z",chars:["S","T","U","V","W","X","Y","Z"]},{id:3,label:"0-9",chars:["0","1","2","3","4","5","6","7","8","9"]}],Ie=({familyCode:s,codeType:r,onCodeTypeChange:i,onOptionSelect:c,onBack:m})=>e.jsx("div",{className:"min-h-[100dvh] flex items-center justify-center bg-primary/5 p-4",children:e.jsxs(te,{className:"w-full max-w-2xl p-8 space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(S,{variant:"ghost",onClick:m,className:"absolute top-4 left-4",children:"â† Back"}),e.jsx(pe,{className:"h-20 w-20 text-primary mx-auto"}),e.jsx("h1",{className:"text-4xl font-bold text-primary",children:"Hi There!"}),e.jsxs("p",{className:"text-xl",children:["Family Code:"," ",e.jsx("span",{className:"font-mono font-bold text-primary",children:s})]}),e.jsx("p",{className:"text-lg",children:"Pick your color or animal"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{variant:r==="color"?"default":"outline",onClick:()=>i("color"),className:"flex-1",size:"lg",children:"Colors"}),e.jsx(S,{variant:r==="animal"?"default":"outline",onClick:()=>i("animal"),className:"flex-1",size:"lg",children:"Animals"})]}),r==="color"?e.jsx("div",{className:"grid grid-cols-5 gap-3",children:ee.map(o=>e.jsx("button",{onClick:()=>c(o.name,"color"),className:"h-20 rounded-xl border-2 border-transparent hover:border-primary transition-all flex items-center justify-center hover:scale-105",style:{backgroundColor:o.color},children:e.jsx("span",{className:"text-white font-bold text-sm capitalize drop-shadow-lg",children:o.name})},o.name))}):e.jsx("div",{className:"grid grid-cols-5 gap-3",children:ve.map(o=>e.jsxs("button",{onClick:()=>c(o.name,"animal"),className:"h-20 rounded-xl border-2 border-transparent hover:border-primary transition-all flex flex-col items-center justify-center hover:scale-105 hover:bg-muted",children:[e.jsx("span",{className:"text-3xl",children:o.emoji}),e.jsx("span",{className:"text-xs font-medium capitalize mt-1",children:o.name})]},o.name))})]})]})}),ze=({familyCode:s,currentBlock:r,loading:i,onFamilyCodeChange:c,onBlockChange:m,onDelete:o,onSubmit:l})=>{const p=f.useRef(null),d=f.useRef(0),n=f.useRef(0),v=f.useRef(0),_=f.useRef(!1),w=f.useRef(0),W=f.useRef(0),P=K[r],q=r===0,Y=r===K.length-1,E=u=>{u>=0&&u<K.length&&m(u)},R=u=>{_.current||(d.current=u.touches[0].clientX,v.current=Date.now())},L=u=>{d.current!==0&&(n.current=u.touches[0].clientX)},x=()=>{if(d.current===0||n.current===0)return;const u=d.current-n.current,z=Date.now()-v.current;Math.abs(u)>30&&z<600&&d.current!==0&&n.current!==0&&(!_.current||Math.abs(u)>50)&&(u>0?E(Math.min(r+1,K.length-1)):E(Math.max(r-1,0))),d.current=0,n.current=0,v.current=0};return e.jsx("div",{className:"min-h-[100dvh] flex items-center justify-center bg-primary/5 p-4",children:e.jsxs(te,{className:"w-full max-w-md p-6 space-y-3",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(pe,{className:"h-16 w-16 text-primary mx-auto"}),e.jsx("h1",{className:"text-3xl font-bold text-primary",children:"Hi There!"}),e.jsx("p",{className:"text-lg",children:"Enter your family code"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ask a parent for your 6-character family code"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-muted p-4 rounded-2xl",children:e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-full max-w-sm h-16 rounded-xl bg-card flex items-center justify-center border-2 border-primary/20 px-4",children:e.jsx("span",{className:"text-2xl sm:text-3xl font-bold text-primary font-mono tracking-wider whitespace-nowrap",children:s.padEnd(6,"_")})})})}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(S,{onClick:()=>E(r-1),disabled:q,variant:"outline",size:"sm",className:"flex-shrink-0","aria-label":"Previous block",children:e.jsx(Ne,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex items-center gap-2 flex-1 justify-center",children:K.map((u,z)=>e.jsx("button",{onClick:()=>E(z),className:`transition-all duration-200 rounded-full ${z===r?"w-3 h-3 bg-primary scale-125":"w-2 h-2 bg-muted-foreground/30 hover:bg-muted-foreground/50"}`,"aria-label":`Go to ${u.label} block`,"aria-current":z===r?"true":"false"},u.id))}),e.jsx(S,{onClick:()=>E(r+1),disabled:Y,variant:"outline",size:"sm",className:"flex-shrink-0","aria-label":"Next block",children:e.jsx(Ce,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"text-center -mt-1",children:e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:P.label})}),e.jsxs("div",{ref:p,className:"relative overflow-hidden",style:{touchAction:"pan-x"},children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-16 z-0 pointer-events-auto",onTouchStart:R,onTouchMove:L,onTouchEnd:x}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-16 z-0 pointer-events-auto",onTouchStart:R,onTouchMove:L,onTouchEnd:x}),e.jsx("div",{className:"relative z-10",onTouchStart:R,onTouchMove:L,onTouchEnd:x,children:K.map((u,z)=>e.jsxs("div",{className:`grid grid-cols-3 gap-3 transition-all duration-300 ease-in-out ${z===r?"opacity-100 translate-x-0 pointer-events-auto":z<r?"opacity-0 -translate-x-full absolute inset-0 pointer-events-none":"opacity-0 translate-x-full absolute inset-0 pointer-events-none"}`,children:[u.chars.map($=>e.jsx(S,{onClick:()=>c(s+$),onTouchStart:O=>{w.current=O.touches[0].clientX,W.current=Date.now()},onTouchMove:O=>{Math.abs(O.touches[0].clientX-w.current)>10?_.current=!1:_.current=!0},onTouchEnd:O=>{const U=Math.abs(O.changedTouches[0].clientX-w.current),ie=Date.now()-W.current;U<10&&ie<300?(_.current=!0,setTimeout(()=>{_.current=!1},100)):_.current=!1},onTouchCancel:()=>{_.current=!1,w.current=0,W.current=0},size:"lg",variant:"outline",className:"h-14 sm:h-16 text-xl sm:text-2xl font-bold rounded-xl hover:bg-primary hover:text-primary-foreground transition-all active:scale-95 border-2 pointer-events-auto relative z-10",disabled:s.length>=6,"aria-label":`Enter ${$}`,style:{touchAction:"manipulation",WebkitTouchCallout:"none",WebkitUserSelect:"none"},children:$},$)),u.chars.length%3===1&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"col-span-1"}),e.jsx("div",{className:"col-span-1"})]}),u.chars.length%3===2&&e.jsx("div",{className:"col-span-1"})]},u.id))})]}),e.jsxs("div",{className:"space-y-2 -mt-1",children:[e.jsxs(S,{onClick:o,size:"lg",variant:"outline",className:"w-full h-11 rounded-xl",disabled:!s,children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Delete"]}),e.jsx(S,{onClick:l,disabled:s.length<3||i,size:"lg",className:"w-full text-lg h-11 rounded-xl",children:i?"Checking...":"Next"})]})]})]})})},Ae=({selectedOption:s,codeType:r,familyCode:i,number:c,loading:m,onBack:o,onNumberClick:l,onDelete:p,onLogin:d})=>{const n=r==="color"?ee.find(v=>v.name===s):ve.find(v=>v.name===s);return e.jsx("div",{className:"min-h-[100dvh] flex items-center justify-center bg-primary/5 p-4",children:e.jsxs(te,{className:"w-full max-w-md p-8 space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(S,{variant:"ghost",onClick:o,className:"absolute top-4 left-4",children:"â† Back"}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[r==="color"&&n&&"color"in n?e.jsx("div",{className:"w-16 h-16 rounded-full border-4 border-primary",style:{backgroundColor:n.color}}):n&&"emoji"in n?e.jsx("div",{className:"text-6xl",children:n.emoji}):null,e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold capitalize",children:s}),e.jsxs("p",{className:"text-muted-foreground",children:["Family: ",e.jsx("span",{className:"font-mono font-semibold",children:i})]}),e.jsx("p",{className:"text-muted-foreground",children:"Now enter your number"})]})]})]}),e.jsx("div",{className:"bg-muted p-6 rounded-2xl",children:e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-32 h-20 rounded-xl bg-card flex items-center justify-center border-2 border-primary/20",children:e.jsx("span",{className:"text-5xl font-bold text-primary",children:c||"?"})})})}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[[1,2,3,4,5,6,7,8,9].map(v=>e.jsx(S,{onClick:()=>l(v.toString()),size:"lg",variant:"outline",className:"h-16 text-2xl font-bold rounded-xl",children:v},v)),e.jsxs(S,{onClick:p,size:"lg",variant:"outline",className:"h-16 rounded-xl col-span-2",disabled:!c,children:[e.jsx(ge,{className:"h-6 w-6 mr-2"}),"Delete"]}),e.jsx(S,{onClick:()=>l("0"),size:"lg",variant:"outline",className:"h-16 text-2xl font-bold rounded-xl",children:"0"})]}),e.jsx(S,{onClick:d,disabled:!c||m,size:"lg",className:"w-full text-xl h-14 rounded-xl",children:m?"Checking...":"Go!"})]})})},Ee=({childName:s,avatarColor:r})=>e.jsx("div",{className:"min-h-[100dvh] flex items-center justify-center bg-primary/5 p-4",children:e.jsx(te,{className:"w-full max-w-md p-8 space-y-6 text-center",children:e.jsxs("div",{className:"space-y-4 animate-bounce",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-24 h-24 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg",style:{backgroundColor:r},children:s[0].toUpperCase()})}),e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx(ue,{className:"h-8 w-8 text-yellow-500 animate-pulse"}),e.jsxs("h1",{className:"text-4xl font-bold text-primary",children:["Welcome, ",s,"!"]}),e.jsx(ue,{className:"h-8 w-8 text-yellow-500 animate-pulse"})]}),e.jsx("p",{className:"text-xl text-muted-foreground",children:"You're all set! ðŸŽ‰"})]})})}),xe="kidscallhome_authorized_devices";function le(){try{const s=localStorage.getItem(xe);return s?JSON.parse(s):[]}catch{return[]}}function Te(s){try{localStorage.setItem(xe,JSON.stringify(s))}catch(r){console.warn("Failed to save authorized devices:",r)}}function Fe(s){const r=de();return le().some(c=>c.deviceId===r&&c.childId===s)}function he(s){const r=de(),i=le(),c=i.findIndex(o=>o.deviceId===r&&o.childId===s);c>=0?i[c].authorizedAt=new Date().toISOString():i.push({deviceId:r,childId:s,authorizedAt:new Date().toISOString()});const m=i.filter(o=>o.childId===s);m.length>10&&(m.sort((l,p)=>new Date(l.authorizedAt).getTime()-new Date(p.authorizedAt).getTime()),m.slice(0,m.length-10).forEach(l=>{const p=i.findIndex(d=>d.deviceId===l.deviceId&&d.childId===l.childId);p>=0&&i.splice(p,1)})),Te(i)}function fe(){const s=de(),i=le().filter(c=>c.deviceId===s);return i.length===0?null:(i.sort((c,m)=>new Date(m.authorizedAt).getTime()-new Date(c.authorizedAt).getTime()),i[0].childId)}async function C(s,r,i={}){try{const c=i.metadata?ne(i.metadata,{maskValue:!0,removeField:!1}):void 0,m=i.error?{message:(i.error instanceof Error,i.error.message),code:(i.error instanceof Error,i.error.code),details:i.error instanceof Error?ne(i.error.details||{}):ne(i.error.details||{})}:void 0,o={level:s,message:r,parent_id:i.parent_id,child_id:i.child_id,device_id:i.device_id,device_identifier:i.device_identifier,metadata:c,error:m};try{const{error:l}=await F.rpc("log_device_tracking",{p_log_entry:o}).catch(d=>{const n=d;if(n?.status===404||n?.code==="PGRST301")return{error:{code:"PGRST301",message:"Function not found",status:404}};throw d});if(!l)return;if(l.code==="42883"||l.code==="P0001"||l.code==="PGRST301"||l.status===404||l.message?.includes("does not exist")||l.message?.includes("function")&&l.message?.includes("not found")||l.message?.includes("404")||l.message?.includes("Not Found")){try{const d=oe();d.push({...o,timestamp:Date.now()}),d.length>100&&d.shift(),localStorage.setItem("kch_device_tracking_logs",JSON.stringify(d))}catch{}return}}catch(l){const p=l;if(p?.status===404||p?.code==="PGRST301"||p?.message?.includes("404")||p?.message?.includes("Not Found")){try{const n=oe();n.push({...o,timestamp:Date.now()}),n.length>100&&n.shift(),localStorage.setItem("kch_device_tracking_logs",JSON.stringify(n))}catch{}return}try{const n=oe();n.push({...o,timestamp:Date.now()}),n.length>100&&n.shift(),localStorage.setItem("kch_device_tracking_logs",JSON.stringify(n))}catch{}}}catch{}}function oe(){try{const s=localStorage.getItem("kch_device_tracking_logs");return s?JSON.parse(s):[]}catch{return[]}}const Je=()=>{const[s]=Se(),[r,i]=f.useState("familyCode"),[c,m]=f.useState(""),[o,l]=f.useState(0),[p,d]=f.useState("color"),[n,v]=f.useState(""),[_,w]=f.useState(""),[W,P]=f.useState(!1),[q,Y]=f.useState(null),[E,R]=f.useState(!1),L=De(),{toast:x}=ke(),u=async h=>{P(!0);try{const t=h.split("-");let b=h;if(t.length===3){const[g,D,T]=t;b=`${g.toUpperCase()}-${D.toLowerCase()}-${T}`}const{data:a,error:N}=await F.from("children").select("id, name, avatar_color, parent_id").eq("login_code",b).maybeSingle();if(N){Q.error("Login error:",ce(N)),x({title:"Login error",description:N.message||"Failed to verify login code. Please try again.",variant:"destructive"}),w(""),m(""),i("familyCode"),P(!1);return}if(!a){Q.debug("Login code not found in database (code redacted)"),x({title:"Code not found",description:"Please check your code and try again",variant:"destructive"}),w(""),m(""),i("familyCode"),P(!1);return}if(Y(a),i("success"),localStorage.setItem("childSession",JSON.stringify(a)),E||he(a.id),a.parent_id)try{const{generateDeviceIdentifierAsync:g,detectDeviceType:D,getDeviceName:T,getClientIP:B,getDeviceMacAddress:y,getCountryFromIP:V}=await me(async()=>{const{generateDeviceIdentifierAsync:M,detectDeviceType:ae,getDeviceName:re,getClientIP:se,getDeviceMacAddress:we,getCountryFromIP:be}=await import("./deviceTracking-lBUE_lfK.js");return{generateDeviceIdentifierAsync:M,detectDeviceType:ae,getDeviceName:re,getClientIP:se,getDeviceMacAddress:we,getCountryFromIP:be}},__vite__mapDeps([0,1])),j=await g(),X=D(),J=T(),Z=navigator.userAgent,H=await B(),G=await y(),k=await V(H);await C("info","Attempting to track device",{parent_id:a.parent_id,child_id:a.id,device_identifier:j,metadata:{device_type:X,device_name:J,is_native:j.startsWith("native-")||j.startsWith("cordova-")||j.startsWith("mac-")}});let{data:A,error:I}=await F.rpc("update_device_login",{p_parent_id:a.parent_id,p_device_identifier:j,p_device_name:J,p_device_type:X,p_user_agent:Z,p_ip_address:H||null,p_mac_address:G||null,p_country_code:k||null,p_child_id:a.id});if(I&&(I.code==="42883"||I.message?.includes("function")||I.message?.includes("does not exist"))){await C("warn","Function signature mismatch, trying without country_code",{parent_id:a.parent_id,child_id:a.id,device_identifier:j,error:I});const M=await F.rpc("update_device_login",{p_parent_id:a.parent_id,p_device_identifier:j,p_device_name:J,p_device_type:X,p_user_agent:Z,p_ip_address:H||null,p_mac_address:G||null,p_child_id:a.id});if(M.error)throw await C("error","Error (fallback also failed)",{parent_id:a.parent_id,child_id:a.id,device_identifier:j,error:M.error}),M.error;A=M.data,I=null,await C("success","Device tracked successfully (without country_code)",{parent_id:a.parent_id,child_id:a.id,device_identifier:j,device_id:A})}else{if(I)throw await C("error","Device tracking error",{parent_id:a.parent_id,child_id:a.id,device_identifier:j,error:I}),I;await C("success","Device tracked successfully",{parent_id:a.parent_id,child_id:a.id,device_identifier:j,device_id:A})}}catch(g){await C("error","Failed to track device",{parent_id:a.parent_id,child_id:a.id,error:g instanceof Error?g:{message:String(g)}})}setTimeout(()=>{L("/child/dashboard")},2e3)}catch(t){Q.error("Login exception:",ce(t)),x({title:"Error",description:t instanceof Error?t.message:"An error occurred during login",variant:"destructive"}),i("familyCode"),P(!1)}};f.useEffect(()=>{(async()=>{const t=fe();if(t&&Fe(t)){const b=localStorage.getItem("childSession");if(b)try{if(JSON.parse(b).id===t){L("/child/dashboard");return}}catch{}try{const{data:a}=await F.from("children").select("login_code").eq("id",t).maybeSingle();if(a?.login_code){const N=a.login_code.split("-");if(N.length===3){const[,g,D]=N;v(g),w(D);const T=ee.some(B=>B.name===g);d(T?"color":"animal"),R(!0),i("select")}}}catch(a){console.warn("Failed to fetch child data for authorized device:",a)}}})()},[L]),f.useEffect(()=>{const h=s.get("code");if(h&&h.trim()!==""){const b=decodeURIComponent(h.trim()).split("-");if(b.length===3){const[a,N,g]=b,D=a?.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6)||"";if(D.length===6&&N&&g&&N.length>0&&g.length>0){m(D),v(N.toLowerCase()),w(g);const T=ee.some(y=>y.name===N.toLowerCase());d(T?"color":"animal"),R(!1);const B=`${D}-${N.toLowerCase()}-${g}`;setTimeout(()=>{u(B)},500)}else x({title:"Invalid login code",description:D.length!==6?"Family code must be exactly 6 characters. Please check and try again.":"The login code format is incorrect. Please check and try again.",variant:"destructive"})}else x({title:"Invalid login code",description:"The login code format is incorrect. Expected: familyCode-color/animal-number (e.g., ABC123-monkey-37)",variant:"destructive"})}},[s]);const z=(h,t)=>{v(h),d(t),i("number")},$=h=>{const t=_+h;t.length<=2&&parseInt(t)<=99&&w(t)},O=()=>{w(_.slice(0,-1))},U=()=>{r==="number"?(i("select"),w("")):r==="select"&&(i("familyCode"),v(""))},ie=()=>{if(!c||c.trim().length<3){x({title:"Family code required",description:"Please enter your family code (6 characters)",variant:"destructive"});return}i("select")},_e=h=>{const t=h.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6);m(t)},ye=h=>{l(h)},je=async()=>{let h;if(E&&n&&_){const t=fe();if(t)try{const{data:b}=await F.from("children").select("login_code").eq("id",t).maybeSingle();if(b?.login_code)h=b.login_code;else{x({title:"Error",description:"Could not find your login code. Please enter your family code.",variant:"destructive"}),i("familyCode"),R(!1);return}}catch{x({title:"Error",description:"Could not verify your login code. Please enter your family code.",variant:"destructive"}),i("familyCode"),R(!1);return}else{x({title:"Incomplete code",description:"Please enter your family code, select a color/animal, and enter your number",variant:"destructive"});return}}else{if(!c||!n||!_){x({title:"Incomplete code",description:"Please enter your family code, select a color/animal, and enter your number",variant:"destructive"});return}h=`${c.toUpperCase()}-${n}-${_}`}P(!0);try{const{data:t,error:b}=await F.from("children").select("id, name, avatar_color, parent_id").eq("login_code",h).single();if(b||!t){x({title:"Code not found",description:"Please check your code and try again",variant:"destructive"}),w("");return}if(Y(t),i("success"),localStorage.setItem("childSession",JSON.stringify(t)),E||he(t.id),t.parent_id)try{const{generateDeviceIdentifierAsync:a,detectDeviceType:N,getDeviceName:g,getClientIP:D,getDeviceMacAddress:T,getCountryFromIP:B}=await me(async()=>{const{generateDeviceIdentifierAsync:A,detectDeviceType:I,getDeviceName:M,getClientIP:ae,getDeviceMacAddress:re,getCountryFromIP:se}=await import("./deviceTracking-lBUE_lfK.js");return{generateDeviceIdentifierAsync:A,detectDeviceType:I,getDeviceName:M,getClientIP:ae,getDeviceMacAddress:re,getCountryFromIP:se}},__vite__mapDeps([0,1])),y=await a(),V=N(),j=g(),X=navigator.userAgent,J=await D(),Z=await T(),H=await B(J);await C("info","Attempting to track device",{parent_id:t.parent_id,child_id:t.id,device_identifier:y,metadata:{device_type:V,device_name:j,is_native:y.startsWith("native-")||y.startsWith("cordova-")||y.startsWith("mac-")}});let{data:G,error:k}=await F.rpc("update_device_login",{p_parent_id:t.parent_id,p_device_identifier:y,p_device_name:j,p_device_type:V,p_user_agent:X,p_ip_address:J||null,p_mac_address:Z||null,p_country_code:H||null,p_child_id:t.id});if(k&&(k.code==="42883"||k.message?.includes("function")||k.message?.includes("does not exist"))){await C("warn","Function signature mismatch, trying without country_code",{parent_id:t.parent_id,child_id:t.id,device_identifier:y,error:k});const A=await F.rpc("update_device_login",{p_parent_id:t.parent_id,p_device_identifier:y,p_device_name:j,p_device_type:V,p_user_agent:X,p_ip_address:J||null,p_mac_address:Z||null,p_child_id:t.id});if(A.error)throw await C("error","Error (fallback also failed)",{parent_id:t.parent_id,child_id:t.id,device_identifier:y,error:A.error}),A.error;G=A.data,k=null,await C("success","Device tracked successfully (without country_code)",{parent_id:t.parent_id,child_id:t.id,device_identifier:y,device_id:G})}else{if(k)throw await C("error","Device tracking error",{parent_id:t.parent_id,child_id:t.id,device_identifier:y,error:k}),k;await C("success","Device tracked successfully",{parent_id:t.parent_id,child_id:t.id,device_identifier:y,device_id:G})}}catch(a){await C("error","Failed to track device",{parent_id:t.parent_id,child_id:t.id,error:a instanceof Error?a:{message:String(a)}})}setTimeout(()=>{L("/child/dashboard")},2e3)}catch(t){Q.error("Login exception:",ce(t)),x({title:"Error",description:t instanceof Error?t.message:"An error occurred during login",variant:"destructive"}),w("")}finally{P(!1)}};return r==="success"&&q?e.jsx(Ee,{childName:q.name,avatarColor:q.avatar_color}):r==="number"?e.jsx(Ae,{selectedOption:n,codeType:p,familyCode:c,number:_,loading:W,onBack:U,onNumberClick:$,onDelete:O,onLogin:je}):r==="familyCode"?e.jsx(ze,{familyCode:c,currentBlock:o,loading:W,onFamilyCodeChange:_e,onBlockChange:ye,onDelete:()=>m(c.slice(0,-1)),onSubmit:ie}):e.jsx(Ie,{familyCode:c,codeType:p,onCodeTypeChange:d,onOptionSelect:z,onBack:U})};export{Je as default};

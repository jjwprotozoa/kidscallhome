import{r as d,u as y,j as e,o as P}from"./vendor-react-mDIoga_b.js";import{u as C,C as p,B as E,s as o}from"./index-BdmHsoQZ.js";import{N as w}from"./Navigation-CglVk_ff.js";import{u as S}from"./useParentPresence-xis4RCQ0.js";import{S as _}from"./StatusIndicator-BZUItRQn.js";import{O as k,H as O}from"./OnboardingTour-BCKJLloU.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-BA4qpukX.js";import"./vendor-capacitor-DSxgEnoB.js";import"./vendor-supabase-DQP4RkUL.js";import"./deviceTracking-lBUE_lfK.js";const z=()=>{const[j,v]=d.useState(null),[i,f]=d.useState(null),[N,m]=d.useState(!0),c=y(),{toast:h}=C(),{isOnline:x}=S({parentId:i?.id||"",enabled:!!i?.id});d.useEffect(()=>{(async()=>{const{data:n}=await o.auth.getSession();n?.session&&await o.auth.signOut();const t=localStorage.getItem("childSession");if(!t){c("/child/login");return}let s;try{s=JSON.parse(t)}catch(r){console.error("❌ [ChildParentsList] Error parsing session data:",r),c("/child/login");return}v(s);let l=s.parent_id;if(!l&&s.id)try{const{data:r,error:u}=await o.from("children").select("parent_id").eq("id",s.id).single();if(u)throw console.error("❌ [ChildParentsList] Error fetching child record:",u),u;r?.parent_id&&(l=r.parent_id)}catch(r){console.error("❌ [ChildParentsList] Error fetching child's parent_id:",r)}l?await b(l):(h({title:"Error",description:"Could not find parent information",variant:"destructive"}),m(!1))})()},[c,h]);const b=async a=>{try{if(!a||a==="undefined"||a==="null")throw new Error("Invalid parent ID");try{const{data:s,error:l}=await o.rpc("get_parent_name_for_child",{parent_uuid:a});if(s&&(!Array.isArray(s)||s.length>0)){const r=Array.isArray(s)?s[0]:s;f(r),m(!1);return}}catch{}const{data:n,error:t}=await o.from("parents").select("id, name").eq("id",a).maybeSingle();if(t)throw console.error("❌ [ChildParentsList] Supabase error:",t),t;if(!n)throw new Error("Parent not found. The RLS policy may be blocking access.");f(n)}catch(n){const t=n instanceof Error?n.message:"Unknown error occurred";console.error("❌ [ChildParentsList] Error in fetchParent:",t),h({title:"Error loading parent",description:t,variant:"destructive"})}finally{m(!1)}},g=a=>{localStorage.setItem("selectedParentId",a),c("/child/dashboard")};return N||!j?e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(w,{}),e.jsx("div",{className:"p-4 sm:p-6",style:{paddingTop:"calc(1rem + 64px + var(--safe-area-inset-top) * 0.15)"},children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mb-6 sm:mb-8 mt-4 sm:mt-6",children:[e.jsx("div",{className:"h-9 w-48 bg-muted rounded animate-pulse mb-2"}),e.jsx("div",{className:"h-6 w-64 bg-muted rounded animate-pulse"})]}),e.jsx(p,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 sm:space-x-4 flex-1 min-w-0",children:[e.jsx("div",{className:"w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-muted animate-pulse flex-shrink-0"}),e.jsxs("div",{className:"space-y-2 min-w-0 flex-1",children:[e.jsx("div",{className:"h-7 w-32 bg-muted rounded animate-pulse"}),e.jsx("div",{className:"h-4 w-40 bg-muted rounded animate-pulse"})]})]}),e.jsx("div",{className:"h-10 w-full sm:w-24 bg-muted rounded animate-pulse"})]})})]})})]}):e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(w,{}),e.jsx(k,{role:"child",pageKey:"child_parents_list"}),e.jsx(O,{role:"child",pageKey:"child_parents_list"}),e.jsx("div",{className:"p-4 sm:p-6",style:{paddingTop:"calc(1rem + 64px + var(--safe-area-inset-top) * 0.15)"},children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mb-6 sm:mb-8 mt-4 sm:mt-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold",children:"Select Parent"}),e.jsx("p",{className:"text-muted-foreground mt-2 text-sm sm:text-base",children:"Choose a parent to contact"})]}),i?e.jsx(p,{"data-tour":"child-parents-list-card",className:"p-4 sm:p-6 cursor-pointer hover:shadow-lg transition-all",onClick:()=>g(i.id),children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 sm:space-x-4 flex-1 min-w-0",children:[e.jsx("div",{className:"w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-primary flex items-center justify-center text-white font-bold text-xl sm:text-2xl flex-shrink-0",children:i.name?.charAt(0).toUpperCase()||"P"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h3",{className:"text-xl sm:text-2xl font-semibold truncate",children:i.name||"Parent"}),e.jsx(_,{isOnline:x,size:"md",showPulse:x})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:x?"Online - Tap to call or message":"Offline - Tap to call or message"})]})]}),e.jsxs(E,{onClick:a=>{a.stopPropagation(),g(i.id)},className:"w-full sm:w-auto flex-shrink-0",children:[e.jsx(P,{className:"mr-2 h-4 w-4"}),"Contact"]})]})}):e.jsx(p,{className:"p-6",children:e.jsx("p",{className:"text-muted-foreground",children:"No parent found."})})]})})]})};export{z as default};

import{j as e,d as Ve,a8 as $e,a4 as Le,a9 as Q,aa as Oe,ab as Ue,ac as ze,r as i,ad as Be,ae as de,af as Ge,ag as me,ah as He,ai as ue,aj as We,ak as he,al as qe,N as Ke,am as Ye,an as fe,ao as Je,ap as xe,aq as pe,ar as ve,as as Qe,at as Xe,au as ge,av as Ne,aw as we,p as Ze,ax as Y,y as V,ay as es}from"./vendor-react-LQlp3yIU.js";import{C as D,B as y,c as g,A as ss,g as as,h as ts,i as rs,j as is,k as ns,l as os,m as ls,u as cs,s as h,a as c,d as w,b as M}from"./index-4JrybDns.js";import{countryCodeToFlag as ds}from"./ipGeolocation-Cm-ayuRY.js";import{f as J}from"./vendor-date-5vrp8xtd.js";import{I as je}from"./input-BR9I4F-8.js";import{D as ms,a as us,b as hs,c as fs,d as xs}from"./dialog-DmMNuzq2.js";import{N as ps}from"./Navigation-oN70GkMP.js";import{O as vs,H as gs}from"./OnboardingTour-DCxLRID0.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-DUaz7rji.js";import"./vendor-capacitor-DSxgEnoB.js";import"./vendor-supabase-Bq0a3XdW.js";import"./deviceTracking-lBUE_lfK.js";function Ns(a){const t=a.toLowerCase();if(t.includes("edg/")){const s=a.match(/edg\/([\d.]+)/i);return{name:"Edge",version:s?s[1]:null,fullName:s?`Edge ${s[1]}`:"Edge"}}if(t.includes("chrome/")&&!t.includes("edg/")){const s=a.match(/chrome\/([\d.]+)/i);return{name:"Chrome",version:s?s[1]:null,fullName:s?`Chrome ${s[1]}`:"Chrome"}}if(t.includes("safari/")&&!t.includes("chrome/")){const s=a.match(/version\/([\d.]+).*safari/i);return{name:"Safari",version:s?s[1]:null,fullName:s?`Safari ${s[1]}`:"Safari"}}if(t.includes("firefox/")){const s=a.match(/firefox\/([\d.]+)/i);return{name:"Firefox",version:s?s[1]:null,fullName:s?`Firefox ${s[1]}`:"Firefox"}}if(t.includes("opera/")||t.includes("opr/")){const s=a.match(/(?:opera|opr)\/([\d.]+)/i);return{name:"Opera",version:s?s[1]:null,fullName:s?`Opera ${s[1]}`:"Opera"}}if(t.includes("samsungbrowser/")){const s=a.match(/samsungbrowser\/([\d.]+)/i);return{name:"Samsung Internet",version:s?s[1]:null,fullName:s?`Samsung Internet ${s[1]}`:"Samsung Internet"}}if(t.includes("ucbrowser/")){const s=a.match(/ucbrowser\/([\d.]+)/i);return{name:"UC Browser",version:s?s[1]:null,fullName:s?`UC Browser ${s[1]}`:"UC Browser"}}return{name:"Unknown Browser",version:null,fullName:"Unknown Browser"}}function ws(a){const t=a.toLowerCase();if(t.includes("iphone")||t.includes("ipad")||t.includes("ipod")){const s=a.match(/os ([\d_]+)/i);if(s){const l=s[1].replace(/_/g,".");return{name:"iOS",version:l,fullName:`iOS ${l}`}}return{name:"iOS",version:null,fullName:"iOS"}}if(t.includes("android")){const s=a.match(/android ([\d.]+)/i);return s?{name:"Android",version:s[1],fullName:`Android ${s[1]}`}:{name:"Android",version:null,fullName:"Android"}}if(t.includes("windows")){if(t.includes("windows nt 10.0"))return{name:"Windows",version:"10/11",fullName:"Windows 10/11"};if(t.includes("windows nt 6.3"))return{name:"Windows",version:"8.1",fullName:"Windows 8.1"};if(t.includes("windows nt 6.2"))return{name:"Windows",version:"8",fullName:"Windows 8"};if(t.includes("windows nt 6.1"))return{name:"Windows",version:"7",fullName:"Windows 7"};const s=a.match(/windows nt ([\d.]+)/i);return s?{name:"Windows",version:s[1],fullName:`Windows NT ${s[1]}`}:{name:"Windows",version:null,fullName:"Windows"}}if(t.includes("mac os x")||t.includes("macintosh")){const s=a.match(/mac os x ([\d_]+)/i);if(s){const l=s[1].replace(/_/g,".");return{name:"macOS",version:l,fullName:`macOS ${l}`}}return{name:"macOS",version:null,fullName:"macOS"}}return t.includes("linux")?{name:"Linux",version:null,fullName:"Linux"}:{name:"Unknown OS",version:null,fullName:"Unknown OS"}}function js(a){const t=a;if(t.includes("iPhone")){const s=t.match(/iPhone(\d+,\d+)/i);return s?`iPhone ${s[1]}`:"iPhone"}if(t.includes("iPad")){const s=t.match(/iPad(\d+,\d+)/i);return s?`iPad ${s[1]}`:"iPad"}if(t.includes("Android")){const s=t.match(/android [\d.]+; ([^)]+)\)/i);if(s)return s[1].trim().replace(/^SM-/,"Samsung ").replace(/^LM-/,"LG ")}return t.includes("Macintosh")?"Mac":null}function ys(a){return a?{browser:Ns(a),os:ws(a),deviceModel:js(a)}:{browser:{name:"Unknown",version:null,fullName:"Unknown Browser"},os:{name:"Unknown",version:null,fullName:"Unknown OS"},deviceModel:null}}const bs=a=>{switch(a){case"mobile":return e.jsx(Q,{className:"h-5 w-5"});case"tablet":return e.jsx(Ue,{className:"h-5 w-5"});case"desktop":return e.jsx(Oe,{className:"h-5 w-5"});default:return e.jsx(Q,{className:"h-5 w-5"})}},Ds=a=>(Date.now()-new Date(a).getTime())/864e5>30,ne=({device:a,showActions:t=!0,showCreatedDate:s=!1,showRemovedDate:l=!1,onRename:f,onRemove:d})=>{const x=Ds(a.last_login_at),_=!a.is_active;return e.jsxs(D,{className:`p-4 space-y-3 ${_?"opacity-75 border-destructive/20 bg-muted/30":""} ${x?"border-yellow-200 dark:border-yellow-800":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"mt-1",children:bs(a.device_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold truncate",children:a.device_name}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:a.device_type})]})]}),_?e.jsx("span",{className:"text-xs text-destructive bg-destructive/10 px-2 py-1 rounded",children:"Removed"}):t?e.jsx("span",{className:"text-xs text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-950 px-2 py-1 rounded",children:"Active"}):null]}),x&&e.jsxs("div",{className:"flex items-center gap-2 text-yellow-700 dark:text-yellow-300 text-sm",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{children:"Not used recently"})]}),e.jsxs("div",{className:"space-y-1 text-sm",children:[s&&e.jsxs("p",{className:"text-muted-foreground",children:["Created:"," ",e.jsx("span",{className:"font-medium",children:J(new Date(a.created_at),{addSuffix:!0})})]}),a.child_name&&e.jsxs("p",{className:"text-muted-foreground",children:["Last used by: ",e.jsx("span",{className:"font-medium",children:a.child_name})]}),e.jsxs("p",{className:"text-muted-foreground",children:["Last login:"," ",e.jsx("span",{className:"font-medium",children:J(new Date(a.last_login_at),{addSuffix:!0})})]}),l&&_&&a.updated_at&&e.jsxs("p",{className:"text-muted-foreground",children:["Removed:"," ",e.jsx("span",{className:"font-medium",children:J(new Date(a.updated_at),{addSuffix:!0})})]}),a.country_code&&e.jsxs("p",{className:"text-muted-foreground",children:["Country:"," ",e.jsxs("span",{className:"font-medium text-base",children:[ds(a.country_code)||""," ",a.country_code]})]}),a.user_agent&&(()=>{const N=ys(a.user_agent);return e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-muted-foreground",children:["Browser: ",e.jsx("span",{className:"font-medium",children:N.browser.fullName})]}),e.jsxs("p",{className:"text-muted-foreground",children:["OS: ",e.jsx("span",{className:"font-medium",children:N.os.fullName})]}),N.deviceModel&&e.jsxs("p",{className:"text-muted-foreground",children:["Model: ",e.jsx("span",{className:"font-medium",children:N.deviceModel})]})]})})(),a.mac_address&&e.jsxs("p",{className:"text-muted-foreground",children:["MAC: ",e.jsx("span",{className:"font-mono text-xs",children:a.mac_address})]}),a.last_ip_address&&e.jsxs("p",{className:"text-muted-foreground",children:["IP: ",e.jsx("span",{className:"font-mono text-xs",children:a.last_ip_address})]}),a.last_location&&e.jsxs("p",{className:"text-muted-foreground",children:["Location Details: ",e.jsx("span",{className:"font-medium",children:a.last_location})]})]}),t&&a.is_active&&e.jsxs("div",{className:"flex gap-2 pt-2 border-t",children:[e.jsxs(y,{onClick:()=>{f&&f(a)},variant:"outline",size:"sm",className:"flex-1",children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),"Rename"]}),e.jsxs(y,{onClick:()=>{d&&d(a)},variant:"destructive",size:"sm",className:"flex-1",children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Remove"]})]})]})},oe=ze,le=Be,X=i.forwardRef(({className:a,children:t,...s},l)=>e.jsxs(de,{ref:l,className:g("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...s,children:[t,e.jsx(Ge,{asChild:!0,children:e.jsx(me,{className:"h-4 w-4 opacity-50"})})]}));X.displayName=de.displayName;const ye=i.forwardRef(({className:a,...t},s)=>e.jsx(fe,{ref:s,className:g("flex cursor-default items-center justify-center py-1",a),...t,children:e.jsx(Je,{className:"h-4 w-4"})}));ye.displayName=fe.displayName;const be=i.forwardRef(({className:a,...t},s)=>e.jsx(xe,{ref:s,className:g("flex cursor-default items-center justify-center py-1",a),...t,children:e.jsx(me,{className:"h-4 w-4"})}));be.displayName=xe.displayName;const Z=i.forwardRef(({className:a,children:t,position:s="popper",...l},f)=>e.jsx(He,{children:e.jsxs(ue,{ref:f,className:g("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:s,...l,children:[e.jsx(ye,{}),e.jsx(We,{className:g("p-1",s==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:t}),e.jsx(be,{})]})}));Z.displayName=ue.displayName;const Es=i.forwardRef(({className:a,...t},s)=>e.jsx(pe,{ref:s,className:g("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...t}));Es.displayName=pe.displayName;const E=i.forwardRef(({className:a,children:t,...s},l)=>e.jsxs(he,{ref:l,className:g("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",a),...s,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(qe,{children:e.jsx(Ke,{className:"h-4 w-4"})})}),e.jsx(Ye,{children:t})]}));E.displayName=he.displayName;const Cs=i.forwardRef(({className:a,...t},s)=>e.jsx(ve,{ref:s,className:g("-mx-1 my-1 h-px bg-muted",a),...t}));Cs.displayName=ve.displayName;const ce=({childFilter:a,deviceTypeFilter:t,onChildFilterChange:s,onDeviceTypeFilterChange:l,allChildren:f})=>e.jsxs("div",{className:"flex flex-1 gap-2",children:[e.jsxs(oe,{value:a,onValueChange:s,children:[e.jsxs(X,{className:"w-full sm:w-[180px]",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),e.jsx(le,{placeholder:"Filter by child"})]}),e.jsxs(Z,{children:[e.jsx(E,{value:"all",children:"All Children"}),f.map(d=>e.jsx(E,{value:d.id,children:d.name},d.id))]})]}),e.jsxs(oe,{value:t,onValueChange:l,children:[e.jsx(X,{className:"w-full sm:w-[180px]",children:e.jsx(le,{placeholder:"Filter by device type"})}),e.jsxs(Z,{children:[e.jsx(E,{value:"all",children:"All Types"}),e.jsx(E,{value:"mobile",children:"Mobile"}),e.jsx(E,{value:"tablet",children:"Tablet"}),e.jsx(E,{value:"desktop",children:"Desktop"}),e.jsx(E,{value:"other",children:"Other"})]})]})]}),_s=({currentPage:a,totalPages:t,onPageChange:s})=>t<=1?null:e.jsxs("div",{className:"flex items-center justify-center gap-2 pt-4",children:[e.jsx(y,{variant:"outline",size:"sm",onClick:()=>s(Math.max(1,a-1)),disabled:a===1,children:"Previous"}),e.jsxs("span",{className:"text-sm text-muted-foreground px-4",children:["Page ",a," of ",t]}),e.jsx(y,{variant:"outline",size:"sm",onClick:()=>s(Math.min(t,a+1)),disabled:a===t,children:"Next"})]}),Ts=({device:a,requireAuth:t,authPassword:s,onAuthPasswordChange:l,onOpenChange:f,onRemove:d})=>e.jsx(ss,{open:!!a,onOpenChange:x=>{x||f(!1)},children:e.jsxs(as,{children:[e.jsxs(ts,{children:[e.jsx(rs,{children:t?"Confirm Password":"Remove Device?"}),e.jsx(is,{children:t?e.jsxs(e.Fragment,{children:["For security, please enter your password to remove"," ",e.jsx("strong",{children:a?.device_name}),". This device will need to be re-authorized on next login."]}):e.jsxs(e.Fragment,{children:["Removing ",e.jsx("strong",{children:a?.device_name})," will revoke its access. You'll need to re-authorize this device the next time someone tries to log in from it. This action requires password confirmation."]})})]}),t&&e.jsx("div",{className:"space-y-2",children:e.jsx(je,{type:"password",placeholder:"Enter your password",value:s,onChange:x=>l(x.target.value),onKeyDown:x=>{x.key==="Enter"&&d()},autoFocus:!0})}),e.jsxs(ns,{children:[e.jsx(os,{children:"Cancel"}),e.jsx(ls,{onClick:async x=>{if(!t){x.preventDefault(),d();return}await d()},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:t?"Remove Device":"Continue"})]})]},t?"password":"confirm")}),Ss=({device:a,newDeviceName:t,onDeviceNameChange:s,onOpenChange:l,onRename:f})=>e.jsx(ms,{open:!!a,onOpenChange:d=>!d&&l(!1),children:e.jsxs(us,{children:[e.jsxs(hs,{children:[e.jsx(fs,{children:"Rename Device"}),e.jsx(xs,{children:"Give this device a friendly name to easily identify it."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(je,{placeholder:"Device name",value:t,onChange:d=>s(d.target.value),onKeyDown:d=>{d.key==="Enter"&&t.trim()&&f()},autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(y,{variant:"outline",onClick:()=>l(!1),children:"Cancel"}),e.jsx(y,{onClick:f,disabled:!t.trim(),children:"Save"})]})]})]})}),Ms=Xe,De=i.forwardRef(({className:a,...t},s)=>e.jsx(ge,{ref:s,className:g("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",a),...t}));De.displayName=ge.displayName;const ee=i.forwardRef(({className:a,...t},s)=>e.jsx(Ne,{ref:s,className:g("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",a),...t}));ee.displayName=Ne.displayName;const se=i.forwardRef(({className:a,...t},s)=>e.jsx(we,{ref:s,className:g("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...t}));se.displayName=we.displayName;const Ws=()=>{const[a,t]=i.useState([]),[s,l]=i.useState([]),[f,d]=i.useState([]),[x,_]=i.useState(!0),[N,ae]=i.useState(!1),[j,Ee]=i.useState("active"),[v,$]=i.useState(null),[L,O]=i.useState(null),[A,U]=i.useState(""),[ks,As]=i.useState(!1),[z,B]=i.useState(!1),[G,R]=i.useState(""),[I,Ce]=i.useState("all"),[F,_e]=i.useState("all"),[H,te]=i.useState(1),[Te,re]=i.useState(!1),W=10,[q,Se]=i.useState("all"),[K,Me]=i.useState("all"),{toast:p}=cs(),T=i.useRef(null),S=i.useRef(null),C=i.useCallback(async()=>{try{_(!0);const{data:{user:r}}=await h.auth.getUser();if(!r)return;const{data:n,error:o}=await h.from("devices").select(`
          *,
          children:last_used_child_id (
            name
          )
        `).eq("parent_id",r.id).eq("is_active",!0).order("last_login_at",{ascending:!1});if(o&&(o.code==="42P01"||o.message?.includes("does not exist"))){p({title:"Database Migration Required",description:"The devices table doesn't exist yet. Please run the migration: supabase/migrations/20250122000000_add_device_management.sql",variant:"destructive",duration:1e4}),c.error("âŒ [DEVICE MANAGEMENT] Migration not run:",w(o));return}if(o)throw o;const u=(n||[]).map(m=>({...m,child_name:m.children?.name||null}));c.log("ðŸ“‹ [DEVICE MANAGEMENT] Fetched devices:",{count:u.length,devices:u.map(m=>({id:m.id,name:m.device_name,isActive:m.is_active}))}),t(u)}catch(r){c.error("Error fetching devices:",w(r)),p({title:"Error",description:"Failed to load devices. Please try again.",variant:"destructive"})}finally{_(!1)}},[p]),ie=i.useCallback(async()=>{try{const{data:{user:r}}=await h.auth.getUser();if(!r)return;const{data:n,error:o}=await h.from("children").select("id, name").order("name",{ascending:!0});if(o)throw o;d(n||[])}catch(r){c.error("Error fetching children:",w(r))}},[]),b=i.useCallback(async()=>{try{ae(!0);const{data:{user:r}}=await h.auth.getUser();if(!r)return;const{data:n,error:o}=await h.from("devices").select(`
          *,
          children:last_used_child_id (
            name
          )
        `).eq("parent_id",r.id).order("updated_at",{ascending:!1});if(o)throw o;const u=(n||[]).map(m=>({...m,child_name:m.children?.name||null}));c.log("ðŸ“‹ [DEVICE MANAGEMENT] Fetched device history:",{count:u.length,active:u.filter(m=>m.is_active).length,inactive:u.filter(m=>!m.is_active).length}),l(u)}catch(r){c.error("Error fetching device history:",w(r)),p({title:"Error",description:"Failed to load device history. Please try again.",variant:"destructive"})}finally{ae(!1)}},[p]);i.useEffect(()=>(C(),ie(),(async()=>{const{data:{user:n}}=await h.auth.getUser();n&&(T.current&&await h.removeChannel(T.current),T.current=h.channel("device-management-updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"devices",filter:`parent_id=eq.${n.id}`},o=>{c.log("ðŸ“± [DEVICE MANAGEMENT] New device added:",M(o.new)),C(),j==="history"&&b()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"devices",filter:`parent_id=eq.${n.id}`},o=>{c.log("ðŸ“± [DEVICE MANAGEMENT] Device updated:",M({deviceId:o.new.id,deviceName:o.new.device_name,isActive:o.new.is_active,oldIsActive:o.old?.is_active})),C(),j==="history"&&b()}).subscribe((o,u)=>{u&&c.error("âŒ [DEVICE MANAGEMENT] Subscription error:",w(u))}))})(),()=>{T.current&&(h.removeChannel(T.current),T.current=null)}),[C,b,ie,j]),i.useEffect(()=>{j==="history"&&s.length===0&&!N&&b()},[j,b,s.length,N]),i.useEffect(()=>{if(j!=="history"){re(!1);return}const r=()=>{if(S.current){const o=S.current.scrollTop;re(o>400)}},n=S.current;if(n)return n.addEventListener("scroll",r),r(),()=>n.removeEventListener("scroll",r)},[j]);const k=s.filter(r=>!(I!=="all"&&r.last_used_child_id!==I||F!=="all"&&r.device_type!==F)),ke=Math.ceil(k.length/W),Ae=k.slice((H-1)*W,H*W);i.useEffect(()=>{te(1)},[I,F]);const Re=()=>{S.current&&S.current.scrollTo({top:0,behavior:"smooth"})},P=a.filter(r=>!(q!=="all"&&r.last_used_child_id!==q||K!=="all"&&r.device_type!==K)),Ie=async()=>{if(v){if(c.log("ðŸ” [DEVICE MANAGEMENT] Remove device initiated:",M({deviceId:v.id,deviceName:v.device_name,requireAuth:z})),!z){const r=v.child_name?` (used by ${v.child_name})`:"";p({title:"âš ï¸ Warning: Device Removal",description:`You are about to remove "${v.device_name}"${r}. This action requires password confirmation and cannot be undone.`,variant:"destructive",duration:5e3}),setTimeout(()=>{B(!0)},100);return}if(!G.trim()){p({title:"Password Required",description:"Please enter your password to confirm device removal.",variant:"destructive"});return}try{const{data:{user:r},error:n}=await h.auth.getUser();if(n||!r)throw c.error("âŒ [DEVICE MANAGEMENT] User auth error:",w(n)),new Error("Not authenticated");c.log("ðŸ” [DEVICE MANAGEMENT] Verifying password for user:",M({email:r.email}));const{error:o}=await h.auth.signInWithPassword({email:r.email||"",password:G});if(o){c.error("âŒ [DEVICE MANAGEMENT] Password verification failed:",w(o)),p({title:"Authentication Failed",description:"Incorrect password. Please try again.",variant:"destructive"}),R("");return}c.log("âœ… [DEVICE MANAGEMENT] Password verified, calling revoke_device RPC");const{data:u,error:m}=await h.rpc("revoke_device",{p_device_id:v.id,p_parent_id:r.id});if(c.log("ðŸ“¡ [DEVICE MANAGEMENT] RPC response:",M({revokeResult:u,error:m})),m)throw c.error("âŒ [DEVICE MANAGEMENT] RPC error:",w(m)),m;if(u===!1)throw c.warn("âš ï¸ [DEVICE MANAGEMENT] Device not found or permission denied"),new Error("Device not found or you don't have permission to remove it");c.log("âœ… [DEVICE MANAGEMENT] Device revoked successfully:",M({deviceId:v.id,deviceName:v.device_name,revokeResult:u}));const Pe=v.device_name;$(null),B(!1),R(""),p({title:"âœ… Device Removed Successfully",description:`${Pe} has been removed and will need to be re-authorized on next login.`,variant:"success",duration:5e3}),c.log("ðŸ”„ [DEVICE MANAGEMENT] Refreshing devices list"),await C(),j==="history"&&await b()}catch(r){c.error("âŒ [DEVICE MANAGEMENT] Error removing device:",w(r));const n=r instanceof Error?r.message:"Failed to remove device. Please try again.";p({title:"Error",description:n,variant:"destructive"})}}},Fe=async()=>{if(!(!L||!A.trim()))try{const{data:{user:r}}=await h.auth.getUser();if(!r)throw new Error("Not authenticated");const{error:n}=await h.from("devices").update({device_name:A.trim()}).eq("id",L.id).eq("parent_id",r.id);if(n)throw n;p({title:"Device Renamed",description:`Device renamed to "${A.trim()}"`}),O(null),U(""),C()}catch(r){c.error("Error renaming device:",w(r));const n=r instanceof Error?r.message:"Failed to rename device. Please try again.";p({title:"Error",description:n,variant:"destructive"})}};return e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(ps,{}),e.jsx(vs,{role:"parent",pageKey:"parent_devices"}),e.jsx(gs,{role:"parent",pageKey:"parent_devices"}),e.jsx("div",{className:"px-4 pb-4",style:{paddingTop:"calc(0.5rem + 64px + var(--safe-area-inset-top) * 0.15)"},children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"mt-2",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Device Management"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"View and manage all devices authorized to access your family account"})]}),e.jsx(D,{className:"p-4 bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ze,{className:"h-5 w-5 text-blue-700 dark:text-blue-300 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-1",children:"About Device Management"}),e.jsx("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:"This page shows all devices that have been used to access your family account. You can remove devices you no longer use or recognize. Removing a device will require re-authorization the next time someone tries to log in from that device."})]})]})}),e.jsxs(Ms,{value:j,onValueChange:r=>{Ee(r),r==="history"&&s.length===0&&b()},children:[e.jsxs(De,{className:"grid w-full grid-cols-2",children:[e.jsx(ee,{value:"active",children:"Active Devices"}),e.jsxs(ee,{value:"history",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"History"]})]}),e.jsxs(se,{value:"active",className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(y,{onClick:C,variant:"outline",size:"sm",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsx(ce,{childFilter:q,deviceTypeFilter:K,onChildFilterChange:Se,onDeviceTypeFilterChange:Me,allChildren:f})]}),P.length!==a.length&&a.length>0&&e.jsx(D,{className:"p-3 bg-muted/50 border-muted",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",P.length," of ",a.length," ","active devices"]})}),e.jsx("div",{"data-tour":"parent-devices-list",children:x?e.jsxs(D,{className:"p-12 text-center",children:[e.jsx(V,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading devices..."})]}):P.length===0?e.jsxs(D,{className:"p-12 text-center",children:[e.jsx(Q,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:a.length===0?"No devices found":"No devices match your filters"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.length===0?"Devices will appear here after they're used to log in":"Try adjusting your filters"})]}):e.jsx("div",{className:"grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",children:P.map(r=>e.jsx(ne,{device:r,showActions:!0,onRename:n=>{O(n),U(n.device_name)},onRemove:n=>$(n)},r.id))})})]}),e.jsxs(se,{value:"history",className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(y,{onClick:b,variant:"outline",size:"sm",disabled:N,children:[e.jsx(V,{className:`h-4 w-4 mr-2 ${N?"animate-spin":""}`}),"Refresh History"]}),e.jsx(ce,{childFilter:I,deviceTypeFilter:F,onChildFilterChange:Ce,onDeviceTypeFilterChange:_e,allChildren:f})]}),e.jsx(D,{className:"p-4 bg-muted/50 border-muted",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Y,{className:"h-5 w-5 text-muted-foreground mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground mb-1",children:"Device History"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["This is a read-only history of all devices that have accessed your account, including removed devices. This history cannot be modified and serves as a security audit trail.",k.length!==s.length&&e.jsxs("span",{className:"block mt-1 font-medium",children:["Showing ",k.length," of"," ",s.length," devices"]})]})]})]})}),e.jsx("div",{ref:S,className:"max-h-[calc(100vh-400px)] overflow-y-auto space-y-4",style:{scrollBehavior:"smooth"},children:N?e.jsxs(D,{className:"p-12 text-center",children:[e.jsx(V,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading device history..."})]}):k.length===0?e.jsxs(D,{className:"p-12 text-center",children:[e.jsx(Y,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"No devices found"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.length===0?"Device history will appear here as devices are used or removed":"Try adjusting your filters"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",children:Ae.map(r=>e.jsx(ne,{device:r,showActions:!1,showCreatedDate:!0,showRemovedDate:!0},r.id))}),e.jsx(_s,{currentPage:H,totalPages:ke,onPageChange:te})]})}),Te&&e.jsxs(y,{onClick:Re,className:"fixed bottom-6 right-6 rounded-full shadow-lg z-50 h-12 w-12 p-0",size:"icon",variant:"default",children:[e.jsx(es,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"Back to top"})]})]})]})]})}),e.jsx(Ts,{device:v,requireAuth:z,authPassword:G,onAuthPasswordChange:R,onOpenChange:r=>{r||($(null),B(!1),R(""))},onRemove:Ie}),e.jsx(Ss,{device:L,newDeviceName:A,onDeviceNameChange:U,onOpenChange:r=>!r&&O(null),onRename:Fe})]})};export{Ws as default};

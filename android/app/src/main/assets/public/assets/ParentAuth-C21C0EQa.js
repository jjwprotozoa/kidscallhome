const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deviceTracking-lBUE_lfK.js","assets/vendor-capacitor-DSxgEnoB.js"])))=>i.map(i=>d[i]);
import{_ as Ce}from"./vendor-capacitor-DSxgEnoB.js";import{r as d,j as r,L as N,d as _,G as A,w as Ie,p as Te,I as X,J as qe,K as De,u as Ee,N as Re,Y as Le}from"./vendor-react-mDIoga_b.js";import{I as L}from"./input-UTyCM2Df.js";import{c as H,s as S,a as J,u as Me,C as Ue,B as Be,d as E}from"./index-BdmHsoQZ.js";import{L as ze}from"./label-CU-FEe3V.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-BA4qpukX.js";import"./vendor-supabase-DQP4RkUL.js";function R(e){return typeof e!="string"?String(e):e.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").trim()}function C(e){return!e||typeof e!="string"?!1:/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.trim())}const Fe=["password","123456","12345678","123456789","1234567890","qwerty","abc123","password1","password123","admin","letmein","welcome","monkey","1234567","sunshine","princess","qwerty123","solo","passw0rd","starwars","abcdef","qwertyuiop","asdfgh","zxcvbn","123qwe","qwerty12","1qaz2wsx","qazwsxedc","1q2w3e4r","qwe123","1234qwer","qwer1234","abcd1234","1234abcd","qwerty1","Password1","Welcome123","Admin123","Test1234","Password123","Passw0rd","P@ssw0rd","P@ssword1","Pass1234","Admin1234","Welcome1","Test123","Password12","Admin1","Welcome12","iloveyou","trustno1","dragon","master","hello","freedom","whatever","qazwsx","michael","football","baseball","shadow","superman","qwertyui","michael1","jordan23","harley","hunter","buster","thomas","tigger","robert","soccer","batman","taylor","killer","hockey","jordan","michelle","charlie","andrew","joshua","matthew","jessica","daniel","anthony","jennifer","joshua1","liverpool","chelsea","james123","robert1","michael1","william1","david1","richard1","joseph1","thomas1","charles1","christopher1","daniel1","matthew1","anthony1","mark1","donald1","steven1","paul1","andrew1","joshua1","kenneth1","kevin1","brian1","george1","timothy1","ronald1","jason1","edward1","jeffrey1","ryan1","jacob1","gary1","nicholas1","eric1","jonathan1","stephen1","larry1","justin1","scott1","brandon1","benjamin1","samuel1","frank1","gregory1","raymond1","alexander1","patrick1","jack1","dennis1","jerry1","tyler1","aaron1","jose1","henry1","adam1","douglas1","nathan1","zachary1","kyle1","noah1","alan1","arsenal","manchester","liverpool","chelsea","barcelona","real","madrid","juventus","milan","bayern","dortmund","psg","atletico","valencia","sevilla","111111","222222","333333","444444","555555","666666","777777","888888","999999","000000","aaaaaa","bbbbbb","cccccc","dddddd","eeeeee","ffffff","gggggg","hhhhhh","iiiiii","jjjjjj","password2020","password2021","password2022","password2023","password2024","welcome2020","welcome2021","welcome2022","welcome2023","welcome2024","admin2020","admin2021","admin2022","admin2023","admin2024","1q2w3e4r","qwertyui","asdfghjk","zxcvbnm","qwerty1","asdf1234","zxcv1234","qwer1234","asdfqwer","qwertyuiop","p@ssw0rd","p@ssword","p@55w0rd","p@55word","p@ssw0rd1","w3lc0m3","w3lcome","welc0me","welcome1","welc0me1","adm1n","admin1","admin1","adm1n1","admin123","123abc","abc123","123abc123","abc123abc","1234abcd","abcd1234","12345a","a12345","12345ab","ab12345","iloveyou1","iloveyou123","trustno1","trustno11","trustno123","letmein1","letmein123","welcome1","welcome123","hello123","changeme","changeme1","changeme123","default","default1","newpassword","newpassword1","newpassword123","temp","temp123","test","test1","test123","testing","testing123","ninja","mustang","access","flower","55555","michael","shadow","master","jennifer","jordan","superman","harley","hunter","buster","soccer","tigger","batman","thomas","hockey","killer","ranger","daniel","hannah","maggie","jessie","charlie","summer","winter","spring","autumn","qwerty1","qwerty12","qwerty123","qwerty1234","qwertyui","asdfgh1","asdfgh12","zxcvbn1","zxcvbn12","123456a","a123456","123456ab","ab123456","123456abc","abc123456"];function Oe(e){const s=[];if(!e||typeof e!="string")return{valid:!1,errors:["Password is required"]};e.length<8&&s.push("Password must be at least 8 characters"),e.length>128&&s.push("Password must be less than 128 characters");const t=/[A-Z]/.test(e),a=/[a-z]/.test(e),i=/[0-9]/.test(e),n=/[[\]!@#$%^&*()_+\-={};':"|<>?,./`~]/.test(e);return t||s.push("Password must contain at least one uppercase letter"),a||s.push("Password must contain at least one lowercase letter"),i||s.push("Password must contain at least one digit"),n||s.push("Password must contain at least one symbol (!@#$%^&*()_+-=[]{};':\"|<>?,./`~)"),Fe.includes(e.toLowerCase())&&s.push("Password is too common. Please choose a more unique password."),{valid:s.length===0,errors:s}}function $e(e){return!e||typeof e!="string"?!1:/^[A-Z0-9]{3,6}-[a-z]+-\d{1,2}$/i.test(e.trim())}function We(e){const s={},t={};if(e.email!==void 0){const a=R(e.email);t.email=a,C(a)||(s.email=["Invalid email format"])}if(e.password!==void 0){const a=e.password;t.password=a;const i=Oe(a);i.valid||(s.password=i.errors)}if(e.name!==void 0){const a=R(e.name);t.name=a,a.length<1&&(s.name=["Name is required"]),a.length>100&&(s.name=["Name must be less than 100 characters"])}if(e.code!==void 0){const a=R(e.code);t.code=a,$e(a)||(s.code=["Invalid login code format"])}return{valid:Object.keys(s).length===0,errors:s,sanitized:t}}async function Ke(e){const t=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-1",t);return Array.from(new Uint8Array(a)).map(n=>n.toString(16).padStart(2,"0")).join("").toUpperCase()}async function Ve(e){try{const s=await Ke(e),t=s.substring(0,5),a=s.substring(5),i=await fetch(`https://api.pwnedpasswords.com/range/${t}`,{method:"GET",headers:{"User-Agent":"KidsCallHome-PasswordChecker/1.0"}});if(!i.ok)return console.warn("HaveIBeenPwned API unavailable, skipping breach check"),!1;const o=(await i.text()).split(/\r?\n/);for(const c of o){const l=c.trim();if(!l)continue;const[h]=l.split(":");if(h&&h.toUpperCase()===a)return!0}return!1}catch(s){return console.warn("Error checking password breach status:",s),!1}}const Ge=["password","123456","12345678","123456789","1234567890","qwerty","abc123","password1","password123","admin","letmein","welcome","monkey","1234567","sunshine","princess","qwerty123","solo","passw0rd","starwars","abcdef","qwertyuiop","asdfgh","zxcvbn","123qwe","qwerty12","1qaz2wsx","qazwsxedc","1q2w3e4r","qwe123","1234qwer","qwer1234","abcd1234","1234abcd","qwerty1","Password1","Welcome123","Admin123","Test1234","Password123","Passw0rd","P@ssw0rd","P@ssword1","Pass1234","Admin1234","Welcome1","Test123","Password12","Admin1","Welcome12","iloveyou","trustno1","dragon","master","hello","freedom","whatever","qazwsx","michael","football","baseball","shadow","superman","qwertyui","michael1","jordan23","harley","hunter","buster","thomas","tigger","robert","soccer","batman","taylor","killer","hockey","jordan","michelle","charlie","andrew","joshua","matthew","jessica","daniel","anthony","jennifer","joshua1","liverpool","chelsea","james123","robert1","michael1","william1","david1","richard1","joseph1","thomas1","charles1","christopher1","daniel1","matthew1","anthony1","mark1","donald1","steven1","paul1","andrew1","joshua1","kenneth1","kevin1","brian1","george1","timothy1","ronald1","jason1","edward1","jeffrey1","ryan1","jacob1","gary1","nicholas1","eric1","jonathan1","stephen1","larry1","justin1","scott1","brandon1","benjamin1","samuel1","frank1","gregory1","raymond1","alexander1","patrick1","jack1","dennis1","jerry1","tyler1","aaron1","jose1","henry1","adam1","douglas1","nathan1","zachary1","kyle1","noah1","alan1","arsenal","manchester","liverpool","chelsea","barcelona","real","madrid","juventus","milan","bayern","dortmund","psg","atletico","valencia","sevilla","111111","222222","333333","444444","555555","666666","777777","888888","999999","000000","aaaaaa","bbbbbb","cccccc","dddddd","eeeeee","ffffff","gggggg","hhhhhh","iiiiii","jjjjjj","password2020","password2021","password2022","password2023","password2024","welcome2020","welcome2021","welcome2022","welcome2023","welcome2024","admin2020","admin2021","admin2022","admin2023","admin2024","1q2w3e4r","qwertyui","asdfghjk","zxcvbnm","qwerty1","asdf1234","zxcv1234","qwer1234","asdfqwer","qwertyuiop","p@ssw0rd","p@ssword","p@55w0rd","p@55word","p@ssw0rd1","w3lc0m3","w3lcome","welc0me","welcome1","welc0me1","adm1n","admin1","admin1","adm1n1","admin123","123abc","abc123","123abc123","abc123abc","1234abcd","abcd1234","12345a","a12345","12345ab","ab12345","iloveyou1","iloveyou123","trustno1","trustno11","trustno123","letmein1","letmein123","welcome1","welcome123","hello123","changeme","changeme1","changeme123","default","default1","newpassword","newpassword1","newpassword123","temp","temp123","test","test1","test123","testing","testing123","ninja","mustang","access","flower","55555","michael","shadow","master","jennifer","jordan","superman","harley","hunter","buster","soccer","tigger","batman","thomas","hockey","killer","ranger","daniel","hannah","maggie","jessie","charlie","summer","winter","spring","autumn","qwerty1","qwerty12","qwerty123","qwerty1234","qwertyui","asdfgh1","asdfgh12","zxcvbn1","zxcvbn12","123456a","a123456","123456ab","ab123456","123456abc","abc123456"];async function Y(e,s=!0){const t=[];if(!e||typeof e!="string")return{valid:!1,errors:["Password is required"]};e.length<8&&t.push("Password must be at least 8 characters"),e.length>128&&t.push("Password must be less than 128 characters");const a=/[A-Z]/.test(e),i=/[a-z]/.test(e),n=/[0-9]/.test(e),o=/[[\]!@#$%^&*()_+\-={};':"|<>?,./`~]/.test(e);if(a||t.push("Password must contain at least one uppercase letter"),i||t.push("Password must contain at least one lowercase letter"),n||t.push("Password must contain at least one digit"),o||t.push("Password must contain at least one symbol (!@#$%^&*()_+-=[]{};':\"|<>?,./`~)"),Ge.includes(e.toLowerCase())&&t.push("Password is too common. Please choose a more unique password."),t.length>0)return{valid:!1,errors:t};if(s)try{if(await Ve(e))return t.push("This password has been found in data breaches. Please choose a different password."),{valid:!1,errors:t,isPwned:!0}}catch(c){console.warn("Breach check failed, allowing password:",c)}return{valid:t.length===0,errors:t,isPwned:!1}}async function He(e,s){try{if(!e||typeof e!="string")return{isPwned:!1};const t=encodeURIComponent(e.trim().toLowerCase()),a={"User-Agent":"KidsCallHome-EmailChecker/1.0"};let i;try{i=await fetch(`https://haveibeenpwned.com/api/v3/breachedaccount/${t}?truncateResponse=false`,{method:"GET",headers:a})}catch(o){if(o instanceof TypeError)return{isPwned:!1};throw o}if(i.status===404)return{isPwned:!1};if(i.status===429)return console.warn("HaveIBeenPwned rate limit reached - allowing signup to proceed"),{isPwned:!1};if(i.status===400)return{isPwned:!1};if(!i.ok)return console.warn("HaveIBeenPwned API error:",i.status,i.statusText,"- allowing signup"),{isPwned:!1};const n=await i.json();return Array.isArray(n)&&n.length>0?{isPwned:!0,breachCount:n.length,breaches:n.map(o=>({Name:o.Name||"Unknown",BreachDate:o.BreachDate||"Unknown",AddedDate:o.AddedDate||"Unknown"}))}:{isPwned:!1}}catch{return{isPwned:!1}}}const Je=(e,s)=>{const[t,a]=d.useState(!1),[i,n]=d.useState(null);return d.useEffect(()=>{if(s||!e||!C(e)){n(null);return}const o=setTimeout(async()=>{a(!0);try{const l=await He(e,void 0);a(!1),l.isPwned?n({isPwned:!0,breachCount:l.breachCount,breaches:l.breaches}):n({isPwned:!1})}catch{a(!1),n(null)}},2e3);return()=>clearTimeout(o)},[e,s]),{checkingEmailBreach:t,emailBreachInfo:i}},Ye=({email:e,onChange:s,isLogin:t,required:a=!0})=>{const{checkingEmailBreach:i,emailBreachInfo:n}=Je(e,t);return r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Email"}),r.jsxs("div",{className:"relative",children:[r.jsx(L,{type:"email",placeholder:"parent@email.com",value:e,onChange:o=>s(o.target.value),required:a,autoComplete:t?"username":"email"}),!t&&r.jsxs("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:[i&&r.jsx(N,{className:"h-4 w-4 animate-spin text-muted-foreground"}),!i&&n?.isPwned&&r.jsx(_,{className:"h-4 w-4 text-amber-500"}),!i&&n?.isPwned===!1&&C(e)&&r.jsx(A,{className:"h-4 w-4 text-green-500"})]})]}),!t&&i&&r.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[r.jsx(N,{className:"h-3 w-3 animate-spin"}),"Checking email security..."]}),!t&&n?.isPwned&&r.jsxs("div",{className:"text-xs text-amber-600 dark:text-amber-400 space-y-1",children:[r.jsxs("p",{className:"flex items-start gap-1",children:[r.jsx(_,{className:"h-3 w-3 mt-0.5 flex-shrink-0"}),r.jsxs("span",{className:"font-medium",children:["This email was found in"," ",n.breachCount||"multiple"," data breach(es)."]})]}),r.jsxs("p",{className:"pl-4 text-muted-foreground",children:["Your email was exposed in:"," ",n.breaches?.slice(0,3).map(o=>o.Name).join(", "),n.breachCount&&n.breachCount>3?` and ${n.breachCount-3} more`:""]}),r.jsxs("p",{className:"pl-4 text-muted-foreground",children:[r.jsx("strong",{children:"Security tip:"})," Use a strong, unique password and consider enabling two-factor authentication if available."]})]}),!t&&n?.isPwned===!1&&C(e)&&r.jsxs("p",{className:"text-xs text-green-600 dark:text-green-400 flex items-center gap-1",children:[r.jsx(A,{className:"h-3 w-3"}),"Email not found in known breaches"]})]})},Ze=({lockoutInfo:e})=>e.locked&&e.lockedUntil?r.jsxs("div",{className:"flex items-start gap-2 p-3 bg-destructive/10 border border-destructive/20 rounded-md",children:[r.jsx(Ie,{className:"h-5 w-5 text-destructive mt-0.5"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-sm font-medium text-destructive",children:"Account Locked"}),r.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Too many failed login attempts. Please try again in"," ",Math.ceil((e.lockedUntil-Date.now())/6e4)," ","minute(s)."]})]})]}):!e.locked&&e.attemptsRemaining!==void 0&&e.attemptsRemaining<5?r.jsxs("div",{className:"flex items-start gap-2 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-md",children:[r.jsx(Te,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-sm font-medium text-yellow-700",children:"Security Notice"}),r.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[e.attemptsRemaining," attempt(s) remaining before account lockout."]})]})]}):null,ee=(e,s)=>{const[t,a]=d.useState(!1),[i,n]=d.useState(null);return d.useEffect(()=>{if(s||!e||e.length<8){n(null);return}const l=setTimeout(async()=>{a(!0),n("checking");try{const h=await Y(e);a(!1),h.isPwned?n("breached"):h.valid?n("safe"):n(null)}catch{a(!1),n(null)}},800);return()=>clearTimeout(l)},[e,s]),{checkingBreach:t,breachStatus:i,resetStatus:()=>{n(null)},performFinalCheck:async l=>{a(!0),n("checking");try{const h=await Y(l);return a(!1),h.valid?(n("safe"),!0):(h.isPwned&&n("breached"),!1)}catch{return a(!1),n(null),!0}}}},Qe=({password:e,onChange:s,isLogin:t,required:a=!0,minLength:i=6,autoComplete:n})=>{const o=d.useRef(null),{checkingBreach:c,breachStatus:l,resetStatus:h}=ee(e,t),g=w=>{s(w),t||h()};return r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Password"}),r.jsxs("div",{className:"relative",children:[r.jsx(L,{ref:o,type:"password",placeholder:"••••••••",value:e,onChange:w=>g(w.target.value),required:a,minLength:i,autoComplete:n,className:!t&&l==="breached"?"pr-10 border-destructive focus-visible:ring-destructive":!t&&l==="safe"?"pr-10 border-green-500 focus-visible:ring-green-500":""}),!t&&r.jsxs("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:[c&&r.jsx(N,{className:"h-4 w-4 animate-spin text-muted-foreground"}),!c&&l==="breached"&&r.jsx(_,{className:"h-4 w-4 text-destructive"}),!c&&l==="safe"&&e.length>=8&&r.jsx(A,{className:"h-4 w-4 text-green-500"})]})]}),!t&&c&&r.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[r.jsx(N,{className:"h-3 w-3 animate-spin"}),"Checking password security..."]}),!t&&l==="breached"&&r.jsxs("p",{className:"text-xs text-destructive flex items-start gap-1",children:[r.jsx(_,{className:"h-3 w-3 mt-0.5 flex-shrink-0"}),"This password has been compromised in data breaches. Choose a unique password that you haven't used elsewhere."]}),!t&&l==="safe"&&e.length>=8&&r.jsxs("p",{className:"text-xs text-green-600 dark:text-green-400 flex items-center gap-1",children:[r.jsx(A,{className:"h-3 w-3"}),"Password looks secure!"]})]})},te=d.forwardRef(({className:e,...s},t)=>r.jsx(X,{ref:t,className:H("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),...s,children:r.jsx(qe,{className:H("flex items-center justify-center text-current"),children:r.jsx(De,{className:"h-4 w-4"})})}));te.displayName=X.displayName;const se="kch_rate_limits",ae="kch_failed_logins",I={login:{maxAttempts:5,windowMs:60*1e3,lockoutDurationMs:900*1e3},childLogin:{maxAttempts:10,windowMs:60*1e3,lockoutDurationMs:300*1e3},apiCall:{maxAttempts:100,windowMs:60*1e3}};function M(){try{const e=localStorage.getItem(se);return e?JSON.parse(e):{}}catch{return{}}}function U(e){try{localStorage.setItem(se,JSON.stringify(e))}catch{}}function B(){try{const e=localStorage.getItem(ae);return e?JSON.parse(e):{}}catch{return{}}}function ne(e){try{localStorage.setItem(ae,JSON.stringify(e))}catch{}}function Xe(e,s="apiCall"){const t=I[s],a=M(),i=Date.now(),n=a[e];if(n?.lockedUntil&&n.lockedUntil>i)return{allowed:!1,lockedUntil:n.lockedUntil};if(!n||n.resetAt<i)return{allowed:!0};if(n.count>=t.maxAttempts){if(s==="login"&&t.lockoutDurationMs){const o=i+t.lockoutDurationMs;return a[e]={count:n.count,resetAt:n.resetAt,lockedUntil:o},U(a),{allowed:!1,lockedUntil:o}}return{allowed:!1,resetAt:n.resetAt}}return{allowed:!0}}function et(e,s="apiCall"){const t=I[s],a=M(),i=Date.now(),n=a[e];!n||n.resetAt<i?a[e]={count:1,resetAt:i+t.windowMs}:a[e]={...n,count:n.count+1},U(a)}function tt(e){const s=B(),t=Date.now(),a=I.login,i=s[e];let n=1,o;return!i||t-i.lastAttempt>a.windowMs?n=1:n=i.attempts+1,n>=a.maxAttempts&&a.lockoutDurationMs&&(o=t+a.lockoutDurationMs),s[e]={email:e,attempts:n,lastAttempt:t,lockedUntil:o},ne(s),{attempts:n,locked:!!o,lockedUntil:o}}function st(e){const s=B();delete s[e],ne(s);const t=M();delete t[`login:${e}`],U(t)}function at(e){const t=B()[e],a=Date.now(),i=I.login;if(!t)return{locked:!1};if(t.lockedUntil&&t.lockedUntil>a)return{locked:!0,lockedUntil:t.lockedUntil,attemptsRemaining:0};if(a-t.lastAttempt>i.windowMs)return{locked:!1};const n=i.maxAttempts-t.attempts;return{locked:!1,attemptsRemaining:Math.max(0,n)}}function nt(e,s){return`${s}:${e}`}const rt=(e,s)=>{const[t,a]=d.useState(null),[i,n]=d.useState(!1);return d.useEffect(()=>{if(s&&e){const c=at(e);a(c),c.attemptsRemaining!==void 0&&c.attemptsRemaining<=3&&n(!0)}else a(null),n(!1)},[e,s]),{lockoutInfo:t,showCaptcha:i,setShowCaptcha:n,updateLockoutInfo:c=>{a(c)}}};function y(e,s={}){const t={type:e,userId:s.userId,email:s.email,ip:void 0,userAgent:navigator.userAgent,timestamp:Date.now(),metadata:s.metadata,severity:s.severity||ct(e)};try{const a=ot();a.push(t),a.length>100&&a.shift(),localStorage.setItem("kch_audit_logs",JSON.stringify(a))}catch{}it(t).catch(()=>{})}async function it(e){try{const s=await S.rpc("log_audit_event",{p_event_type:e.type,p_user_id:e.userId||null,p_email:e.email||null,p_ip:e.ip||null,p_user_agent:e.userAgent||null,p_timestamp:new Date(e.timestamp).toISOString(),p_metadata:e.metadata||null,p_severity:e.severity}),{error:t}=s;if(!t||t.code==="42883"||t.code==="P0001"||t.code==="PGRST301"||t.code==="PGRST202"||t.status===404||t.message?.includes("does not exist")||t.message?.includes("Could not find the function")||t.message?.includes("function")&&t.message?.includes("not found")||t.message?.includes("404")||t.message?.includes("Not Found")||t.message?.includes("no matches were found in the schema cache"))return}catch(s){const t=s;if(t?.status===404||t?.code==="PGRST301"||t?.code==="PGRST202"||t?.message?.includes("404")||t?.message?.includes("Not Found")||t?.message?.includes("Could not find the function")||t?.message?.includes("no matches were found in the schema cache"))return}}function ot(){try{const e=localStorage.getItem("kch_audit_logs");return e?JSON.parse(e):[]}catch{return[]}}function ct(e){switch(e){case"login_attempt":case"logout":case"signup":return"low";case"login_failed":case"rate_limit_exceeded":case"data_access":return"medium";case"login_locked":case"account_locked":case"bot_detected":case"permission_denied":return"high";case"suspicious_activity":return"critical";default:return"medium"}}function Z(){const e=[];let s=0;const t=navigator.userAgent.toLowerCase();["headless","phantom","selenium","webdriver","puppeteer","playwright","scrapy","bot","crawler","spider"].some(n=>t.includes(n))&&(e.push("Bot user agent detected"),s+=50),!window.chrome&&!window.safari&&!window.firefox&&(e.push("Missing browser vendor object"),s+=20),navigator.webdriver&&(e.push("WebDriver property detected"),s+=40),navigator.plugins.length===0&&(e.push("No browser plugins detected"),s+=15),navigator.languages.length===0&&(e.push("No browser languages detected"),s+=10),navigator.permissions||(e.push("Permissions API missing"),s+=10),(window.screen.width===0||window.screen.height===0)&&(e.push("Invalid screen dimensions"),s+=20);try{const n=document.createElement("canvas");n.getContext("webgl")||n.getContext("experimental-webgl")||(e.push("WebGL not supported"),s+=10)}catch{e.push("WebGL check failed"),s+=5}return(window.__nightmare||window.__phantomas)&&(e.push("Automation framework detected"),s+=30),{isBot:s>=30,confidence:Math.min(100,s),reasons:e}}class lt{mouseMovements=[];clicks=[];keystrokes=[];scrolls=[];pageViews=[];startTime=Date.now();constructor(){this.setupTracking()}setupTracking(){document.addEventListener("mousemove",()=>{this.mouseMovements.push(Date.now()),this.mouseMovements.length>100&&this.mouseMovements.shift()}),document.addEventListener("click",()=>{this.clicks.push(Date.now()),this.clicks.length>50&&this.clicks.shift()}),document.addEventListener("keydown",()=>{this.keystrokes.push(Date.now()),this.keystrokes.length>100&&this.keystrokes.shift()});let s;window.addEventListener("scroll",()=>{clearTimeout(s),s=setTimeout(()=>{this.scrolls.push(Date.now()),this.scrolls.length>50&&this.scrolls.shift()},100)})}analyzeBehavior(){const s=[];let t=0;const n=(Date.now()-this.startTime)/6e4;if(this.mouseMovements.length===0&&n>.5&&(s.push("No mouse movement detected"),t+=30),this.pageViews.length>10&&n<1&&(s.push("Rapid page switching"),t+=25),this.mouseMovements.length+this.clicks.length+this.keystrokes.length===0&&n>1&&(s.push("No user interactions"),t+=40),this.clicks.length>5){const c=[];for(let g=1;g<this.clicks.length;g++)c.push(this.clicks[g]-this.clicks[g-1]);const l=c.reduce((g,w)=>g+w,0)/c.length;c.reduce((g,w)=>g+Math.pow(w-l,2),0)/c.length<100&&(s.push("Mechanical timing pattern"),t+=20)}return{isSuspicious:t>=30,score:Math.min(100,t),reasons:s}}recordPageView(){this.pageViews.push(Date.now()),this.pageViews.length>20&&this.pageViews.shift()}getInteractionScore(){const s=this.mouseMovements.length+this.clicks.length+this.keystrokes.length+this.scrolls.length,t=(Date.now()-this.startTime)/6e4;return Math.min(100,s/Math.max(1,t)*10)}}let P=null;function dt(){return P||(P=new lt),P}function ut(){return P}const Q=(e,s,t=365)=>{const a=new Date;a.setTime(a.getTime()+t*24*60*60*1e3),document.cookie=`${e}=${s};expires=${a.toUTCString()};path=/`},mt=e=>{const s=e+"=",t=document.cookie.split(";");for(let a=0;a<t.length;a++){let i=t[a];for(;i.charAt(0)===" ";)i=i.substring(1,i.length);if(i.indexOf(s)===0)return i.substring(s.length,i.length)}return null},re="kch_csrf_token",ht=3600*1e3;function ft(){const e=new Uint8Array(32);crypto.getRandomValues(e);const s=Array.from(e,a=>a.toString(16).padStart(2,"0")).join(""),t={token:s,expiresAt:Date.now()+ht};try{sessionStorage.setItem(re,JSON.stringify(t))}catch{window.__csrfToken=t}return s}function gt(){try{const e=sessionStorage.getItem(re);if(e){const s=JSON.parse(e);if(s.expiresAt>Date.now())return s.token}}catch{const e=window.__csrfToken;if(e&&e.expiresAt>Date.now())return e.token}return ft()}const Pt=()=>{const[e,s]=d.useState(!0),[t,a]=d.useState(""),[i,n]=d.useState(""),[o,c]=d.useState(""),[l,h]=d.useState(!0),[g,w]=d.useState(!1),[z,ie]=d.useState(null),[oe,F]=d.useState(null),O=Ee(),{toast:p}=Me(),$="",{lockoutInfo:k,showCaptcha:W,setShowCaptcha:ce,updateLockoutInfo:le}=rt(t,e),{breachStatus:K,performFinalCheck:de}=ee(i,e);d.useEffect(()=>{dt();const b=Z();b.isBot&&y("bot_detected",{metadata:{reasons:b.reasons,confidence:b.confidence},severity:"high"});const f=localStorage.getItem("staySignedIn");f!==null&&h(f==="true");const u=mt("parentName");u&&ie(u)},[]);const ue=async b=>{b.preventDefault(),w(!0),F(null);try{const f=We({email:e?t:void 0,password:i,name:e?void 0:o});if(!f.valid){const m=Object.values(f.errors)[0]?.[0];p({title:"Validation Error",description:m||"Please check your input",variant:"destructive"});return}const u=f.sanitized.email||t,T=f.sanitized.password||i;if(!e){if(K==="breached"){p({title:"Password Security Issue",description:"This password has been found in data breaches and is unsafe to use. Please choose a unique password with a mix of letters, numbers, and symbols.",variant:"destructive",duration:8e3}),w(!1);return}if(K!=="safe"&&!await de(T)){p({title:"Password Security Issue",description:"This password has been found in data breaches and is unsafe to use. Please choose a unique password with a mix of letters, numbers, and symbols.",variant:"destructive",duration:8e3}),w(!1);return}}const V=nt(u,"login"),q=Xe(V,"login");if(!q.allowed)if(q.lockedUntil){const m=Math.ceil((q.lockedUntil-Date.now())/6e4);p({title:"Account Temporarily Locked",description:`Too many login attempts. Please try again in ${m} minute(s).`,variant:"destructive"}),y("login_locked",{email:u,severity:"high"});return}else{p({title:"Too Many Attempts",description:"Please wait before trying again.",variant:"destructive"}),y("rate_limit_exceeded",{email:u,severity:"medium"});return}if(e&&k?.locked&&k.lockedUntil){const m=Math.ceil((k.lockedUntil-Date.now())/6e4);p({title:"Account Locked",description:`Account is locked due to multiple failed attempts. Try again in ${m} minute(s).`,variant:"destructive"}),y("account_locked",{email:u,severity:"high"}),w(!1);return}const D=Z();if(D.isBot&&D.confidence>50){const j=ut()?.analyzeBehavior();if(j?.isSuspicious){p({title:"Security Check Failed",description:"Unable to verify you're human. Please try again.",variant:"destructive"}),y("bot_detected",{email:u,metadata:{botReasons:D.reasons,behaviorReasons:j.reasons},severity:"high"});return}}if(et(V,"login"),localStorage.setItem("staySignedIn",l.toString()),l?sessionStorage.removeItem("clearSessionOnClose"):sessionStorage.setItem("clearSessionOnClose","true"),e){y("login_attempt",{email:u,severity:"low"});const{data:{user:m},error:j}=await S.auth.signInWithPassword({email:u,password:T});if(j){const v=tt(u);if(J.error("Auth error:",E(j)),y("login_failed",{email:u,metadata:{attempts:v.attempts},severity:"medium"}),v.locked&&v.lockedUntil){const x=Math.ceil((v.lockedUntil-Date.now())/6e4);p({title:"Account Locked",description:`Too many failed attempts. Account locked for ${x} minute(s).`,variant:"destructive"}),le({locked:!0,lockedUntil:v.lockedUntil}),y("account_locked",{email:u,severity:"high"})}else{const x=5-v.attempts;p({title:"Login Failed",description:x>0?`Invalid credentials. ${x} attempt(s) remaining.`:"Invalid credentials.",variant:"destructive"}),v.attempts>=2&&ce(!0)}throw j}if(st(u),y("login_success",{userId:m?.id,email:u,severity:"low"}),m){const{data:v}=await S.from("parents").select("name").eq("id",m.id).maybeSingle();v?.name&&Q("parentName",v.name,365);try{const{generateDeviceIdentifierAsync:x,detectDeviceType:me,getDeviceName:he,getClientIP:fe,getDeviceMacAddress:ge,getCountryFromIP:we}=await Ce(async()=>{const{generateDeviceIdentifierAsync:je,detectDeviceType:Se,getDeviceName:Pe,getClientIP:Ne,getDeviceMacAddress:_e,getCountryFromIP:Ae}=await import("./deviceTracking-lBUE_lfK.js");return{generateDeviceIdentifierAsync:je,detectDeviceType:Se,getDeviceName:Pe,getClientIP:Ne,getDeviceMacAddress:_e,getCountryFromIP:Ae}},__vite__mapDeps([0,1])),pe=await x(),ye=me(),ve=he(),be=navigator.userAgent,G=await fe(),xe=await ge(),ke=await we(G);await S.rpc("update_device_login",{p_parent_id:m.id,p_device_identifier:pe,p_device_name:ve,p_device_type:ye,p_user_agent:be,p_ip_address:G||null,p_mac_address:xe||null,p_country_code:ke||null,p_child_id:null})}catch(x){console.warn("Device tracking failed:",x)}}p({title:"Welcome back!"}),O("/parent/children")}else{y("signup",{email:u,severity:"low"});const{error:m}=await S.auth.signUp({email:u,password:T,options:{data:{name:f.sanitized.name||o},emailRedirectTo:`${window.location.origin}/parent/children`}});if(m)throw J.error("Signup error:",E(m)),y("signup",{email:u,metadata:{error:m.message},severity:"medium"}),m;(f.sanitized.name||o)&&Q("parentName",f.sanitized.name||o,365),p({title:"Account created! Welcome!"}),O("/parent/children")}}catch(f){E(f),f instanceof Error&&f.message.includes("locked")||p({title:"Error",description:f instanceof Error?f.message:"An unexpected error occurred",variant:"destructive"})}finally{w(!1),n(""),F(null)}};return r.jsx("div",{className:"min-h-[100dvh] flex items-center justify-center bg-background p-4",children:r.jsxs(Ue,{className:"w-full max-w-md p-8 space-y-6",children:[r.jsxs("div",{className:"text-center space-y-2",children:[r.jsx("div",{className:"flex justify-center",children:r.jsx("img",{src:"/icon-192x192.png",alt:"Kids Call Home",className:"h-12 w-12"})}),r.jsx("h1",{className:"text-3xl font-bold",children:"Kids Call Home"}),r.jsx("p",{className:"text-muted-foreground",children:e?z?`Welcome back, ${z}!`:"Welcome back, parent!":"Create your parent account"})]}),r.jsxs("form",{onSubmit:ue,className:"space-y-4",children:[!e&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Your Name"}),r.jsx(L,{type:"text",placeholder:"Mom / Dad / Guardian",value:o,onChange:b=>c(b.target.value),required:!e})]}),r.jsx(Ye,{email:t,onChange:a,isLogin:e}),r.jsx(Qe,{password:i,onChange:n,isLogin:e,autoComplete:e?"current-password":"new-password"}),e&&r.jsxs(r.Fragment,{children:[k&&r.jsx(Ze,{lockoutInfo:k}),W&&$,r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(te,{id:"staySignedIn",checked:l,onCheckedChange:b=>h(b===!0)}),r.jsx(ze,{htmlFor:"staySignedIn",className:"text-sm font-normal cursor-pointer",children:"Stay signed in"})]})]}),r.jsx("input",{type:"hidden",name:"csrf_token",value:gt()}),r.jsx(Be,{type:"submit",className:"w-full",disabled:g||e&&k?.locked,children:g?"Processing...":e?r.jsxs(r.Fragment,{children:[r.jsx(Re,{className:"mr-2 h-4 w-4"}),"Sign In"]}):r.jsxs(r.Fragment,{children:[r.jsx(Le,{className:"mr-2 h-4 w-4"}),"Create Account"]})})]}),r.jsx("div",{className:"text-center",children:r.jsx("button",{type:"button",onClick:()=>s(!e),className:"text-sm text-primary hover:underline",children:e?"Need an account? Sign up":"Already have an account? Sign in"})})]})})};export{Pt as default};

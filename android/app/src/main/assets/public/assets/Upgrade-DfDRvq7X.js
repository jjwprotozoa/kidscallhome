import{u as le,r,j as e,L as f,a0 as oe,ay as ce,K as de,s as ue}from"./vendor-react-mDIoga_b.js";import{N as k}from"./Navigation-CglVk_ff.js";import{O as me,H as pe}from"./OnboardingTour-BCKJLloU.js";import{u as he,s as d,C as h,B as u}from"./index-BdmHsoQZ.js";import{D as Y,a as M,b as $,c as q,d as B,e as H}from"./dialog-D8RTy2fV.js";import{I as xe}from"./input-UTyCM2Df.js";import{L as fe}from"./label-CU-FEe3V.js";import{i as P}from"./platformDetection-DMTH-XIz.js";import"./vendor-radix-BQCqNqg0.js";import"./vendor-other-BA4qpukX.js";import"./deviceTracking-lBUE_lfK.js";import"./vendor-capacitor-DSxgEnoB.js";import"./vendor-supabase-DQP4RkUL.js";const O=[{id:"additional-kid-monthly",name:"Additional Kid Monthly",price:"$2.99",priceValue:2.99,interval:"month",kidsSupported:1,stripeLink:"https://buy.stripe.com/7sYaEX4tHdms9b9fpqfQI05",description:"Add one more child to your account",allowQuantity:!0},{id:"additional-kid-annual",name:"Additional Kid Annual",price:"$29.99",priceValue:29.99,interval:"year",kidsSupported:1,stripeLink:"https://buy.stripe.com/14AdR94tH0zGdrpcdefQI06",description:"Add one more child (save 17% vs monthly)",allowQuantity:!0},{id:"family-bundle-monthly",name:"Family Bundle Monthly",price:"$14.99",priceValue:14.99,interval:"month",kidsSupported:5,stripeLink:"https://buy.stripe.com/aFa00j8JXciogDB3GIfQI07",description:"Perfect for families with up to 5 kids"},{id:"annual-family-plan",name:"Annual Family Plan",price:"$99",priceValue:99,interval:"year",kidsSupported:"unlimited",stripeLink:"https://buy.stripe.com/8x24gz7FT3LS5YXgtufQI08",description:"Best value - unlimited kids for the whole family",recommended:!0}],Fe=()=>{const v=le(),{toast:n}=he(),[Q,g]=r.useState(!0),[C,R]=r.useState(0),[y,E]=r.useState(1),[l,_]=r.useState("free"),[ge,G]=r.useState("active"),[x,K]=r.useState(!1),[V,b]=r.useState(!1),[i,z]=r.useState(null),[m,N]=r.useState(""),[j,ye]=r.useState(!0),[c,p]=r.useState(!1),[X,w]=r.useState(!1),[W,D]=r.useState(""),[A,F]=r.useState(!1);r.useEffect(()=>{J(),P()?S():g(!1);const s=new URLSearchParams(window.location.search),a=s.get("session_id"),t=s.get("canceled");a?(n({title:"Payment Successful!",description:"Your subscription is being activated. Please wait a moment...",variant:"default"}),setTimeout(async()=>{P()&&await S(),w(!0),D("Your subscription has been activated successfully!")},2e3),window.history.replaceState({},"","/parent/upgrade")):t&&(n({title:"Payment Cancelled",description:"Your payment was cancelled. You can try again anytime.",variant:"default"}),window.history.replaceState({},"","/parent/upgrade"))},[]);const J=async()=>{const{data:{session:s}}=await d.auth.getSession();if(!s){v("/parent/auth");return}},S=async()=>{try{const{data:{user:s}}=await d.auth.getUser();if(!s)return;const{data:a,error:t}=await d.from("parents").select("email, allowed_children, subscription_type, subscription_status, subscription_expires_at").eq("id",s.id).single();if(t){if(t.code==="42703"||t.message?.includes("does not exist")){console.warn("Subscription columns don't exist yet. Migration not run:",t),n({title:"Database Migration Required",description:"Please run the subscription migration: supabase/migrations/20250122000007_add_subscription_system.sql",variant:"destructive",duration:1e4}),E(1),_("free"),N(a?.email||""),g(!1);return}console.error("Error loading subscription:",t),n({title:"Error",description:"Failed to load subscription information",variant:"destructive"}),g(!1);return}const o=a?.allowed_children||1,U=a?.subscription_type||"free",L=a?.subscription_status||"active",I=a?.subscription_expires_at;E(o),_(U);const re=a?.email||s.email||"";N(re),G(L);const ie=L==="active"&&(I===null||new Date(I)>new Date)&&U!=="free";K(ie);const{data:T,error:ne}=await d.from("children").select("id",{count:"exact"}).eq("parent_id",s.id);!ne&&T&&R(T.length||0)}catch(s){console.error("Error loading subscription info:",s)}finally{g(!1)}},Z=s=>{if(x&&l===s.id){n({title:"Current Plan",description:"You are already subscribed to this plan.",variant:"default"});return}z(s),b(!0)},ee=async()=>{if(!i||!m.trim()){n({title:"Error",description:"Please enter your family account email",variant:"destructive"});return}p(!0);try{const{data:s,error:a}=await d.functions.invoke("create-stripe-subscription",{body:{subscriptionType:i.id,quantity:1}});if(a||!s?.success)throw new Error(a?.message||s?.error||"Failed to create checkout session");const{url:t}=s;if(!t)throw new Error("No checkout URL returned from subscription creation");window.location.href=t}catch(s){console.error("Error processing payment:",s),n({title:"Payment Error",description:s.message||"Failed to process payment. Please try again.",variant:"destructive"})}finally{p(!1)}},se=async()=>{if(i)try{p(!0);let s=y;i.id==="annual-family-plan"?s=999:i.id==="family-bundle-monthly"?s=5:(i.id==="additional-kid-monthly"||i.id==="additional-kid-annual")&&(s=y+1);const{data:{user:a}}=await d.auth.getUser();if(!a||a.email!==m.trim()){n({title:"Security Error",description:"Email must match your authenticated account. You can only upgrade your own account.",variant:"destructive"}),p(!1);return}const{data:t,error:o}=await d.rpc("upgrade_family_subscription",{p_family_email:m.trim(),p_subscription_type:i.id,p_allowed_children:s,p_stripe_checkout_session_id:null});if(o)throw o.code==="PGRST202"||o.message?.includes("Could not find the function")?new Error("Database migration not run. Please run: supabase/migrations/20250122000007_add_subscription_system.sql"):o;if(t?.success)D(`Successfully upgraded! You can now add up to ${s===999?"unlimited":s} children.`),b(!1),w(!0),await S();else throw new Error(t?.error||"Failed to upgrade subscription")}catch(s){console.error("Error upgrading subscription:",s),n({title:"Upgrade Failed",description:s.message||"Failed to upgrade subscription. Please contact support.",variant:"destructive"})}finally{p(!1)}},ae=async()=>{await se()},te=async()=>{F(!0);try{const{data:s,error:a}=await d.functions.invoke("create-customer-portal-session",{body:{returnUrl:`${window.location.origin}/parent/upgrade`}});if(a)throw a;if(s?.success&&s?.url)window.location.href=s.url;else throw new Error(s?.error||"Failed to create portal session")}catch(s){console.error("Error opening subscription management:",s),n({title:"Error",description:s.message||"Failed to open subscription management. Please try again.",variant:"destructive"})}finally{F(!1)}};return P()?Q?e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(k,{}),e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-muted-foreground"})})]}):e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(k,{}),e.jsx(me,{role:"parent",pageKey:"parent_upgrade"}),e.jsx(pe,{role:"parent",pageKey:"parent_upgrade"}),e.jsx("div",{className:"px-4 pb-4",style:{paddingTop:"calc(0.5rem + 64px + var(--safe-area-inset-top) * 0.15)"},children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mt-4 mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Upgrade Your Plan"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a plan that fits your family's needs"})]}),x&&e.jsx(h,{className:"p-6 mb-8 bg-primary/10 border-primary/20",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-primary mb-1",children:"Your Current Plan"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[O.find(s=>s.id===l)?.name||l,l==="annual-family-plan"&&" - Unlimited children"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-primary",children:"Active Subscription"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[C," /"," ",y===999?"∞":y," children"]})]}),e.jsx(u,{variant:"default",onClick:te,disabled:A,size:"sm",children:A?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Opening..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),"Manage"]})})]})]})}),!x&&e.jsx(h,{className:"p-6 mb-8 bg-muted/50",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Current Plan"}),e.jsx("p",{className:"text-lg font-semibold capitalize",children:"Free Tier"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Children Added"}),e.jsxs("p",{className:"text-lg font-semibold",children:[C," / 1"]})]})]})}),e.jsx("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-8","data-tour":"parent-upgrade-plans",children:O.map(s=>{const a=l===s.id,t=x&&(s.id==="annual-family-plan"||s.id==="family-bundle-monthly"&&l!=="annual-family-plan"&&l!=="family-bundle-monthly"||s.id.includes("additional")&&!l.includes("additional")),o=x&&l==="annual-family-plan"&&s.id!=="annual-family-plan";return e.jsxs(h,{className:`p-6 relative ${a?"border-2 border-primary shadow-lg bg-primary/5":s.recommended?"border-2 border-primary/50 shadow-md":"border"}`,children:[s.recommended&&!a&&e.jsx("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2",children:e.jsxs("span",{className:"bg-primary text-primary-foreground px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),"Best Value"]})}),a&&e.jsx("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2",children:e.jsx("span",{className:"bg-primary text-primary-foreground px-3 py-1 rounded-full text-xs font-semibold",children:"✓ Current Plan"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-1",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-3xl font-bold",children:s.price}),e.jsxs("span",{className:"text-muted-foreground",children:["/",s.interval==="month"?"mo":"yr"]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(de,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:s.kidsSupported==="unlimited"?"Unlimited children":`Up to ${s.kidsSupported} ${s.kidsSupported===1?"child":"children"}`})]})]}),e.jsx(u,{className:"w-full",variant:a?"secondary":s.recommended?"default":"outline",onClick:()=>Z(s),disabled:c||a,children:c?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):a?"Current Plan":t?"Upgrade":o?"Downgrade":"Select Plan"}),o&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Note: Downgrading will reduce your child limit"})]})]},s.id)})}),e.jsx(h,{className:"p-6 bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ue,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-100",children:"How It Works"}),e.jsxs("ul",{className:"text-sm text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside",children:[e.jsx("li",{children:"Select a plan and complete payment through Stripe"}),e.jsx("li",{children:"Enter your family account email to link the subscription"}),e.jsx("li",{children:"Your account will be upgraded automatically"}),e.jsx("li",{children:"Start adding more children right away!"})]})]})]})})]})}),e.jsx(Y,{open:V,onOpenChange:b,children:e.jsxs(M,{children:[e.jsxs($,{children:[e.jsx(q,{children:"Complete Your Upgrade"}),e.jsx(B,{children:"Enter your family account email to link this subscription to your account."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(fe,{htmlFor:"email",children:"Family Account Email"}),e.jsx(xe,{id:"email",type:"email",placeholder:"your-email@example.com",value:m,onChange:s=>N(s.target.value),disabled:c||j,readOnly:j,className:j?"bg-muted cursor-not-allowed":""}),j&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Email is locked to your authenticated account for security"})]}),i&&e.jsx(h,{className:"p-4 bg-muted",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-semibold",children:i.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[i.price,"/",i.interval==="month"?"month":"year"]})]})})]}),e.jsxs(H,{className:"flex-col sm:flex-row gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{b(!1),p(!1)},disabled:c,className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(u,{onClick:ee,disabled:c||!m.trim(),className:"w-full sm:w-auto",children:c?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):"Proceed to Payment"}),e.jsx(u,{variant:"secondary",onClick:ae,disabled:c||!m.trim(),className:"w-full sm:w-auto",children:c?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):"I Already Paid"})]})]})}),e.jsx(Y,{open:X,onOpenChange:w,children:e.jsxs(M,{children:[e.jsxs($,{children:[e.jsx(q,{children:"Upgrade Successful!"}),e.jsx(B,{children:W})]}),e.jsx(H,{children:e.jsx(u,{onClick:()=>{w(!1),v("/parent/dashboard")},children:"Go to Dashboard"})})]})})]}):e.jsxs("div",{className:"min-h-[100dvh] bg-background w-full overflow-x-hidden",children:[e.jsx(k,{}),e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] px-4",children:e.jsxs(h,{className:"p-8 max-w-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"In-App Purchases"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"This app uses in-app purchases through the App Store or Play Store. Please upgrade your subscription through your device's app store."}),e.jsx(u,{onClick:()=>v("/parent/dashboard"),children:"Go to Dashboard"})]})})]})};export{Fe as default};

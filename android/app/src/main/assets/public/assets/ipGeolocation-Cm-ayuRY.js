const a=new Map,s=1440*60*1e3,g=localStorage.getItem("kch_disable_ip_geolocation")==="true";function y(t){if(!t||t.length!==2)return null;const e=t.toUpperCase().split("").map(i=>127462+(i.charCodeAt(0)-65));return String.fromCodePoint(...e)}async function m(t){if(!t)return{country:null,countryCode:null,countryFlag:null,city:null,region:null};if(g)return{country:null,countryCode:null,countryFlag:null,city:null,region:null};const e=a.get(t);if(e){if(Date.now()-e.timestamp<s)return e.result;a.delete(t)}try{const r=new AbortController,c=setTimeout(()=>r.abort(),5e3);try{const o=await fetch(`https://ip-api.com/json/${t}?fields=status,message,country,countryCode,city,regionName`,{method:"GET",headers:{Accept:"application/json"},signal:r.signal}).catch(n=>(clearTimeout(c),null));if(clearTimeout(c),!o)throw new Error("Network error");if(o.status===403||o.status===429)throw localStorage.setItem("kch_disable_ip_geolocation","true"),new Error("Rate limited");if(o.ok){const n=await o.json();if(n.status==="success"){const l=n.countryCode||null,u={country:n.country||null,countryCode:l,countryFlag:y(l),city:n.city||null,region:n.regionName||null};return a.set(t,{result:u,timestamp:Date.now()}),u}}throw new Error("Response not ok")}catch(o){clearTimeout(c),o instanceof TypeError&&o.message.includes("aborted")}}catch{}try{const r=new AbortController,c=setTimeout(()=>r.abort(),5e3);try{const o=await fetch(`https://ipapi.co/${t}/json/`,{method:"GET",headers:{Accept:"application/json"},signal:r.signal});if(clearTimeout(c),o.ok){const n=await o.json();if(n.country_code&&!n.error){const l=n.country_code||null,u={country:n.country_name||null,countryCode:l,countryFlag:y(l),city:n.city||null,region:n.region||null};return a.set(t,{result:u,timestamp:Date.now()}),u}}}catch(o){throw clearTimeout(c),o}}catch{}const i={country:null,countryCode:null,countryFlag:null,city:null,region:null};return a.set(t,{result:i,timestamp:Date.now()-(s-300*1e3)}),i}async function h(t){const e=await m(t);return{countryCode:e.countryCode,countryFlag:e.countryFlag,country:e.country}}export{y as countryCodeToFlag,h as getCountryFromIP,m as getIPGeolocation};

import{u as X,s,v as O,r as Y}from"./index-BdmHsoQZ.js";import{r as i,u as Z}from"./vendor-react-mDIoga_b.js";import{u as ee}from"./useWebRTC-DpOhSsm3.js";const ie=({role:r,localProfileId:_,remoteProfileId:te,localVideoRef:$,remoteVideoRef:z})=>{const[n,f]=i.useState("idle"),[C,T]=i.useState(null),[I,x]=i.useState(!1),[A,V]=i.useState(!1),G=Z(),{toast:l}=X(),h=i.useRef(null),D=i.useRef(null),k=i.useRef(!1),{localStream:g,remoteStream:N,setIsConnecting:p,initializeConnection:b,cleanup:R,iceCandidatesQueue:j,peerConnectionRef:v}=ee(C,$,z,r==="child");i.useEffect(()=>{!k.current&&n==="idle"&&(k.current=!0,b().catch(e=>{console.error("Failed to initialize WebRTC:",e),l({title:"Connection Error",description:"Failed to initialize video connection",variant:"destructive"})}))},[n,b,l]),i.useEffect(()=>{n==="incoming"&&!g&&(console.log("ðŸ“ž [CALL ENGINE] Pre-warming local media for incoming call"),b().catch(e=>{console.error("Failed to pre-warm media:",e)}))},[n,g,b]),i.useEffect(()=>{if(n!=="idle"||!_)return;const e=s.channel(`incoming-calls:${_}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"calls",filter:r==="parent"?`parent_id=eq.${_}`:`child_id=eq.${_}`},async t=>{const a=t.new;a.status==="ringing"&&a.caller_type!==r&&a.offer&&(console.log("ðŸ“ž [CALL ENGINE] Incoming call detected:",a.id),T(a.id),f("incoming"))}).subscribe();return()=>{s.removeChannel(e)}},[n,_,r]),i.useEffect(()=>{if(!C)return;const e=s.channel(`call-status:${C}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"calls",filter:`id=eq.${C}`},async t=>{const a=t.new,w=t.old,o=v.current;if(n==="calling"&&a.answer&&a.status==="in_call"&&(console.log("ðŸ“ž [CALL ENGINE] Answer received, setting remote description"),o&&o.remoteDescription===null)){const c=a.answer;await o.setRemoteDescription(new RTCSessionDescription(c));for(const m of j.current)try{await o.addIceCandidate(new RTCIceCandidate(m))}catch(y){const E=y;!E.message?.includes("duplicate")&&!E.message?.includes("already")&&console.error("Error adding queued ICE candidate:",E.message)}j.current=[]}if((n==="calling"||n==="incoming"||n==="connecting")&&(a.status==="rejected"||a.status==="missed")&&(console.log("ðŸ“ž [CALL ENGINE] Call rejected or missed"),f("ended"),R()),O(a)&&w&&!O(w)&&(console.log("ðŸ“ž [CALL ENGINE] Call ended by remote party"),f("ended"),R(),l({title:"Call Ended",description:"The other person ended the call"})),a.status==="in_call"&&(n==="calling"||n==="incoming"||n==="connecting")&&o){const c=()=>{const m=o.iceConnectionState,y=o.connectionState;(m==="connected"||m==="completed")&&y==="connected"&&N&&(console.log("ðŸ“ž [CALL ENGINE] Connection established, transitioning to in_call"),f("in_call"),p(!1))};return c(),o.addEventListener("iceconnectionstatechange",c),o.addEventListener("connectionstatechange",c),()=>{o.removeEventListener("iceconnectionstatechange",c),o.removeEventListener("connectionstatechange",c)}}}).subscribe();return h.current=e,()=>{h.current&&(s.removeChannel(h.current),h.current=null)}},[C,n,N,p,R,l]),i.useEffect(()=>{const e=v.current;if(!e||n!=="calling")return;const t=()=>{const a=e.iceConnectionState,w=e.connectionState;(a==="connected"||a==="completed")&&w==="connected"&&N&&n==="calling"&&(console.log("ðŸ“ž [CALL ENGINE] WebRTC connected, transitioning to in_call"),f("in_call"),p(!1))};return e.addEventListener("iceconnectionstatechange",t),e.addEventListener("connectionstatechange",t),()=>{e.removeEventListener("iceconnectionstatechange",t),e.removeEventListener("connectionstatechange",t)}},[n,N,p,v]),i.useEffect(()=>{if(n==="ended"){const e=setTimeout(()=>{G(r==="parent"?"/parent":"/child")},2e3);return()=>clearTimeout(e)}},[n,G,r]);const M=i.useCallback(async e=>{if(n!=="idle"){console.warn("Cannot start call: not in idle state");return}try{f("calling"),p(!0);const t=v.current;if(!t)throw new Error("Peer connection not initialized");const a=await t.createOffer();await t.setLocalDescription(a);const w=r,o={[r==="parent"?"parent_id":"child_id"]:_,[r==="parent"?"child_id":"parent_id"]:e,caller_type:w,status:"ringing",offer:{type:a.type,sdp:a.sdp}},{data:c,error:m}=await s.from("calls").insert(o).select().single();if(m)throw m;if(!c)throw new Error("Failed to create call");T(c.id),console.log("ðŸ“ž [CALL ENGINE] Outgoing call created:",c.id),t.onicecandidate=async E=>{if(E.candidate&&c.id){const d=r==="parent"?"parent_ice_candidates":"child_ice_candidates",{data:u}=await s.from("calls").select(d).eq("id",c.id).single(),S=[...u?.[d]||[],E.candidate.toJSON()];await s.from("calls").update({[d]:S}).eq("id",c.id)}};const y=s.channel(`call-answer:${c.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"calls",filter:`id=eq.${c.id}`},async E=>{const d=E.new,u=v.current;if(d.answer&&d.status==="in_call"){if(!u)return;const L=d.answer;await u.setRemoteDescription(new RTCSessionDescription(L));const S=r==="parent"?"child_ice_candidates":"parent_ice_candidates",{data:F}=await s.from("calls").select(S).eq("id",c.id).single(),B=F?.[S]||[];if(u)for(const H of B)try{await u.addIceCandidate(new RTCIceCandidate(H))}catch(K){const q=K;!q.message?.includes("duplicate")&&!q.message?.includes("already")&&console.error("Error adding remote ICE candidate:",q.message)}}}).subscribe();h.current=y}catch(t){console.error("Error starting outgoing call:",t),l({title:"Call Failed",description:t instanceof Error?t.message:"Failed to start call",variant:"destructive"}),f("idle"),p(!1)}},[n,_,r,p,l]),W=i.useCallback(async e=>{if(n!=="incoming"){console.warn("Cannot accept call: not in incoming state");return}try{f("connecting"),p(!0);const t=v.current;if(!t)throw new Error("Peer connection not initialized");g||(console.log("ðŸ“ž [CALL ENGINE] Local stream not ready, initializing now..."),await b());const{data:a,error:w}=await s.from("calls").select("*").eq("id",e).single();if(w||!a)throw new Error("Call not found");if(!a.offer)throw new Error("Call offer not found");const o=a.offer;await t.setRemoteDescription(new RTCSessionDescription(o));const c=await t.createAnswer();await t.setLocalDescription(c);const{error:m}=await s.from("calls").update({answer:{type:c.type,sdp:c.sdp},status:"in_call"}).eq("id",e);if(m)throw m;T(e),console.log("ðŸ“ž [CALL ENGINE] Call accepted:",e),t&&(t.onicecandidate=async d=>{if(d.candidate&&e){const u=r==="parent"?"parent_ice_candidates":"child_ice_candidates",{data:L}=await s.from("calls").select(u).eq("id",e).single(),F=[...L?.[u]||[],d.candidate.toJSON()];await s.from("calls").update({[u]:F}).eq("id",e)}});const E=a[r==="parent"?"child_ice_candidates":"parent_ice_candidates"]||[];for(const d of E)try{await t.addIceCandidate(new RTCIceCandidate(d))}catch(u){const L=u;!L.message?.includes("duplicate")&&!L.message?.includes("already")&&console.error("Error adding remote ICE candidate:",L.message)}}catch(t){console.error("Error accepting call:",t),l({title:"Call Failed",description:t instanceof Error?t.message:"Failed to accept call",variant:"destructive"}),f("idle"),p(!1)}},[n,g,b,r,p,l,v]),P=i.useCallback(async e=>{if(n!=="incoming"){console.warn("Cannot reject call: not in incoming state");return}try{await s.from("calls").update({status:"rejected"}).eq("id",e),f("ended"),console.log("ðŸ“ž [CALL ENGINE] Call rejected:",e)}catch(t){console.error("Error rejecting call:",t),l({title:"Error",description:"Failed to reject call",variant:"destructive"})}},[n,l]),J=i.useCallback(async()=>{if(C)try{await Y({callId:C,by:r,reason:"hangup"}),f("ended"),R(),h.current&&(s.removeChannel(h.current),h.current=null),D.current&&(s.removeChannel(D.current),D.current=null),console.log("ðŸ“ž [CALL ENGINE] Call ended:",C)}catch(e){console.error("Error ending call:",e),l({title:"Error",description:"Failed to end call",variant:"destructive"})}},[C,r,R,l]),U=i.useCallback(()=>{if(g){const e=!I;g.getAudioTracks().forEach(t=>{t.enabled=!e}),x(e)}},[g,I]),Q=i.useCallback(()=>{if(g){const e=!A;g.getVideoTracks().forEach(t=>{t.enabled=!e}),V(e)}},[g,A]);return{state:n,callId:C,localStream:g,remoteStream:N,isMuted:I,isVideoOff:A,startOutgoingCall:M,acceptIncomingCall:W,rejectIncomingCall:P,endCall:J,toggleMute:U,toggleVideo:Q}};export{ie as u};

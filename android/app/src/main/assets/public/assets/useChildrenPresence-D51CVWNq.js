import{r as i,j as t,x as X,K as Z}from"./vendor-react-mDIoga_b.js";import{u as I,s as d,a as C,d as k,B as R}from"./index-BdmHsoQZ.js";import{I as H}from"./input-UTyCM2Df.js";import{D as ee,a as te,b as ae,c as re}from"./dialog-D8RTy2fV.js";const U=["#3B82F6","#F97316","#10B981","#A855F7","#EC4899"],V=[{name:"red",color:"#EF4444"},{name:"blue",color:"#3B82F6"},{name:"green",color:"#10B981"},{name:"yellow",color:"#FBBF24"},{name:"orange",color:"#F97316"},{name:"purple",color:"#A855F7"},{name:"pink",color:"#EC4899"},{name:"brown",color:"#92400E"},{name:"black",color:"#1F2937"},{name:"white",color:"#F3F4F6"}],ne=[{name:"cat",emoji:"ðŸ±"},{name:"dog",emoji:"ðŸ¶"},{name:"bird",emoji:"ðŸ¦"},{name:"fish",emoji:"ðŸ "},{name:"bear",emoji:"ðŸ»"},{name:"lion",emoji:"ðŸ¦"},{name:"tiger",emoji:"ðŸ¯"},{name:"elephant",emoji:"ðŸ˜"},{name:"monkey",emoji:"ðŸµ"},{name:"rabbit",emoji:"ðŸ°"},{name:"horse",emoji:"ðŸ´"},{name:"duck",emoji:"ðŸ¦†"},{name:"cow",emoji:"ðŸ„"},{name:"pig",emoji:"ðŸ·"},{name:"sheep",emoji:"ðŸ‘"}],ce=({open:g,onOpenChange:E,onChildAdded:O})=>{const[v,S]=i.useState(""),[D,b]=i.useState(U[0]),[A,F]=i.useState("color"),[n,w]=i.useState(""),[a,N]=i.useState(""),[y,f]=i.useState(""),[s,p]=i.useState(""),[o,h]=i.useState(!1),[u,x]=i.useState(!1),{toast:l}=I();i.useEffect(()=>{g&&(P(),$())},[g]);const P=async()=>{try{const{data:{user:e}}=await d.auth.getUser();if(!e)return;let{data:r,error:c}=await d.from("parents").select("family_code").eq("id",e.id).single();if(c&&c.code==="PGRST116"){C.log("ðŸ“ [FAMILY CODE] Parent record not found, creating it...");const{error:m}=await d.from("parents").upsert({id:e.id,email:e.email||"",name:e.user_metadata?.name||""},{onConflict:"id"});if(m)throw C.error("âŒ [FAMILY CODE] Failed to create parent record:",k(m)),m;const{data:_,error:j}=await d.from("parents").select("family_code").eq("id",e.id).single();if(j)throw j;r=_}else if(c){if(c.code==="42703"||c.message?.includes("does not exist")){l({title:"Database Migration Required",description:"The family_code column doesn't exist yet. Please run the migration in Supabase: supabase/migrations/20250121000000_add_family_code.sql",variant:"destructive",duration:1e4}),C.error("âŒ [FAMILY CODE] Migration not run. Error:",k(c));return}throw c}if(r?.family_code)p(r.family_code);else{C.warn("âš ï¸ [FAMILY CODE] Parent exists but family_code is null, attempting to generate...");try{const{data:m,error:_}=await d.rpc("generate_unique_family_code");if(!_&&m){const{error:j}=await d.from("parents").update({family_code:m}).eq("id",e.id);if(j)C.error("âŒ [FAMILY CODE] Failed to update parent with family code:",k(j));else{p(m),C.log("âœ… [FAMILY CODE] Generated and set family code (code redacted)");return}}else C.error("âŒ [FAMILY CODE] RPC call failed:",k(_))}catch(m){C.error("âŒ [FAMILY CODE] Exception calling RPC:",k(m))}l({title:"Family Code Missing",description:"Your account doesn't have a family code yet. The system will attempt to generate one. Please refresh the page in a moment.",variant:"destructive",duration:8e3})}}catch(e){C.error("Failed to fetch family code:",k(e)),l({title:"Error Loading Family Code",description:e.message||"Please refresh and try again. If the problem persists, ensure the database migration has been run.",variant:"destructive",duration:8e3})}},$=async()=>{x(!0);try{const{data:e,error:r}=await d.rpc("generate_kid_friendly_login_code");if(r)throw r;f(e);const[c,m]=e.split("-");w(c),N(m);const _=V.some(j=>j.name===c);F(_?"color":"animal")}catch{l({title:"Error",description:"Failed to generate code. Please try again.",variant:"destructive"})}finally{x(!1)}},z=(e,r)=>{w(e),F(r),G(e,a)},J=e=>{const r=parseInt(e);(e===""||r>=1&&r<=99)&&(N(e),n&&G(n,e))},G=(e,r)=>{e&&r&&s?f(`${s}-${e}-${r}`):e&&r&&f(`${e}-${r}`)},Q=async e=>{try{const{data:r,error:c}=await d.from("children").select("id").eq("login_code",e).maybeSingle();if(c)throw c;return!r}catch{return!1}};i.useEffect(()=>{s&&n&&a?f(`${s}-${n}-${a}`):n&&a&&f(`${n}-${a}`)},[s,n,a]);const W=async e=>{if(e.preventDefault(),!v.trim()){l({title:"Error",description:"Please enter a name",variant:"destructive"});return}if(!s){l({title:"Family Code Required",description:"Family code not loaded. This may mean the database migration hasn't been run. Please check the console for details.",variant:"destructive",duration:8e3});return}if(!y||!n||!a){l({title:"Error",description:"Please select a color/animal and number",variant:"destructive"});return}h(!0);try{const{data:{user:r}}=await d.auth.getUser();if(!r)throw new Error("Not authenticated");const{data:c,error:m}=await d.rpc("can_add_child",{p_parent_id:r.id});if(m)C.error("Error checking subscription limit:",k(m));else if(c===!1){const{data:M}=await d.from("parents").select("allowed_children, subscription_status, subscription_expires_at").eq("id",r.id).single(),{count:K}=await d.from("children").select("*",{count:"exact",head:!0}).eq("parent_id",r.id),q=M?.allowed_children||1,Y=M?.subscription_status||"unknown",T=M?.subscription_expires_at,B=T?new Date(T)<=new Date:!1;let L="You've reached your subscription limit. ";(Y!=="active"||B)&&(L+=`Your subscription status is "${Y}"${B?" and has expired":""}. `),L+=`You have ${K||0} / ${q===999?"unlimited":q} children. `,L+="Please upgrade your plan or manage your subscription to add more children.",console.error("Subscription limit check failed:",{canAdd:c,currentCount:K,allowed:q,status:Y,expiresAt:T,isExpired:B}),l({title:"Subscription Limit Reached",description:L,variant:"destructive",duration:1e4}),h(!1);return}if(!await Q(y)){l({title:"Code already taken",description:"Please generate a new code or choose different options",variant:"destructive"}),h(!1);return}const{error:j}=await d.from("children").insert({parent_id:r.id,name:v.trim(),login_code:y,avatar_color:D});if(j)throw j;l({title:"Child added successfully!",description:`Full login code: ${y}`}),S(""),b(U[0]),w(""),N(""),f(""),E(!1),O()}catch(r){l({title:"Error",description:r.message,variant:"destructive"})}finally{h(!1)}};return t.jsx(ee,{open:g,onOpenChange:E,children:t.jsxs(te,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[t.jsx(ae,{children:t.jsx(re,{children:"Add a Child"})}),t.jsxs("form",{onSubmit:W,className:"space-y-6",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"Child's Name"}),t.jsx(H,{type:"text",placeholder:"Enter name",value:v,onChange:e=>S(e.target.value),required:!0})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"Pick an Avatar Color"}),t.jsx("div",{className:"flex gap-2 flex-wrap",children:U.map(e=>t.jsx("button",{type:"button",onClick:()=>b(e),className:"w-12 h-12 rounded-full border-4 transition-all",style:{backgroundColor:e,borderColor:D===e?e:"transparent",opacity:D===e?1:.6}},e))})]}),t.jsxs("div",{className:"space-y-4 border-t pt-4",children:[t.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg border border-blue-200 dark:border-blue-800",children:[t.jsx("p",{className:"text-xs font-medium text-blue-900 dark:text-blue-100 mb-1",children:"Your Family Code"}),t.jsx("p",{className:"text-xl font-mono font-bold text-blue-700 dark:text-blue-300 text-center",children:s||"Loading..."}),t.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300 mt-2 text-center",children:"Share this code with your child for login"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("label",{className:"text-sm font-medium",children:"Child's Login Code"}),t.jsxs(R,{type:"button",variant:"outline",size:"sm",onClick:$,disabled:u||!s,children:[t.jsx(X,{className:`h-4 w-4 mr-2 ${u?"animate-spin":""}`}),"Generate New"]})]}),t.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Full Login Code"}),t.jsx("p",{className:"text-2xl font-mono font-bold text-center break-all",children:y||(s?"Select color/animal and number":"Loading...")})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(R,{type:"button",variant:A==="color"?"default":"outline",onClick:()=>F("color"),className:"flex-1",children:"Colors"}),t.jsx(R,{type:"button",variant:A==="animal"?"default":"outline",onClick:()=>F("animal"),className:"flex-1",children:"Animals"})]}),A==="color"?t.jsx("div",{className:"grid grid-cols-5 gap-2",children:V.map(e=>t.jsx("button",{type:"button",onClick:()=>z(e.name,"color"),className:`h-16 rounded-lg border-2 transition-all flex items-center justify-center ${n===e.name?"border-primary scale-105":"border-transparent opacity-60 hover:opacity-100"}`,style:{backgroundColor:e.color},children:t.jsx("span",{className:"text-white font-bold text-sm capitalize",children:e.name})},e.name))}):t.jsx("div",{className:"grid grid-cols-5 gap-2",children:ne.map(e=>t.jsxs("button",{type:"button",onClick:()=>z(e.name,"animal"),className:`h-16 rounded-lg border-2 transition-all flex flex-col items-center justify-center ${n===e.name?"border-primary scale-105 bg-primary/10":"border-transparent opacity-60 hover:opacity-100 hover:bg-muted"}`,children:[t.jsx("span",{className:"text-2xl",children:e.emoji}),t.jsx("span",{className:"text-xs font-medium capitalize mt-1",children:e.name})]},e.name))})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"Number (1-99)"}),t.jsx(H,{type:"number",min:"1",max:"99",placeholder:"Enter number",value:a,onChange:e=>J(e.target.value),className:"text-center text-2xl font-bold"})]}),y&&s&&t.jsxs("div",{className:"bg-green-50 dark:bg-green-950 p-3 rounded-lg flex items-center gap-2",children:[t.jsx(Z,{className:"h-5 w-5 text-green-600"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm text-green-800 dark:text-green-200 font-medium",children:"Code ready!"}),t.jsxs("p",{className:"text-xs text-green-700 dark:text-green-300 mt-1",children:["Your child will use: ",t.jsx("span",{className:"font-mono font-bold",children:y})]})]})]})]}),t.jsx(R,{type:"submit",className:"w-full",disabled:o||!y||!s,children:o?"Creating...":"Add Child"})]})]})})};function de({childIds:g,enabled:E=!0,onStatusChange:O}){const[v,S]=i.useState({}),D=i.useRef(new Map),b=i.useRef(O);i.useEffect(()=>{b.current=O},[O]);const A=i.useMemo(()=>[...g].sort().join(","),[g]);i.useEffect(()=>{if(!E)return;const n={};g.forEach(w=>{n[w]={isOnline:!1,lastSeen:null}}),S(n)},[g,E]),i.useEffect(()=>{if(!E||g.length===0)return;const n=D.current;n.size>0&&(n.forEach(a=>{d.removeChannel(a)}),n.clear());const w=new Map;return g.forEach((a,N)=>{setTimeout(()=>{if(n.has(a))return;const y=`presence:child:${a}`,f=d.channel(y,{config:{presence:{key:a}}});f.on("presence",{event:"sync"},()=>{const s=f.presenceState(),p=a in s&&Array.isArray(s[a])&&s[a].length>0,o=s[a],h=o&&o.length>0?o[0]:void 0,u=p?h?.lastSeen||new Date().toISOString():null;S(x=>{const l=x[a]?.isOnline||!1,P=x[a]?.lastSeen||null;if(l===p&&P===u)return x;const $={...x,[a]:{isOnline:p,lastSeen:u||P}};return l!==p&&b.current&&x[a]!==void 0&&b.current(a,p),$})}).on("presence",{event:"join"},({key:s,newPresences:p})=>{if(s!==a)return;const o=p[0];S(h=>{const u=h[a]?.isOnline||!1,x={...h,[a]:{isOnline:!0,lastSeen:o?.lastSeen||new Date().toISOString()}};return!u&&b.current&&b.current(a,!0),x})}).on("presence",{event:"leave"},({key:s,leftPresences:p})=>{s===a&&S(o=>{const h=o[a]?.isOnline||!1,u={...o,[a]:{isOnline:!1,lastSeen:o[a]?.lastSeen||new Date().toISOString()}};return h&&b.current&&b.current(a,!1),u})}).subscribe((s,p)=>{s==="SUBSCRIBED"&&setTimeout(()=>{const o=f.presenceState();if(a in o&&Array.isArray(o[a])&&o[a].length>0){const u=o[a],x=u&&u.length>0?u[0]:void 0;S(l=>({...l,[a]:{isOnline:!0,lastSeen:x?.lastSeen||new Date().toISOString()}}))}},500+N*50)}),n.set(a,f),w.set(a,f)},N*10)}),()=>{w.forEach((a,N)=>{d.removeChannel(a),n.delete(N)}),w.clear()}},[A,E,g]);const F=i.useCallback(n=>v[n]||{isOnline:!1,lastSeen:null},[v]);return{presence:v,getChildStatus:F,isChildOnline:n=>v[n]?.isOnline||!1}}export{ce as A,de as u};

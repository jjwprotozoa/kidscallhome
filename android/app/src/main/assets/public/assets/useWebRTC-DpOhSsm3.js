import{j as T,aP as F,aQ as z,aR as Y,Z as B,aS as J,r as S}from"./vendor-react-mDIoga_b.js";import{B as H,a as n,r as W,s as q}from"./index-BdmHsoQZ.js";const Q=({isMuted:w,isVideoOff:m,onToggleMute:l,onToggleVideo:y,onEndCall:x})=>T.jsxs("div",{className:"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4",children:[T.jsx(H,{onClick:l,size:"lg",variant:w?"destructive":"secondary",className:"rounded-full w-16 h-16",children:w?T.jsx(F,{className:"h-6 w-6"}):T.jsx(z,{className:"h-6 w-6"})}),T.jsx(H,{onClick:y,size:"lg",variant:m?"destructive":"secondary",className:"rounded-full w-16 h-16",children:m?T.jsx(Y,{className:"h-6 w-6"}):T.jsx(B,{className:"h-6 w-6"})}),T.jsx(H,{onClick:x,size:"lg",variant:"destructive",className:"rounded-full w-16 h-16",children:T.jsx(J,{className:"h-6 w-6"})})]}),ee=({localVideoRef:w,remoteVideoRef:m,remoteStream:l,isConnecting:y,isMuted:x,isVideoOff:L,onToggleMute:I,onToggleVideo:U,onEndCall:_,peerConnection:V})=>{const[b,M]=S.useState("waiting"),D=S.useRef(!1);S.useEffect(()=>{if(!l||!m.current){M("waiting");return}const d=m.current;d.srcObject!==l&&(console.log("üé¨ [VIDEO UI] Setting remote stream to video element"),d.srcObject=l);const O={current:b},f=o=>{O.current=o,M(o)};f("loading");const R=async()=>{if(d.paused)try{console.log("üé¨ [VIDEO UI] Attempting to play video"),await d.play(),console.log("‚úÖ [VIDEO UI] Video started playing"),D.current=!0,f("playing")}catch(o){if(console.log("‚è≥ [VIDEO UI] Play error:",o.name),o.name==="NotAllowedError"){d.muted=!0;try{await d.play(),console.log("‚úÖ [VIDEO UI] Playing muted - click to unmute"),f("playing")}catch(u){console.error("‚ùå [VIDEO UI] Even muted play failed:",u),f("error")}}else o.name==="NotSupportedError"&&(console.error("‚ùå [VIDEO UI] Media format not supported"),f("error"))}},P=()=>{console.log("üìπ [VIDEO UI] Video metadata loaded"),f("loading"),R()},i=()=>{console.log("üìπ [VIDEO UI] Video data loaded"),R()},e=()=>{console.log("üìπ [VIDEO UI] Video can play"),R()},k=()=>{console.log("‚úÖ [VIDEO UI] Video 'playing' event fired"),f("playing"),D.current=!0},E=()=>{console.log("üìπ [VIDEO UI] Video can play through"),d.paused||f("playing")},C=()=>{console.log("‚è≥ [VIDEO UI] Video 'waiting' event - buffering"),d.paused&&O.current!=="error"&&f("loading")},t=()=>{console.log("‚è∏Ô∏è [VIDEO UI] Video paused")},a=o=>{const u=o.target;console.error("‚ùå [VIDEO UI] Video error:",u.error),f("error")};d.addEventListener("loadedmetadata",P),d.addEventListener("loadeddata",i),d.addEventListener("canplay",e),d.addEventListener("canplaythrough",E),d.addEventListener("playing",k),d.addEventListener("waiting",C),d.addEventListener("pause",t),d.addEventListener("error",a);const r=l.getTracks(),c=new Map,s=()=>{const o=r.some(A=>!A.muted&&A.readyState==="live"),u=!d.paused;return o&&u?(console.log("‚úÖ [VIDEO UI] Tracks unmuted and video playing - marking as playing"),f("playing"),!0):!1};r.forEach(o=>{const u=()=>{console.log("‚úÖ [VIDEO UI] Track unmuted:",o.kind,"- ICE connected, media flowing"),d.paused?R():setTimeout(()=>{s()},100)},A=()=>{console.log("‚ö†Ô∏è [VIDEO UI] Track muted:",o.kind),r.every(v=>v.muted)&&O.current==="playing"&&(console.log("‚ö†Ô∏è [VIDEO UI] All tracks muted, setting to loading"),f("loading"))},p=()=>{console.log("üîö [VIDEO UI] Track ended:",o.kind)};o.addEventListener("unmute",u),o.addEventListener("mute",A),o.addEventListener("ended",p),c.set(o,{handleUnmute:u,handleMute:A,handleEnded:p})});const g=setInterval(()=>{d.paused||r.some(u=>!u.muted&&u.readyState==="live")&&O.current==="loading"&&(console.log("‚úÖ [VIDEO UI] Video playing with unmuted tracks - updating state"),f("playing"))},500);return R(),()=>{clearInterval(g),d.removeEventListener("loadedmetadata",P),d.removeEventListener("loadeddata",i),d.removeEventListener("canplay",e),d.removeEventListener("canplaythrough",E),d.removeEventListener("playing",k),d.removeEventListener("waiting",C),d.removeEventListener("pause",t),d.removeEventListener("error",a),c.forEach((o,u)=>{u.removeEventListener("unmute",o.handleUnmute),u.removeEventListener("mute",o.handleMute),u.removeEventListener("ended",o.handleEnded)})}},[l,m]);const j=()=>{if(!m.current||!m.current.srcObject)return;const d=m.current;console.log("üëÜ [VIDEO UI] User clicked video area",{paused:d.paused,muted:d.muted,readyState:d.readyState}),d.muted&&(d.muted=!1,console.log("üîä [VIDEO UI] Video unmuted by user click")),d.paused&&d.play().then(()=>{console.log("‚úÖ [VIDEO UI] Video started playing after click"),M("playing")}).catch(O=>{console.error("‚ùå [VIDEO UI] Click play failed:",O),d.muted=!0,d.play().catch(f=>console.error("Muted play also failed:",f))})},h=l?b==="error"?"Video error - click to retry":b==="loading"?"Connecting to other side...":m.current?.paused&&b!=="playing"?"Click to start video":m.current?.muted?"Video is muted - click to unmute":null:y?"Connecting...":"Waiting for other person...";return T.jsx("div",{className:"fixed inset-0 bg-black",onClick:j,children:T.jsxs("div",{className:"relative h-full w-full",children:[T.jsx("video",{ref:m,autoPlay:!0,playsInline:!0,muted:!1,volume:1,className:"w-full h-full object-cover",style:{backgroundColor:"#000"}}),h&&T.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 cursor-pointer",onClick:j,children:T.jsxs("div",{className:"text-center space-y-4",children:[T.jsx("div",{className:"text-6xl",children:b==="error"?"‚ùå":b==="loading"?"‚è≥":"üìû"}),T.jsx("p",{className:"text-white text-2xl",children:h}),l&&T.jsx("p",{className:"text-white text-sm opacity-75",children:b==="loading"?"Establishing connection...":b==="error"?"Check your connection":"Tap anywhere to interact"})]})}),!1,T.jsx("div",{className:"absolute top-4 right-4 w-48 h-36 rounded-2xl overflow-hidden shadow-xl border-2 border-white",children:T.jsx("video",{ref:w,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})}),T.jsx(Q,{isMuted:x,isVideoOff:L,onToggleMute:I,onToggleVideo:U,onEndCall:_})]})})},te=(w,m,l,y=!1)=>{const[x,L]=S.useState(null),[I,U]=S.useState(null),[_,V]=S.useState(!0),[b,M]=S.useState(!1),D=S.useRef(null),j=S.useRef(null),$=S.useRef([]),h=S.useRef(null),d=S.useRef(new Set),O=S.useRef(w);S.useEffect(()=>{O.current=w},[w]);const f=S.useCallback(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){const t=/iPad|iPhone|iPod/.test(navigator.userAgent),a=window.location.protocol==="https:",r=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.startsWith("192.168.")||window.location.hostname.startsWith("10.")||window.location.hostname.startsWith("172.");let c="Camera and microphone access is not available.";throw t&&!a&&!r?c+=`

On iOS Safari, camera/microphone requires HTTPS when accessing via network IP. Options:
1. Use a tunneling service like ngrok (provides HTTPS)
2. Set up local HTTPS certificates
3. Test on the same device using localhost`:t&&!a?c+=`

Note: On iOS, getUserMedia may not work over HTTP on network IPs. Consider using ngrok or testing on the same device.`:t?c+=" On iOS, please use Safari and grant camera/microphone permissions in Settings.":c+=" Please use HTTPS or a modern browser that supports WebRTC.",new Error(c)}let i;try{n.log("üé• [MEDIA] Requesting camera and microphone access..."),i=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),n.log("‚úÖ [MEDIA] Media stream obtained:",{audioTracks:i.getAudioTracks().map(a=>({id:a.id,enabled:a.enabled,muted:a.muted,readyState:a.readyState,settings:a.getSettings()})),videoTracks:i.getVideoTracks().map(a=>({id:a.id,enabled:a.enabled,muted:a.muted,readyState:a.readyState,settings:a.getSettings()}))});const t=y?"child":"parent";n.log("[KCH]",t,"media tracks",{audio:i.getAudioTracks().length,video:i.getVideoTracks().length}),i.getAudioTracks().forEach(a=>{a.muted&&n.warn("‚ö†Ô∏è [MEDIA] Local audio track is muted")}),i.getVideoTracks().forEach(a=>{a.muted&&n.warn("‚ö†Ô∏è [MEDIA] Local video track is muted")})}catch(t){const a=t;if(n.error("‚ùå [MEDIA] Media device access error:",{name:a.name,message:a.message,code:a.code}),a.name==="NotReadableError"||a.name==="NotAllowedError"){n.warn("‚ö†Ô∏è [MEDIA] Media device access denied or in use, trying audio-only fallback...");try{i=await navigator.mediaDevices.getUserMedia({video:!1,audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),n.log("‚úÖ [MEDIA] Fell back to audio-only stream")}catch(r){const c=r;throw n.error("‚ùå [MEDIA] Audio-only fallback also failed:",{name:c.name,message:c.message}),new Error(`Unable to access camera/microphone: ${a.message}. This may happen if the device is in use by another application or browser tab. On iOS, make sure you've granted camera and microphone permissions in Settings. Error details: ${a.name} - ${a.message}`)}}else throw new Error(`Media access error: ${a.name} - ${a.message}. Please check your camera and microphone permissions.`)}L(i),j.current=i,m.current&&(m.current.srcObject=i,m.current.play().catch(t=>{n.error("Error playing local video:",t)}));const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"turn:openrelay.metered.ca:80",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443",username:"openrelayproject",credential:"openrelayproject"}],iceCandidatePoolSize:10});e.onconnectionstatechange=()=>{const t=e.connectionState,a=e.iceConnectionState,r=e.signalingState,c=y?"child":"parent";if(n.log("[KCH]",c,"connectionState",t),n.log("üîµ [CONNECTION STATE] Peer connection state changed:",{connectionState:t,iceConnectionState:a,signalingState:r,timestamp:new Date().toISOString()}),t==="connected"){if(n.log("‚úÖ [CONNECTION STATE] Peer connection is now connected!"),n.log("üìä [CONNECTION STATE] Connection details:",{connectionState:t,iceConnectionState:a,signalingState:r,localDescription:!!e.localDescription,remoteDescription:!!e.remoteDescription,remoteStream:!!h.current}),h.current){const s=h.current.getAudioTracks(),g=h.current.getVideoTracks();n.log("üìä [CONNECTION STATE] Remote stream tracks when connected:",{audioTracks:s.map(o=>({id:o.id,enabled:o.enabled,muted:o.muted,readyState:o.readyState})),videoTracks:g.map(o=>({id:o.id,enabled:o.enabled,muted:o.muted,readyState:o.readyState}))}),s.forEach(o=>{o.muted&&n.error("‚ùå [CONNECTION STATE] Audio track is muted when connected!")}),g.forEach(o=>{o.muted&&o.readyState==="live"&&n.warn("‚ö†Ô∏è [CONNECTION STATE] Video track is muted when connected (user may have muted it)",{trackId:o.id,readyState:o.readyState,enabled:o.enabled})})}}else if(t==="failed"||t==="closed"||t==="disconnected"){n.error("‚ùå [CONNECTION STATE] Connection problem detected:",{connectionState:t,iceConnectionState:a,signalingState:r,reason:"Connection state changed to problematic state",timestamp:new Date().toISOString()});const s=O.current;s&&(t==="failed"||t==="closed")&&W({callId:s,by:y?"child":"parent",reason:t}).catch(()=>{})}};let k=Date.now();const E=3e4;e.oniceconnectionstatechange=()=>{const t=e.iceConnectionState,a=Date.now()-k,r=y?"child":"parent";if(n.log("[KCH]",r,"iceConnectionState",t),n.log("üßä [ICE STATE] ICE connection state changed:",{iceConnectionState:t,connectionState:e.connectionState,signalingState:e.signalingState,hasLocalDescription:!!e.localDescription,hasRemoteDescription:!!e.remoteDescription,iceGatheringState:e.iceGatheringState,timeInStateMs:a,timestamp:new Date().toISOString()}),k=Date.now(),t==="connected"||t==="completed"){if(n.log("‚úÖ [ICE STATE] ICE connection established - media should flow now!"),M(!0),V(!1),h.current&&l.current){const c=h.current,s=l.current;s.srcObject!==c&&(n.log("üé¨ [ICE STATE] Setting remote stream to video element"),s.srcObject=c);const g=c.getAudioTracks(),o=c.getVideoTracks();n.log("üìä [ICE STATE] Tracks after ICE connected:",{audioTracks:g.length,videoTracks:o.length,audioMuted:g.filter(p=>p.muted).length,videoMuted:o.filter(p=>p.muted).length,videoReadyState:s.readyState,videoPaused:s.paused}),g.forEach(p=>{p.enabled=!0,p.muted&&n.warn("‚ö†Ô∏è [ICE STATE] Audio track is muted after ICE connected")}),o.forEach(p=>{p.enabled=!0,p.muted&&n.warn("‚ö†Ô∏è [ICE STATE] Video track is muted after ICE connected")});const u=()=>{s&&s.srcObject&&s.paused&&(n.log("üé¨ [ICE STATE] Attempting to play video after ICE connection"),s.play().then(()=>{n.log("‚úÖ [ICE STATE] Video started playing after ICE connected")}).catch(p=>{n.warn("‚è≥ [ICE STATE] Play failed, will retry:",p.name),setTimeout(()=>{s&&s.srcObject&&s.paused&&s.play().catch(N=>{N.name!=="AbortError"&&n.error("‚ùå [ICE STATE] Retry play failed:",N)})},200)}))};u();const A=()=>{s.paused&&u()};s.addEventListener("canplay",A,{once:!0}),s.addEventListener("loadeddata",A,{once:!0}),s.addEventListener("canplaythrough",A,{once:!0}),setTimeout(()=>{const p=c.getAudioTracks().filter(v=>v.muted).length,N=c.getVideoTracks().filter(v=>v.muted).length;(p>0||N>0)&&n.error("‚ùå [ICE STATE] CRITICAL: Tracks still muted after ICE connected!",{mutedAudio:p,mutedVideo:N,totalAudio:g.length,totalVideo:o.length}),s.paused&&u()},1e3)}}else if(t==="failed"||t==="disconnected"||t==="closed"){n.error("‚ùå [ICE STATE] ICE connection problem:",{iceConnectionState:t,connectionState:e.connectionState,reason:"ICE connection failed or disconnected",timestamp:new Date().toISOString()}),M(!1),V(!1);const c=O.current;c&&(t==="failed"||t==="closed")&&W({callId:c,by:y?"child":"parent",reason:t}).catch(()=>{})}else t==="checking"?(M(!1),V(!0),n.log("‚è≥ [ICE STATE] ICE connection checking - waiting for connection (this is normal)..."),setTimeout(()=>{if(e.iceConnectionState==="checking"&&e.signalingState!=="closed"){n.warn("‚ö†Ô∏è [ICE STATE] ICE stuck in 'checking' state for 30+ seconds - this may indicate:",{issue:"ICE candidates may not be exchanging properly or connection is failing",hasLocalDescription:!!e.localDescription,hasRemoteDescription:!!e.remoteDescription,iceGatheringState:e.iceGatheringState,connectionState:e.connectionState,suggestion:"Check that ICE candidates are being sent/received via database and that both peers have remote descriptions set"});const c=e.getSenders(),s=e.getReceivers();n.warn("‚ö†Ô∏è [ICE STATE] Current peer connection state:",{senders:c.length,receivers:s.length,localDescription:e.localDescription?{type:e.localDescription.type,sdp:e.localDescription.sdp.substring(0,100)+"..."}:null,remoteDescription:e.remoteDescription?{type:e.remoteDescription.type,sdp:e.remoteDescription.sdp.substring(0,100)+"..."}:null})}},E)):t==="new"&&(n.log("üÜï [ICE STATE] ICE connection new - connection starting (this is normal)..."),M(!1),V(!0),setTimeout(()=>{e.iceConnectionState==="new"&&e.signalingState!=="closed"&&n.warn("‚ö†Ô∏è [ICE STATE] ICE stuck in 'new' state for 30+ seconds - this may indicate:",{issue:"ICE candidates may not be exchanging properly",hasLocalDescription:!!e.localDescription,hasRemoteDescription:!!e.remoteDescription,iceGatheringState:e.iceGatheringState,suggestion:"Check that ICE candidates are being sent/received via database"})},E))},e.onicegatheringstatechange=()=>{n.log("üßä [ICE GATHERING] ICE gathering state:",{iceGatheringState:e.iceGatheringState,timestamp:new Date().toISOString()})},e.onsignalingstatechange=()=>{n.log("Signaling state changed to:",e.signalingState),e.signalingState==="closed"&&n.error("Signaling state is closed!")},D.current=e,d.current.clear(),h.current=null,i.getTracks().forEach(t=>{e.addTrack(t,i)}),e.ontrack=t=>{if(n.log("üìπ [REMOTE TRACK] Received remote track:",{kind:t.track.kind,id:t.track.id,enabled:t.track.enabled,readyState:t.track.readyState,muted:t.track.muted,streams:t.streams.length,connectionState:e.connectionState,iceConnectionState:e.iceConnectionState,timestamp:new Date().toISOString()}),t.track.onmute=()=>{n.warn("‚ö†Ô∏è [REMOTE TRACK] Track muted:",{kind:t.track.kind,id:t.track.id,reason:"Track is muted - no data being received",iceConnectionState:e.iceConnectionState,connectionState:e.connectionState})},t.track.onunmute=()=>{if(n.log("‚úÖ [REMOTE TRACK] Track unmuted - MEDIA IS FLOWING!",{kind:t.track.kind,id:t.track.id,reason:"Track is receiving data - media should be visible/audible now",iceConnectionState:e.iceConnectionState,connectionState:e.connectionState}),t.track.kind==="video"&&l.current){const r=l.current;r.srcObject?(n.log("üé¨ [REMOTE TRACK] Video track unmuted - ensuring video plays",{readyState:r.readyState,paused:r.paused,muted:r.muted}),r.paused?r.play().then(()=>{n.log("‚úÖ [REMOTE TRACK] Video started playing after track unmute")}).catch(c=>{c.name!=="AbortError"&&(n.error("‚ùå [REMOTE TRACK] Error playing video after track unmute:",c),setTimeout(()=>{r&&r.srcObject&&r.paused&&r.play().catch(s=>{s.name!=="AbortError"&&n.error("‚ùå [REMOTE TRACK] Retry play failed:",s)})},200))}):n.log("‚úÖ [REMOTE TRACK] Video is already playing")):(n.warn("‚ö†Ô∏è [REMOTE TRACK] Video track unmuted but video element has no srcObject - setting it now"),l.current&&h.current&&(l.current.srcObject=h.current,setTimeout(()=>{l.current&&l.current.paused&&l.current.play().catch(c=>{c.name!=="AbortError"&&n.error("‚ùå [REMOTE TRACK] Error playing after setting srcObject:",c)})},100)))}},t.track.onended=()=>{n.log("‚ÑπÔ∏è [REMOTE TRACK] Track ended (expected when call ends):",{kind:t.track.kind,id:t.track.id,reason:"Track has ended - this is normal when call is terminated"})},d.current.has(t.track.id)){n.log("Track already processed, skipping:",t.track.id);return}d.current.add(t.track.id),t.track.enabled=!0;let a=h.current;if(t.streams.length>0){const[r]=t.streams;!a||a.id!==r.id?(a=r,h.current=a):a.getTracks().find(s=>s.id===t.track.id)||(a.addTrack(t.track),n.log("Added track to existing stream:",t.track.kind))}else a?a.getTracks().find(c=>c.id===t.track.id)||(a.addTrack(t.track),n.log("Added track to existing stream:",t.track.kind)):(a=new MediaStream([t.track]),h.current=a,n.log("Created new stream for track:",t.track.kind));if(a){if(a.getAudioTracks().forEach(r=>{r.enabled=!0,r.muted&&e.iceConnectionState==="connected"&&n.warn("‚ö†Ô∏è [REMOTE TRACK] Audio track is muted even though ICE is connected - this may indicate no data"),n.log("‚úÖ [REMOTE TRACK] Enabled remote audio track:",{id:r.id,enabled:r.enabled,muted:r.muted,readyState:r.readyState,iceConnectionState:e.iceConnectionState})}),a.getVideoTracks().forEach(r=>{r.enabled=!0,r.muted&&e.iceConnectionState==="connected"&&n.warn("‚ö†Ô∏è [REMOTE TRACK] Video track is muted even though ICE is connected - this may indicate no data"),n.log("‚úÖ [REMOTE TRACK] Enabled remote video track:",{id:r.id,enabled:r.enabled,muted:r.muted,readyState:r.readyState,iceConnectionState:e.iceConnectionState})}),e.iceConnectionState==="connected"||e.iceConnectionState==="completed"){const r=a.getAudioTracks().filter(s=>s.muted).length,c=a.getVideoTracks().filter(s=>s.muted).length;(r>0||c>0)&&n.error("‚ùå [REMOTE TRACK] CRITICAL: Tracks are muted even though ICE is connected!",{mutedAudioTracks:r,mutedVideoTracks:c,totalAudioTracks:a.getAudioTracks().length,totalVideoTracks:a.getVideoTracks().length,iceConnectionState:e.iceConnectionState,connectionState:e.connectionState,signalingState:e.signalingState})}if(n.log("Remote stream updated:",{id:a.id,audioTracks:a.getAudioTracks().length,videoTracks:a.getVideoTracks().length}),U(a),l.current){const r=l.current;r.srcObject!==a?(r.srcObject=a,n.log("‚úÖ [REMOTE STREAM] Remote stream srcObject set",{streamId:a.id,audioTracks:a.getAudioTracks().length,videoTracks:a.getVideoTracks().length,iceConnectionState:e.iceConnectionState,connectionState:e.connectionState})):n.log("‚úÖ [REMOTE STREAM] Stream already set, ensuring playback",{streamId:a.id,audioTracks:a.getAudioTracks().length,videoTracks:a.getVideoTracks().length});const s=()=>{if(!r||!r.srcObject){n.warn("‚ö†Ô∏è [REMOTE STREAM] Video or srcObject not ready for play");return}n.log("üé¨ [REMOTE STREAM] Attempting to play video with tracks",{readyState:r.readyState,paused:r.paused,muted:r.muted,audioTracks:a.getAudioTracks().length,videoTracks:a.getVideoTracks().length,audioMuted:a.getAudioTracks().some(g=>g.muted),videoMuted:a.getVideoTracks().some(g=>g.muted),iceConnectionState:e.iceConnectionState}),r.paused?r.play().then(()=>{n.log("‚úÖ [REMOTE STREAM] Video started playing"),setTimeout(()=>{const g=a.getAudioTracks().filter(u=>u.muted).length,o=a.getVideoTracks().filter(u=>u.muted).length;(g>0||o>0)&&n.warn("‚ö†Ô∏è [REMOTE STREAM] Some tracks still muted after play - they should unmute when media flows",{audioMuted:g,videoMuted:o,iceConnectionState:e.iceConnectionState})},1e3)}).catch(g=>{n.log("‚è≥ [REMOTE STREAM] Play failed, will retry:",g.name),setTimeout(()=>{r&&r.srcObject&&r.paused&&r.play().catch(o=>{o.name!=="AbortError"&&n.log("‚è≥ [REMOTE STREAM] Retry play failed:",o.name)})},200)}):n.log("‚úÖ [REMOTE STREAM] Video is already playing")};requestAnimationFrame(()=>{s()}),setTimeout(()=>{r&&r.srcObject&&r.paused&&s()},100)}else n.warn("‚ö†Ô∏è [REMOTE STREAM] remoteVideoRef.current is null - video element not ready")}};const C=new Set;e.onicecandidate=async t=>{const a=O.current;if(!a){n.warn("‚ö†Ô∏è [ICE CANDIDATE] No callId available yet, candidate will be queued");return}try{if(t.candidate===null){n.log("üßä [ICE CANDIDATE] ICE gathering complete (null candidate received)"),n.log("üßä [ICE CANDIDATE] Total candidates processed:",C.size);return}if(t.candidate){const r=t.candidate.toJSON(),c=`${r.candidate}-${r.sdpMLineIndex}-${r.sdpMid}`;if(C.has(c))return;C.add(c);const s=C.size,g=y?"child":"parent";s===1&&n.log("üßä [ICE CANDIDATE] ICE gathering started:",{role:g,callId:a,isChild:y,timestamp:new Date().toISOString()});const o=y?"child_ice_candidates":"parent_ice_candidates";s===1&&n.log("üîç [ICE CANDIDATE] Role verification:",{isChild:y,role:g,candidateField:o,expectedField:y?"child_ice_candidates":"parent_ice_candidates",matches:o===(y?"child_ice_candidates":"parent_ice_candidates")});const{data:u,error:A}=await q.from("calls").select(o).eq("id",a).maybeSingle();if(A){n.error(`‚ùå [ICE CANDIDATE] Error reading ${o}:`,A);return}if(u){const p=u[o]||[];if(!p.some(v=>v.candidate===r.candidate&&v.sdpMLineIndex===r.sdpMLineIndex&&v.sdpMid===r.sdpMid)){const v=[...p,r],{error:K}=await q.from("calls").update({[o]:v}).eq("id",a);if(K)n.error(`‚ùå [ICE CANDIDATE] Error updating ${o}:`,K),(K.message?.includes("column")||K.code==="PGRST204")&&n.error(`‚ùå [ICE CANDIDATE] Database column ${o} may not exist. Run fix_ice_candidates_schema.sql migration!`);else{const G=v.length;(G<=3||G%20===0)&&n.log(`‚úÖ [ICE CANDIDATE] Candidate #${G} sent to ${o}`)}}}else n.warn(`‚ö†Ô∏è [ICE CANDIDATE] Call ${a} not found in database`)}}catch(r){n.error("‚ùå [ICE CANDIDATE] Error handling ICE candidate:",r)}}}catch(i){throw i}},[w,m,l,y]),R=S.useCallback((i=!1)=>{const e=D.current,k=e?.iceConnectionState,E=e?.connectionState;if(n.log("üßπ [CLEANUP] Cleaning up WebRTC resources...",{timestamp:new Date().toISOString(),connectionState:E,iceConnectionState:k,signalingState:e?.signalingState,hasLocalStream:!!j.current,hasRemoteStream:!!h.current,force:i}),!i){const t=e?Date.now()-e._iceStateStartTime||Date.now():0,a=k==="new"&&t<5e3;if(k==="new"&&a||k==="checking")return}const C=j.current;C&&(C.getTracks().forEach(t=>{t.stop(),n.log("Stopped track:",t.kind)}),j.current=null,L(null)),m.current?.srcObject&&(m.current.srcObject.getTracks().forEach(a=>{a.stop(),n.log("Stopped track from video element:",a.kind)}),m.current.srcObject=null),l.current?.srcObject&&(l.current.srcObject=null),e&&(e.signalingState!=="closed"&&(n.log("Closing peer connection, current state:",e.signalingState),e.close()),D.current=null),U(null),h.current=null,d.current.clear()},[m,l]),P=S.useCallback(()=>{const i=l.current;if(!i)return;const e=h.current||I;if(!e)return;n.log("playRemoteVideo called",{hasVideo:!!i,hasStream:!!e,currentSrcObject:!!i.srcObject,paused:i.paused,readyState:i.readyState,audioTracks:e.getAudioTracks().length,videoTracks:e.getVideoTracks().length}),i.srcObject!==e&&(i.srcObject=e);const k=()=>{if(n.log("üé¨ [VIDEO PLAY] Attempting to play video:",{hasSrcObject:!!i.srcObject,readyState:i.readyState,paused:i.paused,muted:i.muted,timestamp:new Date().toISOString()}),!i.srcObject){setTimeout(k,50);return}const E=i.srcObject,C=E&&(E.getAudioTracks().some(t=>!t.muted&&t.readyState==="live")||E.getVideoTracks().some(t=>!t.muted&&t.readyState==="live"));if(i.readyState<2&&!C){n.log("‚è≥ [VIDEO PLAY] Waiting for video readyState >= 2 or unmuted tracks (current:",i.readyState,")");const t=()=>{const a=E&&(E.getAudioTracks().some(r=>!r.muted&&r.readyState==="live")||E.getVideoTracks().some(r=>!r.muted&&r.readyState==="live"));(i.readyState>=2||a)&&(n.log("‚úÖ [VIDEO PLAY] Video ready, readyState:",i.readyState,"- attempting play"),i.paused&&i.play().catch(r=>{}))};if(i.addEventListener("loadeddata",t,{once:!0}),i.addEventListener("canplay",t,{once:!0}),i.addEventListener("canplaythrough",t,{once:!0}),E){const a=()=>{(E.getAudioTracks().some(c=>!c.muted&&c.readyState==="live")||E.getVideoTracks().some(c=>!c.muted&&c.readyState==="live"))&&i.paused&&i.play().catch(c=>{})};E.getTracks().forEach(r=>{r.addEventListener("unmute",a,{once:!0})})}return}if(C&&i.readyState<2&&n.log("üé¨ [VIDEO PLAY] Tracks are unmuted, attempting play despite low readyState:",i.readyState),i.paused){n.log("üé¨ [VIDEO PLAY] Video ready (readyState:",i.readyState,"), attempting play");const t=i.play();t!==void 0&&t.then(()=>{n.log("üìä [VIDEO PLAY] Video state:",{paused:i.paused,muted:i.muted,volume:i.volume,readyState:i.readyState})}).catch(a=>{a.name==="NotAllowedError"||a.name!=="AbortError"&&(n.log("‚è≥ [VIDEO PLAY] Play failed, retrying after delay:",a.name),setTimeout(()=>{i.readyState>=2&&i.paused&&i.play().catch(r=>{})},100))})}};requestAnimationFrame(()=>{k()})},[I]);return S.useEffect(()=>{if(I&&l.current){l.current.srcObject!==I&&(l.current.srcObject=I,requestAnimationFrame(()=>{l.current&&l.current.srcObject===I&&l.current.play().then(()=>{}).catch(e=>{n.log("‚è≥ [REMOTE STREAM] Play failed in useEffect (will retry):",e.name)})}));const i=setInterval(()=>{const e=l.current;if(!e||!e.srcObject)return;const k=e.srcObject,E=k.getAudioTracks(),C=k.getVideoTracks(),t=D.current;E.some(c=>c.muted),C.some(c=>c.muted);const a=e.paused,r=t?.iceConnectionState;t?.connectionState,a&&r==="connected"&&e.play().catch(()=>{})},5e3);return n.log("üìπ [REMOTE STREAM] Remote stream in useEffect:",{id:I.id,audioTracks:I.getAudioTracks().map(e=>({id:e.id,enabled:e.enabled,muted:e.muted,readyState:e.readyState})),videoTracks:I.getVideoTracks().map(e=>({id:e.id,enabled:e.enabled,muted:e.muted,readyState:e.readyState}))}),()=>{clearInterval(i)}}},[I]),{peerConnection:D.current,localStream:x,remoteStream:I,isConnecting:_,setIsConnecting:V,isConnected:b,initializeConnection:f,cleanup:R,iceCandidatesQueue:$,peerConnectionRef:D,playRemoteVideo:P}};export{ee as V,te as u};

# codemagic.yaml
# Codemagic CI/CD configuration for KidsCallHome Android native app
# Simplified version - requires Android project to be properly committed

workflows:
  android-build:
    name: Android Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - android_keystore
        - google_play
      node: 20
      java: 17
      vars:
        PACKAGE_NAME: "com.kidscallhome.app"
        APP_NAME: "Kids Call Home"
    scripts:
      - name: Install dependencies
        script: |
          npm ci

      - name: Build web app
        script: |
          npm run build

      - name: Sync Capacitor
        script: |
          npx cap sync android

      - name: Set up Android keystore
        script: |
          if [ ! -z "$CM_KEYSTORE_PATH" ]; then
            echo "âœ… Using keystore from CM_KEYSTORE_PATH"
          else
            echo "âš ï¸ No keystore configured, using debug signing"
          fi

      - name: Verify Java version and configure Gradle
        script: |
          echo "=== Java Environment Setup ==="
          echo "Java version:"
          java -version
          echo ""
          echo "JAVA_HOME before: $JAVA_HOME"

          # Ensure JAVA_HOME is set and points to Java 17
          # Codemagic sets java: 17, but JAVA_HOME might not be set
          if [ -z "$JAVA_HOME" ]; then
            # Try to find Java 17 using macOS java_home utility
            export JAVA_HOME=$(/usr/libexec/java_home -v 17 2>/dev/null || echo "")
            if [ -z "$JAVA_HOME" ]; then
              # Fallback: find any Java 17+ installation
              export JAVA_HOME=$(/usr/libexec/java_home -v 17+ 2>/dev/null || echo "")
            fi
            echo "Set JAVA_HOME to: $JAVA_HOME"
          fi

          # Verify JAVA_HOME points to a valid Java 17 installation
          if [ ! -z "$JAVA_HOME" ] && [ -f "$JAVA_HOME/bin/java" ]; then
            echo "JAVA_HOME after: $JAVA_HOME"
            echo "Java version from JAVA_HOME:"
            "$JAVA_HOME/bin/java" -version
            JAVA_VERSION_OUTPUT=$("$JAVA_HOME/bin/java" -version 2>&1)
            if echo "$JAVA_VERSION_OUTPUT" | grep -qE 'version "1\.[0-8]\.'; then
              echo "âŒ ERROR: JAVA_HOME points to Java 8 or earlier!"
              echo "Java version output: $JAVA_VERSION_OUTPUT"
              exit 1
            fi
            echo "âœ… Java version is 11+"
          else
            echo "âŒ ERROR: JAVA_HOME is not set or invalid!"
            echo "Please ensure java: 17 is set in Codemagic environment"
            exit 1
          fi

          # Export JAVA_HOME for this script step
          export JAVA_HOME

          # Configure Gradle to use Java 17
          cd android
          chmod +x ./gradlew

          # Stop any existing Gradle daemons (they might be using Java 8)
          echo ""
          echo "=== Stopping Gradle daemons ==="
          ./gradlew --stop || true
          echo "âœ… Gradle daemons stopped"

          # Set org.gradle.java.home in gradle.properties to ensure Gradle uses Java 17
          # This is critical for buildscript classpath resolution
          echo ""
          echo "=== Configuring Gradle to use Java 17 ==="
          if [ -f gradle.properties ]; then
            # Remove any existing org.gradle.java.home line (macOS compatible sed)
            sed -i '' '/^org\.gradle\.java\.home=/d' gradle.properties 2>/dev/null || \
            sed -i.bak '/^org\.gradle\.java\.home=/d' gradle.properties 2>/dev/null || \
            grep -v '^org\.gradle\.java\.home=' gradle.properties > gradle.properties.tmp && mv gradle.properties.tmp gradle.properties
            # Add the correct Java home
            echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
            echo "âœ… Updated gradle.properties with org.gradle.java.home=$JAVA_HOME"
            echo "Verification - org.gradle.java.home setting:"
            grep "org.gradle.java.home" gradle.properties || echo "âš ï¸ Warning: org.gradle.java.home not found in gradle.properties"
          else
            echo "org.gradle.java.home=$JAVA_HOME" > gradle.properties
            echo "âœ… Created gradle.properties with org.gradle.java.home=$JAVA_HOME"
          fi

          # Verify Gradle wrapper will use correct Java
          echo ""
          echo "=== Verifying Gradle wrapper configuration ==="
          echo "Gradle wrapper will use: $JAVA_HOME/bin/java"

      - name: Diagnostic checks before build
        script: |
          cd android
          echo "=== PRE-BUILD DIAGNOSTICS ==="
          echo ""
          echo "1. Checking Java version:"
          java -version 2>&1 || echo "Java not found in PATH"
          echo ""
          echo "2. Checking JAVA_HOME:"
          echo "JAVA_HOME=$JAVA_HOME"
          if [ ! -z "$JAVA_HOME" ]; then
            "$JAVA_HOME/bin/java" -version 2>&1 || echo "Java at JAVA_HOME not working"
          fi
          echo ""
          echo "3. Checking Gradle wrapper:"
          ls -la gradlew* || echo "Gradle wrapper not found"
          echo ""
          echo "4. Testing Gradle can run:"
          ./gradlew --version 2>&1 | head -10 || echo "Gradle --version failed"
          echo ""
          echo "5. Testing Gradle can list tasks:"
          ./gradlew tasks --all 2>&1 | head -30 || echo "Gradle tasks failed"
          echo ""
          echo "6. Checking gradle.properties:"
          cat gradle.properties 2>&1 | head -20 || echo "gradle.properties not found"
          echo ""
          echo "7. Checking build.gradle files exist:"
          find . -name "build.gradle" -type f | head -10
          echo ""

      - name: Build Debug APK first (to verify build works)
        script: |
          cd android
          # Ensure JAVA_HOME is set
          if [ -z "$JAVA_HOME" ]; then
            export JAVA_HOME=$(/usr/libexec/java_home -v 17 2>/dev/null || /usr/libexec/java_home -v 17+ 2>/dev/null || echo "")
          fi
          if [ -z "$JAVA_HOME" ] || [ ! -f "$JAVA_HOME/bin/java" ]; then
            export JAVA_HOME=$(/usr/libexec/java_home -v 17)
          fi
          export JAVA_HOME

          # Ensure gradle.properties has org.gradle.java.home set
          if [ -f gradle.properties ]; then
            if ! grep -q "^org\.gradle\.java\.home=" gradle.properties; then
              echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
            fi
          else
            echo "org.gradle.java.home=$JAVA_HOME" > gradle.properties
          fi

          echo "=== Building Debug APK (to verify build works) ==="
          echo "Running: ./gradlew assembleDebug --stacktrace --info"
          echo ""
          echo "âš ï¸ If build fails, look for 'ğŸ“„ EXTRACTED ERROR MESSAGES' section below"
          echo ""

          # Build with output visible and captured
          set -o pipefail
          ./gradlew assembleDebug --stacktrace --info 2>&1 | tee debug-build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          # Immediately show if build failed (before detailed extraction)
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "ğŸš¨ğŸš¨ğŸš¨ BUILD FAILED! Extracting error messages... ğŸš¨ğŸš¨ğŸš¨"
          fi

          echo ""
          echo "=== Build completed with exit code: $BUILD_EXIT_CODE ==="
          echo ""

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            # Extract errors to a separate file for easy access
            echo "Extracting error messages..." > build-errors.txt
            
            echo "" >> build-errors.txt
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> build-errors.txt
            echo "âŒ BUILD FAILED - ERROR EXTRACTION" >> build-errors.txt
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> build-errors.txt
            echo "" >> build-errors.txt
            
            # Find the line number where "BUILD FAILED" appears
            FAIL_LINE=$(grep -n "BUILD FAILED" debug-build.log | tail -1 | cut -d: -f1)
            if [ ! -z "$FAIL_LINE" ]; then
              echo "Found 'BUILD FAILED' at line $FAIL_LINE" >> build-errors.txt
              echo "Showing 50 lines before and 200 lines after (error usually appears right after BUILD FAILED):" >> build-errors.txt
              echo "" >> build-errors.txt
              sed -n "$((FAIL_LINE - 50)),$((FAIL_LINE + 200))p" debug-build.log >> build-errors.txt
            fi
            
            echo "" >> build-errors.txt
            echo "=== FAILURE MESSAGES ===" >> build-errors.txt
            grep -A 30 "FAILURE:" debug-build.log >> build-errors.txt 2>/dev/null || echo "No FAILURE: found" >> build-errors.txt
            
            echo "" >> build-errors.txt
            echo "=== WHAT WENT WRONG ===" >> build-errors.txt
            grep -A 30 "What went wrong:" debug-build.log >> build-errors.txt 2>/dev/null || echo "No 'What went wrong:' found" >> build-errors.txt
            
            echo "" >> build-errors.txt
            echo "=== EXECUTION FAILED FOR TASK ===" >> build-errors.txt
            grep -B 10 -A 20 "Execution failed for task" debug-build.log >> build-errors.txt 2>/dev/null || echo "No task execution failures found" >> build-errors.txt
            
            echo "" >> build-errors.txt
            echo "=== FAILED TASKS ===" >> build-errors.txt
            grep "> Task :.*FAILED" debug-build.log >> build-errors.txt 2>/dev/null || echo "No failed tasks found" >> build-errors.txt
            
            echo "" >> build-errors.txt
            echo "=== ERROR PATTERNS ===" >> build-errors.txt
            grep -i -E "error|exception|failed|cannot|unable" debug-build.log | grep -v "at org.gradle" | head -50 >> build-errors.txt 2>/dev/null || echo "No error patterns found" >> build-errors.txt
            
            # Display the error file prominently
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒâŒâŒ BUILD FAILED WITH EXIT CODE $BUILD_EXIT_CODE âŒâŒâŒ"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“„ EXTRACTED ERROR MESSAGES (also saved to build-errors.txt):"
            echo ""
            cat build-errors.txt
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "=== FIRST 200 LINES OF BUILD LOG ==="
            head -n 200 debug-build.log
            echo ""
            echo "=== LAST 100 LINES OF BUILD LOG ==="
            tail -n 100 debug-build.log
            echo ""
            echo "ğŸ“‹ Full log: debug-build.log ($(wc -l < debug-build.log) lines)"
            echo "ğŸ“‹ Errors: build-errors.txt"
            exit 1
          fi

          echo "âœ… Build succeeded!"

          # Verify debug APK was created (only if build succeeded)
          echo ""
          echo "=== Verifying debug APK was created ==="
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… Debug APK created successfully!"
            ls -lh app/build/outputs/apk/debug/
          else
            echo "âš ï¸ Debug APK not found at expected location"
            echo "Searching for APK files..."
            find . -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APK files found anywhere"
            echo ""
            echo "Checking build outputs directory:"
            ls -la app/build/outputs/ 2>/dev/null || echo "app/build/outputs does not exist"
            ls -la app/build/ 2>/dev/null || echo "app/build does not exist"
          fi

      - name: Build Android App Bundle
        script: |
          cd android
          # Ensure JAVA_HOME is set (environment variables don't persist between steps)
          if [ -z "$JAVA_HOME" ]; then
            export JAVA_HOME=$(/usr/libexec/java_home -v 17 2>/dev/null || /usr/libexec/java_home -v 17+ 2>/dev/null || echo "")
          fi
          if [ -z "$JAVA_HOME" ] || [ ! -f "$JAVA_HOME/bin/java" ]; then
            echo "âŒ ERROR: JAVA_HOME is not set or invalid!"
            echo "Attempting to find Java 17..."
            export JAVA_HOME=$(/usr/libexec/java_home -v 17)
          fi
          export JAVA_HOME
          echo "Building with JAVA_HOME: $JAVA_HOME"

          # Ensure gradle.properties has org.gradle.java.home set (it should from previous step, but verify)
          if [ -f gradle.properties ]; then
            if ! grep -q "^org\.gradle\.java\.home=" gradle.properties; then
              echo "Setting org.gradle.java.home in gradle.properties..."
              echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
            fi
          else
            echo "Creating gradle.properties with org.gradle.java.home..."
            echo "org.gradle.java.home=$JAVA_HOME" > gradle.properties
          fi

          # Verify Java version
          echo "Java version:"
          "$JAVA_HOME/bin/java" -version

          # Clean build to ensure fresh state
          echo ""
          echo "=== Cleaning previous build ==="
          ./gradlew clean || true

          # Build with full error output
          echo ""
          echo "=== Building Android App Bundle (Release) ==="
          set -o pipefail
          ./gradlew bundleRelease --stacktrace --info 2>&1 | tee release-build.log
          BUNDLE_EXIT_CODE=${PIPESTATUS[0]}

          if [ $BUNDLE_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ Release build failed with exit code $BUNDLE_EXIT_CODE!"
            echo ""
            echo "=== FULL BUILD OUTPUT ==="
            cat release-build.log
            echo ""
            echo "=== Searching for specific errors ==="
            grep -i -A 10 -B 5 "error\|failed\|exception\|FAILURE" release-build.log | head -50 || echo "No obvious errors found"
            echo ""
            echo "âš ï¸ Release build failed. Trying to build debug bundle instead..."
            ./gradlew bundleDebug --stacktrace --info 2>&1 | tee debug-bundle.log
            DEBUG_BUNDLE_EXIT_CODE=${PIPESTATUS[0]}
            
            if [ $DEBUG_BUNDLE_EXIT_CODE -ne 0 ]; then
              echo ""
              echo "âŒ Debug bundle also failed!"
              echo "=== FULL DEBUG BUNDLE OUTPUT ==="
              cat debug-bundle.log
              exit 1
            else
              echo "âœ… Debug bundle built successfully!"
            fi
          else
            echo "âœ… Release bundle built successfully!"
          fi

          # Verify build artifacts were created (only if build succeeded)
          echo ""
          echo "=== Verifying build artifacts ==="
          echo "Checking for AAB files..."
          find app/build/outputs -name "*.aab" -type f 2>/dev/null | head -10 || echo "No AAB files found"
          echo ""
          echo "Checking for APK files..."
          find app/build/outputs -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APK files found"
          echo ""
          echo "Listing app/build/outputs directory structure:"
          ls -laR app/build/outputs/ 2>/dev/null | head -50 || echo "Outputs directory not found"
          echo ""
          echo "Full path to outputs:"
          pwd
          ls -la app/build/outputs/bundle/release/ 2>/dev/null || echo "Bundle release directory not found"
          ls -la app/build/outputs/bundle/debug/ 2>/dev/null || echo "Bundle debug directory not found"
          ls -la app/build/outputs/apk/release/ 2>/dev/null || echo "APK release directory not found"
          ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "APK debug directory not found"

      - name: Build Release APK (for testing)
        script: |
          cd android
          # Ensure JAVA_HOME is set (environment variables don't persist between steps)
          if [ -z "$JAVA_HOME" ]; then
            export JAVA_HOME=$(/usr/libexec/java_home -v 17 2>/dev/null || /usr/libexec/java_home -v 17+ 2>/dev/null || echo "")
          fi
          if [ -z "$JAVA_HOME" ] || [ ! -f "$JAVA_HOME/bin/java" ]; then
            echo "âŒ ERROR: JAVA_HOME is not set or invalid!"
            export JAVA_HOME=$(/usr/libexec/java_home -v 17)
          fi
          export JAVA_HOME
          echo "Building with JAVA_HOME: $JAVA_HOME"

          # Ensure gradle.properties has org.gradle.java.home set
          if [ -f gradle.properties ]; then
            if ! grep -q "^org\.gradle\.java\.home=" gradle.properties; then
              echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
            fi
          else
            echo "org.gradle.java.home=$JAVA_HOME" > gradle.properties
          fi

          # Build with full error output
          echo ""
          echo "=== Building Android Release APK ==="
          set -o pipefail
          ./gradlew assembleRelease --stacktrace --info 2>&1 | tee release-apk.log
          RELEASE_APK_EXIT_CODE=${PIPESTATUS[0]}

          if [ $RELEASE_APK_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ Release APK build failed with exit code $RELEASE_APK_EXIT_CODE!"
            echo ""
            echo "=== FULL BUILD OUTPUT ==="
            cat release-apk.log
            echo ""
            echo "=== Searching for specific errors ==="
            grep -i -A 10 -B 5 "error\|failed\|exception\|FAILURE" release-apk.log | head -50 || echo "No obvious errors found"
            echo ""
            echo "âš ï¸ Release APK build failed. Debug APK should already be available from earlier step."
            # Don't exit - debug APK is already built
          else
            echo "âœ… Release APK built successfully!"
          fi

          # Verify build artifacts were created
          echo ""
          echo "=== Verifying build artifacts ==="
          echo "Checking for APK files..."
          find app/build/outputs -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APK files found"
          echo ""
          echo "Listing app/build/outputs directory structure:"
          ls -laR app/build/outputs/ 2>/dev/null | head -50 || echo "Outputs directory not found"
          echo ""
          echo "Full path to outputs:"
          pwd
          ls -la app/build/outputs/apk/release/ 2>/dev/null || echo "APK release directory not found"
          ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "APK debug directory not found"

      - name: Verify artifacts from workspace root
        script: |
          echo "=== Verifying artifacts from workspace root ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "Looking for AAB files:"
          find . -name "*.aab" -type f 2>/dev/null | head -10 || echo "No AAB files found"
          echo ""
          echo "Looking for APK files:"
          find . -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APK files found"
          echo ""
          echo "Checking android/app/build/outputs:"
          if [ -d "android/app/build/outputs" ]; then
            echo "âœ… Outputs directory exists"
            ls -laR android/app/build/outputs/ | head -100
          else
            echo "âŒ Outputs directory does not exist!"
            echo "Listing android/app/build directory:"
            ls -la android/app/build/ 2>/dev/null || echo "android/app/build does not exist"
          fi

      - name: Artifact Summary and Download Instructions
        script: |
          echo "=========================================="
          echo "ğŸ“¦ ARTIFACT SUMMARY"
          echo "=========================================="
          echo ""
          echo "Finding all APK and AAB files:"
          find . -type f \( -name "*.apk" -o -name "*.aab" \) 2>/dev/null | while read file; do
            echo "  âœ… Found: $file ($(du -h "$file" | cut -f1))"
          done || echo "  âš ï¸ No APK/AAB files found"
          echo ""
          echo "=========================================="
          echo "ğŸ“¥ HOW TO DOWNLOAD ARTIFACTS"
          echo "=========================================="
          echo ""
          echo "After a successful build, download your app files from Codemagic:"
          echo ""
          echo "1. Go to your Codemagic dashboard"
          echo "2. Click on the completed build"
          echo "3. Scroll to the 'Artifacts' section"
          echo "4. Click the download button next to:"
          echo "   - *.apk files (for direct installation)"
          echo "   - *.aab files (for Google Play Store upload)"
          echo ""
          echo "Or use the Codemagic CLI:"
          echo "  codemagic-cli builds artifacts <build-id>"
          echo ""
          echo "Artifacts are automatically collected from:"
          echo "  - android/app/build/outputs/**/*.apk"
          echo "  - android/app/build/outputs/**/*.aab"
          echo ""

    artifacts:
      - android/app/build/outputs/**/*.aab
      - android/app/build/outputs/**/*.apk
      - android/app/build/outputs/bundle/**/*
      - android/app/build/outputs/apk/**/*
      - android/app/build/outputs/**/debug/**
      - android/app/build/outputs/**/release/**
      - android/build-errors.txt
      - android/debug-build.log
      - android/release-build.log
      - android/debug-bundle.log
      - android/release-apk.log

    publishing:
      email:
        recipients:
          - justin@fluidinvestmentgroup.com
        notify:
          success: true
          failure: true
